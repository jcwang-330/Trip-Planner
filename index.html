<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KYOTO & OSAKA | Trip Planner</title>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap"
        rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        kyoto: {
                            bg: '#F7F4EF',
                            primary: '#6A7F60',
                            secondary: '#8F7762',
                            accent: '#D48666',
                            dark: '#4A4036',
                            light: '#FFFFFF'
                        }
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(106, 127, 96, 0.15)',
                        'float': '0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1)',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #F7F4EF;
            font-family: 'Noto Sans TC', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .header-curve {
            border-radius: 30px 30px 0 0;
            margin-top: -30px;
            position: relative;
            z-index: 10;
            background-color: #F7F4EF;
        }

        /* 調整大標題樣式 - 確保不換行 */
        .page-title {
            font-size: 2.5rem;
            line-height: 1;
            font-weight: 900;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.7);
            letter-spacing: 0.1em;
            /* 確保在一行內 */
            white-space: nowrap;
        }

        /* Modal 從底部彈出動畫 */
        .modal-enter-active .modal-content,
        .modal-leave-active .modal-content {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }

        .modal-enter-from .modal-content,
        .modal-leave-to .modal-content {
            transform: translateY(100%);
            opacity: 0.5;
        }

        /* 側邊欄動畫 */
        .sidebar-enter-active,
        .sidebar-leave-active {
            transition: transform 0.3s ease-out;
        }

        .sidebar-enter-from,
        .sidebar-leave-to {
            transform: translateX(100%);
        }

        /* 浮動按鈕美化與位置調整 */
        .fab-button {
            transform: translateZ(0);
            z-index: 40;
        }

        /* 5. 時間軸樣式 */
        .timeline-wrapper {
            border-left: 2px solid #8F776230;
            /* 垂直時間軸線 */
            padding-left: 1rem;
            margin-left: 10px;
            /* 預留左側空間 */
        }

        .timeline-item {
            position: relative;
            margin-bottom: 2rem;
        }

        .timeline-dot {
            position: absolute;
            left: -18px;
            /* 剛好與線條對齊 */
            top: 4px;
            width: 16px;
            height: 16px;
            background-color: #F7F4EF;
            /* 點的背景色 */
            border: 3px solid #8F7762;
            /* 點的顏色 */
            border-radius: 50%;
            z-index: 2;
        }

        .timeline-item:last-child {
            margin-bottom: 0;
            /* 最後一個項目不要額外間距 */
        }

        .timeline-item:last-child .timeline-dot {
            border-color: #6A7F60;
            /* 最後一個點變綠色 */
        }

        /* 6. 移除交通圖標，只顯示時間，線條作為分隔 */
        .traffic-divider {
            height: 100%;
            width: 100%;
            position: relative;
            z-index: 0;
            display: flex;
            justify-content: center;
            padding: 8px 0;
        }

        .traffic-line-segment {
            height: 100%;
            width: 1px;
            background-color: #8F776230;
            margin-top: 4px;
            /* 調整位置 */
        }
    </style>
</head>

<body class="text-kyoto-dark">

    <div id="app" class="relative min-h-screen pb-[80px]">

        <header class="relative w-full h-[180px] md:h-[250px] overflow-hidden bg-gray-300">
            <img :src="headerImage" class="w-full h-full object-cover transition-all duration-300" alt="Kyoto Header">

            <input type="file" @change="uploadHeader" class="absolute inset-0 opacity-0 cursor-pointer z-30"
                title="點擊更換封面">

            <div class="absolute inset-0 flex items-end p-4 z-20">
                <h1 class="page-title text-white">
                    KYOTO & OSAKA
                </h1>
            </div>
        </header>

        <main class="header-curve px-4 pt-6">

            <div v-if="currentTab === 'itinerary'">

                <div class="flex overflow-x-auto hide-scrollbar space-x-3 mb-6 pb-2">
                    <div v-for="(day, index) in tripDays" :key="index" @click="currentDayIndex = index" :class="['flex-shrink-0 w-24 h-20 rounded-2xl flex flex-col items-center justify-center cursor-pointer transition-colors',
                                  currentDayIndex === index ?
                                'bg-kyoto-secondary text-white shadow-lg' : 'bg-white text-kyoto-secondary']">
                        <span class="text-xs opacity-80">{{ `Day ${index + 1}` }}</span>
                        <span class="text-xl font-bold">{{ day.date }}</span>
                    </div>
                </div>

                <div class="timeline-wrapper pb-4">
                    <template v-for="(slotLabel, slotKey) in timeSlots" :key="slotKey">
                        <div v-if="currentDayItinerary.filter(item => item.timeSlot === slotKey).length > 0">
                            <div class="mb-3 mt-4 font-bold text-kyoto-secondary flex items-center gap-2 relative">
                                <div
                                    class="w-3 h-3 rounded-full bg-kyoto-accent absolute left-[-18px] border-4 border-kyoto-bg">
                                </div>
                                <span class="text-base">{{ slotLabel }}</span>
                            </div>

                            <template
                                v-for="(item, index) in currentDayItinerary.filter(item => item.timeSlot === slotKey)"
                                :key="item.id">
                                <div class="timeline-item group">

                                    <div class="timeline-dot"></div>

                                    <div class="bg-white rounded-2xl p-4 shadow-soft relative overflow-hidden">
                                        <div class="flex justify-between items-start mb-2">
                                            <span class="font-bold text-sm text-white px-3 py-1 rounded-full"
                                                :class="getCategoryColor(item.category)">
                                                {{ getCategoryLabel(item.category) }}
                                            </span>

                                            <span class="text-xs font-medium px-2 py-0.5 rounded-full"
                                                :class="item.location === 'osaka' ? 'bg-red-500/10 text-red-500' : 'bg-kyoto-primary/10 text-kyoto-primary'">
                                                <i class="fa-solid fa-location-dot mr-1"></i> {{ item.location ===
                                                'osaka' ? '大阪' : '京都' }}
                                            </span>

                                            <div class="flex gap-2" @click.stop>
                                                <button @click="editItem(item, index)"
                                                    class="text-gray-400 hover:text-kyoto-accent"><i
                                                        class="fa-solid fa-pen"></i></button>
                                            </div>
                                        </div>

                                        <div v-if="item.image"
                                            class="w-full h-32 bg-gray-100 rounded-lg overflow-hidden mb-3">
                                            <img :src="item.image" class="w-full h-full object-cover" alt="行程圖片">
                                        </div>

                                        <h3 class="font-bold text-xl text-kyoto-dark">{{ item.name }}</h3>

                                        <div class="text-sm text-gray-500 mt-2 space-y-1">
                                            <p v-if="item.category === 'flight'">
                                                <i class="fa-solid fa-plane-departure w-5 text-center"></i> {{
                                                item.flightTime || '時間待定' }}
                                            </p>
                                            <div v-if="item.timeSlot || item.expectedHours"
                                                class="text-kyoto-secondary">
                                                <i class="fa-regular fa-clock w-5 text-center"></i>
                                                <span v-if="item.timeSlot" class="mr-2 font-medium">{{
                                                    timeSlots[item.timeSlot] }}</span>
                                                <span v-if="item.expectedHours"> (預計 {{ item.expectedHours }} 小時)</span>
                                            </div>
                                            <p v-if="item.ticket && item.category === 'attraction'"><i
                                                    class="fa-solid fa-ticket w-5 text-center"></i> {{ item.ticket }}
                                            </p>
                                            <p v-if="item.notes" class="text-kyoto-accent mt-2 text-xs"><i
                                                    class="fa-regular fa-note-sticky w-5 text-center"></i> {{ item.notes
                                                }}</p>
                                        </div>

                                        <button v-if="item.mapLink" @click.stop="openMap(item.mapLink, item.name)"
                                            class="mt-4 w-full bg-kyoto-bg text-kyoto-primary py-2 rounded-lg text-sm font-bold active:bg-kyoto-secondary/10 transition-colors">
                                            <i class="fa-solid fa-location-arrow mr-1"></i> 導航前往
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>

                    <div v-if="currentDayItinerary.length === 0" class="text-center text-gray-400 py-10">
                        <i class="fa-solid fa-map-location-dot text-4xl mb-3"></i>
                        <p>尚無行程，點擊右下角新增</p>
                    </div>
                </div>

                <button @click="openModal()"
                    class="fixed bottom-[90px] right-6 w-14 h-14 bg-kyoto-dark text-white rounded-full shadow-float flex items-center justify-center text-2xl fab-button active:scale-95 transition-transform z-50">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <div v-if="currentTab === 'wishlist'" class="pb-4">
                <div class="flex overflow-x-auto hide-scrollbar space-x-2 mb-6">
                    <button @click="wishFilter = null" :class="['flex-shrink-0 px-4 py-1 rounded-full text-sm transition-all', wishFilter === null ?
                        'bg-kyoto-secondary text-white shadow-md' : 'bg-white text-gray-600 border border-gray-200']">
                        全部 ({{ wishList.length }})
                    </button>
                    <button v-for="(cat, key) in wishlistCategories" :key="key" @click="wishFilter = key" :class="['flex-shrink-0 px-4 py-1 rounded-full text-sm transition-all', wishFilter === key ?
                        'bg-kyoto-primary text-white shadow-md' : 'bg-white text-gray-600 border border-gray-200']">
                        {{ cat.label }} ({{ wishCategoryCounts[key] }})
                    </button>
                </div>

                <div class="space-y-4">
                    <div v-for="(wish, index) in filteredWishList" :key="wish.id"
                        class="bg-white rounded-2xl p-4 shadow-soft relative flex gap-3 items-start">
                        <div class="absolute top-0 left-0 w-1.5 h-full rounded-tl-2xl rounded-bl-2xl"
                            :class="getCategoryColor(wish.category)"></div>
                        <div class="pl-2 flex-1">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-bold text-lg text-kyoto-dark">{{ wish.name }}</h3>

                                <div class="flex items-center gap-2">
                                    <div class="text-yellow-500 text-sm flex items-center">
                                        <i v-for="n in 5" :key="n"
                                            :class="['fa-star', n <= wish.starRating ? 'fa-solid' : 'fa-regular']"
                                            class="mr-0.5"></i>
                                    </div>
                                    <button @click="editWish(wish, index)"
                                        class="text-gray-400 hover:text-kyoto-accent"><i
                                            class="fa-solid fa-pen"></i></button>
                                    <button @click="removeWish(wish.id)" class="text-gray-400 hover:text-red-500"><i
                                            class="fa-solid fa-xmark"></i></button>
                                </div>
                            </div>

                            <div class="text-sm text-gray-500 space-y-1">
                                <div class="flex flex-wrap items-center gap-2">
                                    <span class="text-xs font-medium px-2 py-0.5 rounded-full"
                                        :class="wish.location === 'osaka' ? 'bg-red-500/10 text-red-500' : 'bg-kyoto-primary/10 text-kyoto-primary'">
                                        <i class="fa-solid fa-location-dot mr-1"></i> {{ wish.location === 'osaka' ?
                                        '大阪' : '京都' }}
                                    </span>
                                    <span class="inline-block px-2 py-0.5 text-xs rounded-full text-white"
                                        :class="getCategoryColor(wish.category)">{{ getCategoryLabel(wish.category)
                                        }}</span>
                                </div>
                                <p v-if="wish.notes" class="mt-2 text-xs text-gray-600">{{ wish.notes }}</p>
                            </div>

                            <div class="flex flex-wrap gap-2 mt-3">
                                <a v-if="wish.mapLink" :href="wish.mapLink" target="_blank"
                                    class="inline-flex items-center text-sm font-medium text-kyoto-primary hover:underline bg-kyoto-bg px-2 py-1 rounded">
                                    <i class="fa-solid fa-location-arrow mr-1 text-xs"></i> 導航前往
                                </a>
                                <a v-if="wish.guideLink" :href="wish.guideLink" target="_blank"
                                    class="inline-flex items-center text-sm font-medium text-kyoto-accent hover:underline bg-kyoto-bg px-2 py-1 rounded">
                                    <i class="fa-solid fa-book-open mr-1 text-xs"></i> 攻略連結
                                </a>
                            </div>
                        </div>
                    </div>

                    <div v-if="filteredWishList.length === 0" class="text-center text-gray-400 py-10">
                        <i class="fa-solid fa-star text-4xl mb-3"></i>
                        <p>此類別暫無攻略項目</p>
                    </div>
                </div>

                <button @click="openWishModal"
                    class="fixed bottom-[90px] right-6 w-14 h-14 bg-kyoto-primary text-white rounded-full shadow-float flex items-center justify-center text-2xl fab-button z-50">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <div v-if="currentTab === 'shopping'" class="pb-4">
                <div class="space-y-4">
                    <div v-for="(item, index) in shoppingList" :key="item.id"
                        class="bg-white rounded-2xl p-4 shadow-soft relative flex gap-3 items-start">
                        <div class="absolute top-0 left-0 w-1.5 h-full rounded-tl-2xl rounded-bl-2xl"
                            :class="getShoppingCategoryColor(item.tagCategory)"></div>
                        <div v-if="item.image" class="w-20 h-20 flex-shrink-0 bg-gray-100 rounded-lg overflow-hidden">
                            <img :src="item.image" class="w-full h-full object-cover" :alt="item.itemName">
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between items-start mb-1">
                                <h3 class="font-bold text-lg text-kyoto-dark">{{ item.itemName }}</h3>
                                <div class="flex items-center gap-2">
                                    <div class="text-yellow-500 text-sm flex items-center">
                                        <i v-for="n in 5" :key="n"
                                            :class="['fa-star', n <= item.starRating ? 'fa-solid' : 'fa-regular']"
                                            class="mr-0.5"></i>
                                    </div>
                                    <button @click="openShopModal(item, index)"
                                        class="text-gray-400 hover:text-kyoto-accent"><i
                                            class="fa-solid fa-pen"></i></button>
                                    <button @click="removeShoppingItem(item.id)"
                                        class="text-gray-400 hover:text-red-500"><i
                                            class="fa-solid fa-xmark"></i></button>
                                </div>
                            </div>

                            <div class="text-sm text-gray-500 space-y-1">
                                <div class="flex flex-wrap items-center gap-2">
                                    <span class="inline-block px-2 py-0.5 text-xs rounded-full text-white"
                                        :class="getShoppingCategoryColor(item.tagCategory)">{{
                                        shopCategories[item.tagCategory]
                                        }}</span>
                                    <span class="text-xs font-medium text-gray-600">哪裡買: {{ item.whereToBuy }}</span>
                                </div>
                                <p v-if="item.notes" class="mt-2 text-xs text-gray-600"><i
                                        class="fa-regular fa-note-sticky mr-1"></i>{{ item.notes }}</p>
                            </div>

                            <div class="flex flex-wrap gap-2 mt-3">
                                <a v-if="item.mapLink" :href="item.mapLink" target="_blank"
                                    class="inline-flex items-center text-sm font-medium text-kyoto-primary hover:underline bg-kyoto-bg px-2 py-1 rounded">
                                    <i class="fa-solid fa-location-arrow mr-1 text-xs"></i> 導航前往
                                </a>
                                <a v-if="item.guideLink" :href="item.guideLink" target="_blank"
                                    class="inline-flex items-center text-sm font-medium text-kyoto-accent hover:underline bg-kyoto-bg px-2 py-1 rounded">
                                    <i class="fa-solid fa-book-open mr-1 text-xs"></i> 推薦文
                                </a>
                            </div>
                        </div>
                    </div>

                    <div v-if="shoppingList.length === 0" class="text-center text-gray-400 py-10">
                        <i class="fa-solid fa-cart-shopping text-4xl mb-3"></i>
                        <p>購物車是空的，新增想買的項目！</p>
                    </div>
                </div>

                <button @click="openShopModal()"
                    class="fixed bottom-[90px] right-6 w-14 h-14 bg-green-600 text-white rounded-full shadow-float flex items-center justify-center text-2xl fab-button z-50">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <div v-if="currentTab === 'expense'" class="pb-4 space-y-6">

                <div class="bg-kyoto-dark text-white rounded-2xl p-4 shadow-soft text-center">
                    <div class="text-sm opacity-80">總花費 (JPY)</div>
                    <div class="text-3xl font-bold mt-1">¥ {{ totalExpense.toLocaleString() }}</div>
                </div>

                <div class="space-y-3">
                    <div v-for="(exp, index) in expenses" :key="exp.id"
                        class="bg-white rounded-xl p-4 shadow-sm flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-10 h-10 rounded-full bg-kyoto-bg flex items-center justify-center text-kyoto-primary">
                                <i :class="getExpenseIcon(exp.category)"></i>
                            </div>
                            <div>
                                <div class="font-bold text-gray-800">{{ exp.name }}</div>
                                <div class="text-xs text-gray-400">{{ exp.date }} · {{ exp.method === 'cash' ?
                                    '現金' :
                                    '信用卡' }}</div>
                                <div v-if="exp.split" class="text-xs text-kyoto-secondary mt-0.5">
                                    <i class="fa-solid fa-user-group text-xs mr-1"></i>分帳: {{ exp.split }}
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button @click="openExpenseModal(exp, index)"
                                class="text-gray-400 hover:text-kyoto-accent"><i
                                    class="fa-solid fa-pen text-sm"></i></button>
                            <div class="font-bold text-kyoto-dark">¥ {{ parseInt(exp.amount).toLocaleString() }}</div>
                        </div>
                    </div>

                    <div v-if="expenses.length === 0" class="text-center text-gray-400 py-10">
                        <i class="fa-solid fa-yen-sign text-4xl mb-3"></i>
                        <p>點擊右下角新增記帳</p>
                    </div>
                </div>

                <button @click="openExpenseModal()"
                    class="fixed bottom-[90px] right-6 w-14 h-14 bg-yellow-600 text-white rounded-full shadow-float flex items-center justify-center text-2xl fab-button z-50">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <div v-if="currentTab === 'info'" class="space-y-6 pb-4">
                <section class="bg-white rounded-2xl p-5 shadow-soft">
                    <h3
                        class="text-xl font-bold text-kyoto-primary mb-4 border-b pb-2 flex justify-between items-center">
                        <i class="fa-solid fa-list-check mr-2"></i>行前 Check List
                        <button @click="infoEditMode = !infoEditMode"
                            class="text-sm text-gray-400 hover:text-kyoto-accent">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                    </h3>
                    <div class="space-y-2">
                        <div v-for="(item, index) in checklist" :key="index" class="flex items-center gap-3">
                            <input type="checkbox" v-model="item.checked" @change="saveToLocal"
                                class="form-checkbox text-kyoto-primary h-5 w-5 rounded focus:ring-0">
                            <span :class="{'line-through text-gray-400': item.checked}">{{ item.text }}</span>
                            <button v-if="infoEditMode" @click="removeChecklistItem(index)"
                                class="text-red-400 ml-auto"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                        <div v-if="infoEditMode" class="flex gap-2 pt-2">
                            <input type="text" v-model="newChecklistItem" @keyup.enter="addChecklistItem"
                                placeholder="新增項目..."
                                class="flex-1 p-2 bg-gray-50 rounded text-sm border focus:border-kyoto-primary">
                            <button @click="addChecklistItem"
                                class="bg-kyoto-primary text-white px-3 rounded text-sm">新增</button>
                        </div>
                    </div>
                </section>

                <section class="bg-white rounded-2xl p-5 shadow-soft">
                    <h3
                        class="text-lg font-bold text-kyoto-primary mb-4 border-b pb-2 flex justify-between items-center">
                        <i class="fa-solid fa-plane mr-2"></i>航班資訊
                        <button @click="openInfoEditModal('flight')"
                            class="text-sm text-gray-400 hover:text-kyoto-accent">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                    </h3>
                    <pre class="text-sm text-gray-700 whitespace-pre-wrap">{{ infoForms.flight }}</pre>
                </section>

                <section class="bg-white rounded-2xl p-5 shadow-soft">
                    <h3
                        class="text-lg font-bold text-kyoto-primary mb-4 border-b pb-2 flex justify-between items-center">
                        <i class="fa-solid fa-hotel mr-2"></i>住宿資訊
                        <button @click="openHotelModal()"
                            class="text-kyoto-primary hover:text-kyoto-accent text-sm font-bold">
                            <i class="fa-solid fa-plus mr-1"></i>新增
                        </button>
                    </h3>
                    <div v-if="hotelList.length === 0" class="text-center text-gray-400 py-5 text-sm">
                        <p>暫無住宿資訊</p>
                    </div>
                    <div v-for="(hotel, index) in hotelList" :key="index"
                        class="mb-4 pb-4 border-b last:border-b-0 last:pb-0">
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold text-kyoto-dark text-lg">{{ hotel.name }}</h4>
                            <div class="flex gap-2">
                                <button @click="openHotelModal(hotel, index)"
                                    class="text-gray-400 hover:text-kyoto-accent"><i
                                        class="fa-solid fa-pen"></i></button>
                                <button @click="deleteHotel(index)" class="text-gray-400 hover:text-red-500"><i
                                        class="fa-solid fa-trash-can"></i></button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-500 mt-1"><i class="fa-solid fa-calendar-day w-5 text-center"></i>
                            {{ hotel.period }}</p>
                        <p class="text-sm text-gray-500 mt-1"><i class="fa-solid fa-phone w-5 text-center"></i> {{
                            hotel.phone }}</p>
                        <p class="text-sm text-gray-500 mt-1"><i class="fa-solid fa-location-dot w-5 text-center"></i>
                            {{ hotel.address }}</p>
                        <a v-if="hotel.mapLink" :href="hotel.mapLink" target="_blank"
                            class="block mt-3 text-center bg-kyoto-bg text-kyoto-primary py-2 rounded-lg text-sm font-bold">導航前往</a>
                    </div>
                </section>
            </div>
        </main>

        <button @click="showExchangeSidebar = true"
            class="fixed bottom-[90px] right-20 w-14 h-14 bg-red-500 text-white rounded-full shadow-float flex items-center justify-center text-2xl fab-button active:scale-95 transition-transform z-50">
            <i class="fa-solid fa-calculator"></i>
        </button>


        <nav
            class="fixed bottom-0 left-0 w-full h-[70px] bg-white shadow-float flex justify-around items-center z-50 rounded-t-2xl">
            <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id" :class="['flex flex-col items-center justify-center p-2 transition-colors', currentTab === tab.id ?
                'text-kyoto-dark' : 'text-gray-400']">
                <i :class="tab.icon" class="text-xl"></i>
                <span class="text-xs mt-1">{{ tab.label }}</span>
            </button>
        </nav>

        <transition name="modal">
            <div v-if="showModal.itinerary" class="fixed inset-0 bg-black/50 z-50 flex items-end justify-center p-4">
                <div class="bg-white w-full max-w-md rounded-2xl p-6 modal-content">
                    <h3 class="text-xl font-bold mb-4">{{ isEditMode ? '編輯行程' : '新增行程' }}</h3>
                    <div class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                        <select v-model="form.location" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                            <option value="kyoto">地點：京都 (Kyoto)</option>
                            <option value="osaka">地點：大阪 (Osaka)</option>
                        </select>
                        <select v-model="form.category" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                            <option value="attraction">景點</option>
                            <option value="food">美食</option>
                            <option value="hotel">住宿</option>
                            <option value="flight">航班</option>
                            <option value="other">其他</option>
                        </select>
                        <input type="text" v-model="form.name" placeholder="行程名稱"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                        <textarea v-model="form.notes" placeholder="特色 & 備註 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 h-24"></textarea>

                        <div class="mt-4">
                            <label class="block text-sm text-gray-500 mb-1">時段 (必填)</label>
                            <select v-model="form.timeSlot" required
                                class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                                <option value="">請選擇時段</option>
                                <option value="morning">{{ timeSlots.morning }}</option>
                                <option value="afternoon">{{ timeSlots.afternoon }}</option>
                                <option value="evening">{{ timeSlots.evening }}</option>
                                <option value="allday">{{ timeSlots.allday }}</option>
                            </select>
                        </div>

                        <div class="mt-4">
                            <label class="block text-sm text-gray-500 mb-1">預計停留時間 (小時, 選填)</label>
                            <input type="number" v-model.number="form.expectedHours" placeholder="例如: 3.5"
                                class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                        </div>


                        <input v-if="form.category === 'flight'" type="text" v-model="form.flightTime"
                            placeholder="航班時間，例如：TPE 10:00 -> KIX 13:30"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">

                        <input type="url" v-model="form.mapLink" placeholder="Google Map 導航連結 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">

                        <input type="text" v-model="form.ticket" placeholder="門票費用 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200"
                            v-if="form.category === 'attraction'">

                        <div class="bg-kyoto-bg p-3 rounded-xl">
                            <label class="text-xs text-gray-500 mb-1 block">交通方式與時間 (距離上一站)</label>
                            <div class="flex gap-2">
                                <select v-model="form.transportType"
                                    class="p-2 rounded border border-gray-200 text-sm flex-1 min-w-0">
                                    <option value="walk">步行</option>
                                    <option value="car">汽車</option>
                                    <option value="transit">大眾運輸</option>
                                    <option value="plane">飛機</option>
                                    <option value="none">無 (起點/終點)</option>
                                </select>
                                <input type="number" v-model.number="form.travelTime" placeholder="分鐘"
                                    class="p-2 rounded border border-gray-200 text-sm w-20">
                            </div>
                        </div>

                        <div class="mt-4">
                            <label class="block text-sm text-gray-500 mb-1">上傳參考圖 (選填)</label>
                            <input type="file" @change="handleItineraryImage" accept="image/*" class="text-sm">
                            <div v-if="form.image"
                                class="h-20 w-20 bg-gray-100 rounded-xl mt-2 overflow-hidden relative">
                                <img :src="form.image" class="w-full h-full object-cover">
                                <button @click="form.image = null"
                                    class="absolute top-0 right-0 p-1 bg-black/50 text-white rounded-bl-lg text-xs">x</button>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button v-if="isEditMode" @click="deleteItem"
                            class="flex-1 bg-red-100 text-red-500 py-3 rounded-xl font-bold">刪除</button>
                        <button @click="closeModal"
                            class="flex-1 bg-gray-200 text-gray-600 py-3 rounded-xl font-bold">取消</button>
                        <button @click="saveItinerary"
                            class="flex-1 bg-kyoto-primary text-white py-3 rounded-xl font-bold">確認</button>
                    </div>
                </div>
            </div>

            <div v-if="showModal.wishlist" class="fixed inset-0 bg-black/50 z-50 flex items-end justify-center p-4">
                <div class="bg-white w-full max-w-md rounded-2xl p-6 modal-content">
                    <h3 class="text-xl font-bold mb-4">{{ isWishEditMode ? '編輯攻略項目' : '新增攻略項目' }}</h3>
                    <div class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                        <select v-model="wishForm.category"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                            <option value="attraction">分類：景點</option>
                            <option value="food">分類：美食</option>
                            <option value="shopping">分類：逛街</option>
                            <option value="other">分類：其他</option>
                        </select>
                        <select v-model="wishForm.location"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                            <option value="kyoto">地點：京都 (Kyoto)</option>
                            <option value="osaka">地點：大阪 (Osaka)</option>
                        </select>
                        <input type="text" v-model="wishForm.name" placeholder="攻略/景點/美食名稱"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">

                        <input type="url" v-model="wishForm.mapLink" placeholder="Google Map 導航連結 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">

                        <input type="url" v-model="wishForm.guideLink" placeholder="推薦/攻略文章連結 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">

                        <div>
                            <label class="block text-sm text-gray-500 mb-1">想去幾顆星 (1-5)</label>
                            <div class="flex items-center gap-2 bg-gray-50 p-3 rounded-xl border border-gray-200">
                                <i v-for="n in 5" :key="n" @click="wishForm.starRating = n"
                                    :class="['fa-star', n <= wishForm.starRating ? 'fa-solid text-yellow-500' : 'fa-regular text-gray-400']"
                                    class="cursor-pointer text-xl transition-colors"></i>
                            </div>
                        </div>

                        <textarea v-model="wishForm.notes" placeholder="特色 & 備註 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 h-24"></textarea>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button v-if="isWishEditMode" @click="deleteWishItem"
                            class="flex-1 bg-red-100 text-red-500 py-3 rounded-xl font-bold">刪除</button>
                        <button @click="showModal.wishlist = false"
                            class="flex-1 bg-gray-200 text-gray-600 py-3 rounded-xl font-bold">取消</button>
                        <button @click="saveWish"
                            class="flex-1 bg-kyoto-primary text-white py-3 rounded-xl font-bold">確認</button>
                    </div>
                </div>
            </div>

            <div v-if="showModal.shop" class="fixed inset-0 bg-black/50 z-50 flex items-end justify-center p-4">
                <div class="bg-white w-full max-w-md rounded-2xl p-6 modal-content">
                    <h3 class="text-xl font-bold mb-4">{{ isShopEditMode ? '編輯購物項目' : '新增購物項目' }}</h3>
                    <div class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                        <label class="block text-sm text-gray-500">標籤分類</label>
                        <select v-model="shopForm.tagCategory"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                            <option v-for="(label, key) in shopCategories" :value="key">{{ label }}</option>
                        </select>
                        <input type="text" v-model="shopForm.itemName" placeholder="品項名稱 (必填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                        <input type="text" v-model="shopForm.whereToBuy" placeholder="哪裡買 (必填, 例: 唐吉軻德)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">

                        <input type="url" v-model="shopForm.mapLink" placeholder="導航前往連結 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">

                        <input type="url" v-model="shopForm.guideLink" placeholder="推薦文章連結 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">

                        <div>
                            <label class="block text-sm text-gray-500 mb-1">想買幾顆星 (1-5)</label>
                            <div class="flex items-center gap-2 bg-gray-50 p-3 rounded-xl border border-gray-200">
                                <i v-for="n in 5" :key="n" @click="shopForm.starRating = n"
                                    :class="['fa-star', n <= shopForm.starRating ? 'fa-solid text-yellow-500' : 'fa-regular text-gray-400']"
                                    class="cursor-pointer text-xl transition-colors"></i>
                            </div>
                        </div>

                        <div class="mt-4">
                            <label class="block text-sm text-gray-500 mb-1">上傳參考圖 (選填)</label>
                            <input type="file" @change="handleShopImage" accept="image/*" class="text-sm">
                            <div v-if="shopForm.image"
                                class="h-20 w-20 bg-gray-100 rounded-xl mt-2 overflow-hidden relative">
                                <img :src="shopForm.image" class="w-full h-full object-cover">
                                <button @click="shopForm.image = null"
                                    class="absolute top-0 right-0 p-1 bg-black/50 text-white rounded-bl-lg text-xs">x</button>
                            </div>
                        </div>

                        <textarea v-model="shopForm.notes" placeholder="備註 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 h-24"></textarea>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button v-if="isShopEditMode" @click="deleteShopItem"
                            class="flex-1 bg-red-100 text-red-500 py-3 rounded-xl font-bold">刪除</button>
                        <button @click="showModal.shop = false"
                            class="flex-1 bg-gray-200 text-gray-600 py-3 rounded-xl font-bold">取消</button>
                        <button @click="saveShopping"
                            class="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold">確認</button>
                    </div>
                </div>
            </div>

            <div v-if="showModal.expense" class="fixed inset-0 bg-black/50 z-50 flex items-end justify-center p-4">
                <div class="bg-white w-full max-w-md rounded-2xl p-6 modal-content">
                    <h3 class="text-xl font-bold mb-4">{{ isExpenseEditMode ? '編輯記帳項目' : '新增記帳項目' }}</h3>
                    <div class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">

                        <input type="text" v-model="expenseForm.name" placeholder="花費名稱 (必填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">

                        <input type="number" v-model.number="expenseForm.amount" placeholder="金額 (JPY) (必填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">

                        <label class="block text-sm text-gray-500 pt-2">日期 (必填)</label>
                        <input type="date" v-model="expenseForm.date"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">

                        <label class="block text-sm text-gray-500 pt-2">分類</label>
                        <select v-model="expenseForm.category"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                            <option value="food">美食/餐飲</option>
                            <option value="shopping">購物/藥妝</option>
                            <option value="transport">交通</option>
                            <option value="ticket">門票/體驗</option>
                            <option value="hotel">住宿</option>
                            <option value="other">其他</option>
                        </select>

                        <label class="block text-sm text-gray-500 pt-2">支付方式</label>
                        <select v-model="expenseForm.method"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                            <option value="cash">現金 (Cash)</option>
                            <option value="card">信用卡/電子支付 (Card)</option>
                        </select>

                        <input type="text" v-model="expenseForm.split" placeholder="分帳對象/備註 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">

                        <textarea v-model="expenseForm.notes" placeholder="詳細備註 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 h-24"></textarea>

                    </div>
                    <div class="flex gap-3 mt-6">
                        <button v-if="isExpenseEditMode" @click="deleteExpenseItem"
                            class="flex-1 bg-red-100 text-red-500 py-3 rounded-xl font-bold">刪除</button>
                        <button @click="showModal.expense = false"
                            class="flex-1 bg-gray-200 text-gray-600 py-3 rounded-xl font-bold">取消</button>
                        <button @click="saveExpense"
                            class="flex-1 bg-yellow-600 text-white py-3 rounded-xl font-bold">確認儲存</button>
                    </div>
                </div>
            </div>

            <div v-if="showModal.hotel" class="fixed inset-0 bg-black/50 z-50 flex items-end justify-center p-4">
                <div class="bg-white w-full max-w-md rounded-2xl p-6 modal-content">
                    <h3 class="text-xl font-bold mb-4">{{ isHotelEditMode ? '編輯住宿資訊' : '新增住宿資訊' }}</h3>
                    <div class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                        <input type="text" v-model="hotelForm.name" placeholder="飯店/住宿名稱 (必填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                        <input type="text" v-model="hotelForm.period" placeholder="入住/退房日期 (例: 3/6 - 3/8)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                        <input type="text" v-model="hotelForm.phone" placeholder="聯絡電話 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                        <textarea v-model="hotelForm.address" placeholder="完整地址 (必填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 h-20"></textarea>
                        <input type="url" v-model="hotelForm.mapLink" placeholder="Google Map 導航連結 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button v-if="isHotelEditMode" @click="deleteHotelItem"
                            class="flex-1 bg-red-100 text-red-500 py-3 rounded-xl font-bold">刪除</button>
                        <button @click="showModal.hotel = false"
                            class="flex-1 bg-gray-200 text-gray-600 py-3 rounded-xl font-bold">取消</button>
                        <button @click="saveHotel"
                            class="flex-1 bg-kyoto-secondary text-white py-3 rounded-xl font-bold">儲存</button>
                    </div>
                </div>
            </div>

            <div v-if="showModal.infoEdit" class="fixed inset-0 bg-black/50 z-50 flex items-end justify-center p-4">
                <div class="bg-white w-full max-w-md rounded-2xl p-6 modal-content">
                    <h3 class="text-xl font-bold mb-4">編輯 {{ infoEditTargetLabel }}</h3>
                    <div class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                        <textarea v-if="infoEditTarget === 'flight'" v-model="infoForms.flight"
                            class="w-full p-3 bg-gray-50 rounded-xl border h-40"></textarea>

                        <div v-if="infoEditTarget === 'exchange'">
                            <label class="block text-sm text-gray-500 mb-1">設定匯率 (1 JPY = ? TWD)</label>
                            <input type="number" step="0.0001" v-model.number="exchange.rate"
                                class="w-full p-3 bg-gray-50 rounded-xl border" placeholder="請輸入匯率">
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button @click="showModal.infoEdit = false"
                            class="flex-1 bg-gray-200 py-3 rounded-xl">取消</button>
                        <button @click="saveInfoEdit"
                            class="flex-1 bg-kyoto-primary text-white py-3 rounded-xl">儲存</button>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="sidebar">
            <div v-if="showExchangeSidebar" class="fixed inset-0 z-50">
                <div class="absolute inset-0 bg-black/50" @click="showExchangeSidebar = false"></div>
                <div class="absolute right-0 top-0 bottom-0 w-full max-w-sm bg-kyoto-bg shadow-2xl p-6 overflow-y-auto">
                    <div class="flex justify-between items-center mb-6 border-b pb-3">
                        <h3 class="text-xl font-bold text-kyoto-dark"><i
                                class="fa-solid fa-calculator mr-2 text-red-500"></i>匯率計算機</h3>
                        <button @click="showExchangeSidebar = false"
                            class="text-gray-500 hover:text-kyoto-dark text-2xl">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div class="bg-white p-4 rounded-xl flex flex-col shadow-soft">
                            <label class="text-xs text-gray-500 mb-1">日幣 (JPY)</label>
                            <input type="number" v-model.number="exchange.jpy" @input="calculateTWDFromJPY"
                                placeholder="0"
                                class="w-full p-2 text-2xl font-bold text-kyoto-dark focus:outline-none focus:ring-0">
                        </div>

                        <div class="text-center text-kyoto-secondary font-bold text-2xl py-2">
                            <i class="fa-solid fa-arrows-down-up"></i>
                        </div>

                        <div class="bg-white p-4 rounded-xl flex flex-col shadow-soft">
                            <label class="text-xs text-gray-500 mb-1">台幣 (TWD)</label>
                            <input type="number" v-model.number="exchange.twd" @input="calculateJPYFromTWD"
                                placeholder="0"
                                class="w-full p-2 text-2xl font-bold text-kyoto-dark focus:outline-none focus:ring-0">
                        </div>

                        <div class="text-center text-sm text-gray-500 pt-2">
                            目前匯率: 1 JPY = {{ exchange.rate }} TWD
                            <button @click="openInfoEditModal('exchange')"
                                class="ml-2 text-kyoto-primary hover:underline">
                                <i class="fa-solid fa-pen text-xs"></i> 編輯
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </transition>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                // 資料狀態
                const currentTab = ref('itinerary');
                const headerImage = ref('https://images.unsplash.com/photo-1493625516999-52e896489387?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1770&q=80');

                // 行程相關 (Day 1 - Day 6: 3/6 - 3/11)
                const itineraryData = ref(loadFromLocal('itinerary', [
                    { date: '03/06', items: [] },
                    { date: '03/07', items: [] },
                    { date: '03/08', items: [] },
                    { date: '03/09', items: [] },
                    { date: '03/10', items: [] },
                    { date: '03/11', items: [] },
                ]));
                const currentDayIndex = ref(0);
                const showModal = ref({
                    itinerary: false,
                    shop: false,
                    expense: false, // 記帳 Modal
                    wishlist: false,
                    infoEdit: false,
                    hotel: false
                });
                const isEditMode = ref(false);
                const editingId = ref(null);
                const editingIndex = ref(null);

                // 行程表單 (略)
                const form = ref({
                    category: 'attraction',
                    name: '',
                    location: 'kyoto',
                    notes: '',
                    transportType: 'walk',
                    travelTime: 15,
                    mapLink: '',
                    timeSlot: 'morning',
                    expectedHours: 2,
                    flightTime: '',
                    ticket: '',
                    image: null,
                });

                // 記帳相關 (已補齊)
                const expenses = ref(loadFromLocal('expenses', []));
                const expenseForm = ref({
                    id: null,
                    name: '',
                    amount: null,
                    date: new Date().toISOString().slice(0, 10), // Default to today
                    category: 'food',
                    method: 'cash',
                    notes: '',
                    split: ''
                });
                const isExpenseEditMode = ref(false);
                const editingExpenseIndex = ref(null);


                // 許願清單相關 (已更新分類)
                const wishList = ref(loadFromLocal('wishlist', []));
                const wishForm = ref({
                    id: null,
                    name: '',
                    category: 'attraction',
                    location: 'kyoto',
                    mapLink: '',
                    guideLink: '',
                    starRating: 3,
                    notes: ''
                });
                const isWishEditMode = ref(false);
                const wishFilter = ref(null);
                const wishlistCategories = { // 移除 transport/住宿，新增 shopping/逛街
                    attraction: { label: '景點', color: 'bg-kyoto-primary' },
                    food: { label: '美食', color: 'bg-kyoto-accent' },
                    shopping: { label: '逛街', color: 'bg-green-600' },
                    other: { label: '其他', color: 'bg-gray-500' },
                };

                // 購物車相關
                const shoppingList = ref(loadFromLocal('shoppingList', []));
                const shopCategories = {
                    souvenir: '紀念品',
                    drugstore: '藥妝',
                    electronics: '電器',
                    other: '其他'
                };
                const shopForm = ref({
                    id: null,
                    tagCategory: 'souvenir', // 標籤分類
                    itemName: '', // 品項
                    whereToBuy: '', // 哪裡買
                    image: null, // 圖片上傳
                    mapLink: '', // 導航連結
                    guideLink: '', // 推薦文
                    starRating: 3, // 想買星等
                    notes: '' // 備註
                });
                const isShopEditMode = ref(false);
                const editingShopIndex = ref(null);


                // 住宿資訊 (已補齊)
                const hotelList = ref(loadFromLocal('hotelList', []));
                const hotelForm = ref({ name: '', period: '', phone: '', address: '', mapLink: '' });
                const isHotelEditMode = ref(false);
                const editingHotelIndex = ref(null);

                // 資訊區編輯 (略)
                const infoEditMode = ref(false);
                const newChecklistItem = ref('');
                const infoEditTarget = ref(null);
                const infoEditTargetLabel = ref('');
                const checklist = ref(loadFromLocal('checklist', []));
                const infoForms = ref(loadFromLocal('infoForms', { flight: '' }));


                // UI 相關設定
                const tabs = [
                    { id: 'itinerary', label: '行程', icon: 'fa-solid fa-map-location-dot' },
                    { id: 'wishlist', label: '攻略', icon: 'fa-solid fa-star' },
                    { id: 'shopping', label: '購物車', icon: 'fa-solid fa-cart-shopping' }, // New tab
                    { id: 'expense', label: '記帳', icon: 'fa-solid fa-yen-sign' },
                    { id: 'info', label: '資訊', icon: 'fa-solid fa-circle-info' },
                ];

                // 時間分類標籤 (略)
                const timeSlots = {
                    allday: '整日',
                    morning: '上午 (6:00 - 12:00)',
                    afternoon: '下午 (12:00 - 18:00)',
                    evening: '晚上 (18:00 - 24:00)',
                };

                // 匯率計算機 (略)
                const exchange = ref(loadFromLocal('exchange', { rate: 0.22, jpy: null, twd: null, }));
                const showExchangeSidebar = ref(false);

                // LocalStorage 讀取 (更新版本號)
                function loadFromLocal(key, defaultValue) {
                    try {
                        // Using V6 for the latest version
                        const data = localStorage.getItem('kyotoTripData_V6');
                        if (data) {
                            const parsed = JSON.parse(data);
                            return parsed[key] !== undefined ? parsed[key] : defaultValue;
                        }
                    } catch (e) {
                        console.error("Error loading from localStorage", e);
                    }
                    return defaultValue;
                }

                // LocalStorage 儲存 (新增 shoppingList)
                const saveToLocal = () => {
                    const data = {
                        headerImage: headerImage.value,
                        itinerary: itineraryData.value,
                        expenses: expenses.value,
                        wishlist: wishList.value,
                        shoppingList: shoppingList.value, // Added
                        infoForms: infoForms.value,
                        checklist: checklist.value,
                        exchange: { rate: exchange.value.rate },
                        hotelList: hotelList.value
                    };
                    localStorage.setItem('kyotoTripData_V6', JSON.stringify(data)); // Version 6
                };

                // Computed Properties
                const tripDays = computed(() => {
                    // 確保顯示 Day X MM/DD (已更新)
                    return itineraryData.value.map((day, index) => ({
                        ...day,
                        date: day.date,
                        dayLabel: `Day ${index + 1}`,
                    }));
                });

                const currentDayItinerary = computed(() => {
                    const items = itineraryData.value[currentDayIndex.value] ? itineraryData.value[currentDayIndex.value].items : [];
                    const order = ['allday', 'morning', 'afternoon', 'evening'];
                    return items.sort((a, b) => {
                        return order.indexOf(a.timeSlot || 'allday') - order.indexOf(b.timeSlot || 'allday');
                    });
                });
                const filteredWishList = computed(() => {
                    if (!wishFilter.value) return wishList.value;
                    return wishList.value.filter(wish => wish.category === wishFilter.value);
                });
                const wishCategoryCounts = computed(() => {
                    const counts = { all: wishList.value.length };
                    for (const key in wishlistCategories) {
                        counts[key] = wishList.value.filter(wish => wish.category === key).length;
                    }
                    return counts;
                });
                const totalExpense = computed(() => {
                    return expenses.value.reduce((sum, item) => sum + Number(item.amount), 0);
                });


                // 方法 Methods

                // 行程相關方法 (略)
                const openModal = () => {
                    isEditMode.value = false;
                    editingId.value = Date.now();
                    form.value = {
                        category: 'attraction',
                        name: '',
                        location: 'kyoto',
                        notes: '',
                        transportType: 'walk',
                        travelTime: 15,
                        mapLink: '',
                        timeSlot: 'morning',
                        expectedHours: 2,
                        flightTime: '',
                        ticket: '',
                        image: null,
                    };
                    showModal.value.itinerary = true;
                };
                const editItem = (item, index) => {
                    isEditMode.value = true;
                    editingIndex.value = index;
                    editingId.value = item.id;
                    form.value = { ...item };
                    showModal.value.itinerary = true;
                };
                const closeModal = () => { showModal.value.itinerary = false; };
                const saveItinerary = () => {
                    if (!form.value.name || !form.value.timeSlot) return alert('請填寫行程名稱和時段');

                    const newItem = { ...form.value, id: editingId.value };
                    if (isEditMode.value) {
                        itineraryData.value[currentDayIndex.value].items[editingIndex.value] = newItem;
                    } else {
                        itineraryData.value[currentDayIndex.value].items.push(newItem);
                    }
                    saveToLocal();
                    closeModal();
                };
                const deleteItem = () => {
                    if (confirm('確定刪除此行程項目？')) {
                        itineraryData.value[currentDayIndex.value].items.splice(editingIndex.value, 1);
                        saveToLocal();
                        closeModal();
                    }
                };
                const handleItineraryImage = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => form.value.image = e.target.result;
                        reader.readAsDataURL(file);
                    }
                };
                const openMap = (url, name) => {
                    if (url) {
                        window.open(url, '_blank');
                    } else {
                        alert(`「${name}」沒有提供導航連結`);
                    }
                };
                const uploadHeader = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            headerImage.value = e.target.result;
                            saveToLocal();
                        };
                        reader.readAsDataURL(file);
                    }
                };


                // 攻略相關方法 (略)
                const openWishModal = (item = null, index = null) => {
                    if (item) {
                        isWishEditMode.value = true;
                        editingId.value = item.id;
                        editingIndex.value = index;
                        wishForm.value = { ...item };
                    } else {
                        isWishEditMode.value = false;
                        editingId.value = Date.now();
                        editingIndex.value = null;
                        wishForm.value = {
                            id: Date.now(),
                            name: '',
                            category: 'attraction',
                            location: 'kyoto',
                            mapLink: '',
                            guideLink: '',
                            starRating: 3,
                            notes: ''
                        };
                    }
                    showModal.value.wishlist = true;
                };
                const editWish = (wish, index) => { openWishModal(wish, index); };
                const saveWish = () => {
                    if (!wishForm.value.name || !wishForm.value.category) return alert('請填寫攻略名稱和分類');
                    if (isWishEditMode.value) {
                        wishList.value[editingIndex.value] = { ...wishForm.value };
                    } else {
                        wishList.value.push({ ...wishForm.value });
                    }
                    saveToLocal();
                    showModal.value.wishlist = false;
                };
                const removeWish = (id) => {
                    if (confirm('確定刪除此攻略項目？')) {
                        wishList.value = wishList.value.filter(item => item.id !== id);
                        saveToLocal();
                    }
                };
                const deleteWishItem = () => {
                    if (confirm('確定刪除此攻略項目？')) {
                        wishList.value.splice(editingIndex.value, 1);
                        saveToLocal();
                        showModal.value.wishlist = false;
                    }
                };

                // 購物車相關方法 (略)
                const openShopModal = (item = null, index = null) => {
                    if (item) {
                        isShopEditMode.value = true;
                        editingShopIndex.value = index;
                        shopForm.value = {
                            id: item.id,
                            tagCategory: item.tagCategory || 'souvenir',
                            itemName: item.itemName,
                            whereToBuy: item.whereToBuy,
                            image: item.image,
                            mapLink: item.mapLink,
                            guideLink: item.guideLink,
                            starRating: item.starRating || 3,
                            notes: item.notes
                        };
                    } else {
                        isShopEditMode.value = false;
                        editingShopIndex.value = null;
                        shopForm.value = {
                            id: Date.now(),
                            tagCategory: 'souvenir',
                            itemName: '',
                            whereToBuy: '',
                            image: null,
                            mapLink: '',
                            guideLink: '',
                            starRating: 3,
                            notes: ''
                        };
                    }
                    showModal.value.shop = true;
                };
                const saveShopping = () => {
                    if (!shopForm.value.itemName || !shopForm.value.whereToBuy) return alert('請填寫品項名稱和購買地點');
                    const newItem = { ...shopForm.value };
                    if (isShopEditMode.value) {
                        shoppingList.value[editingShopIndex.value] = newItem;
                    } else {
                        shoppingList.value.push(newItem);
                    }
                    saveToLocal();
                    showModal.value.shop = false;
                };
                const handleShopImage = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => shopForm.value.image = e.target.result;
                        reader.readAsDataURL(file);
                    }
                };
                const removeShoppingItem = (id) => {
                    if (confirm('確定刪除此購物項目？')) {
                        shoppingList.value = shoppingList.value.filter(item => item.id !== id);
                        saveToLocal();
                    }
                };
                const deleteShopItem = () => {
                    if (confirm('確定刪除此購物項目？')) {
                        shoppingList.value.splice(editingShopIndex.value, 1);
                        saveToLocal();
                        showModal.value.shop = false;
                    }
                };
                const getShoppingCategoryColor = (cat) => {
                    const map = {
                        souvenir: 'bg-red-500',
                        drugstore: 'bg-blue-500',
                        electronics: 'bg-orange-500',
                        other: 'bg-gray-500'
                    };
                    return map[cat] || 'bg-gray-500';
                };


                // 記帳相關方法 (已補齊)
                const openExpenseModal = (item = null, index = null) => {
                    if (item) {
                        isExpenseEditMode.value = true;
                        editingExpenseIndex.value = index;
                        // 確保金額是數字
                        expenseForm.value = { ...item, amount: Number(item.amount) };
                    } else {
                        isExpenseEditMode.value = false;
                        editingExpenseIndex.value = null;
                        expenseForm.value = {
                            id: Date.now(),
                            name: '',
                            amount: null,
                            date: new Date().toISOString().slice(0, 10),
                            category: 'food',
                            method: 'cash',
                            notes: '',
                            split: ''
                        };
                    }
                    showModal.value.expense = true;
                };

                const saveExpense = () => {
                    if (!expenseForm.value.name || !expenseForm.value.amount || !expenseForm.value.date) {
                        return alert('請填寫花費名稱、金額和日期');
                    }
                    const newItem = { ...expenseForm.value, amount: Number(expenseForm.value.amount) };

                    if (isExpenseEditMode.value) {
                        expenses.value[editingExpenseIndex.value] = newItem;
                    } else {
                        expenses.value.push(newItem);
                    }
                    saveToLocal();
                    showModal.value.expense = false;
                };

                const editExpense = (item, index) => {
                    openExpenseModal(item, index);
                };

                const deleteExpenseItem = () => {
                    if (confirm('確定刪除此記帳項目？')) {
                        expenses.value.splice(editingExpenseIndex.value, 1);
                        saveToLocal();
                        showModal.value.expense = false;
                    }
                };


                // 住宿相關方法 (已補齊)
                const openHotelModal = (hotel = null, index = null) => {
                    if (hotel) {
                        isHotelEditMode.value = true;
                        editingHotelIndex.value = index;
                        hotelForm.value = { ...hotel };
                    } else {
                        isHotelEditMode.value = false;
                        editingHotelIndex.value = null;
                        hotelForm.value = { name: '', period: '', phone: '', address: '', mapLink: '' };
                    }
                    showModal.value.hotel = true;
                };

                const saveHotel = () => {
                    if (!hotelForm.value.name || !hotelForm.value.address) return alert('請填寫住宿名稱和地址');
                    if (isHotelEditMode.value) {
                        hotelList.value[editingHotelIndex.value] = { ...hotelForm.value };
                    } else {
                        hotelList.value.push({ ...hotelForm.value });
                    }
                    saveToLocal();
                    showModal.value.hotel = false;
                };

                const deleteHotel = (index) => {
                    if (confirm('確定刪除此住宿資訊？')) {
                        hotelList.value.splice(index, 1);
                        saveToLocal();
                    }
                };
                const deleteHotelItem = () => {
                    if (confirm('確定刪除此住宿資訊？')) {
                        hotelList.value.splice(editingHotelIndex.value, 1);
                        saveToLocal();
                        showModal.value.hotel = false;
                    }
                };



                // 資訊區編輯 (略)
                const openInfoEditModal = (target) => {
                    infoEditTarget.value = target;
                    infoEditTargetLabel.value = target === 'flight' ? '航班資訊' : '匯率設定';
                    showModal.value.infoEdit = true;
                };
                const saveInfoEdit = () => {
                    saveToLocal();
                    showModal.value.infoEdit = false;
                };
                const calculateTWDFromJPY = () => {
                    exchange.value.twd = exchange.value.jpy * exchange.value.rate;
                };
                const calculateJPYFromTWD = () => {
                    exchange.value.jpy = exchange.value.twd / exchange.value.rate;
                };
                const addChecklistItem = () => {
                    if (newChecklistItem.value.trim() !== '') {
                        checklist.value.push({ text: newChecklistItem.value, checked: false });
                        newChecklistItem.value = '';
                        saveToLocal();
                    }
                };
                const removeChecklistItem = (index) => {
                    checklist.value.splice(index, 1);
                    saveToLocal();
                };

                // Helper Functions
                const getCategoryColor = (cat) => {
                    const map = {
                        attraction: 'bg-kyoto-primary',
                        food: 'bg-kyoto-accent',
                        shopping: 'bg-green-600', // Update color for new category
                        hotel: 'bg-kyoto-secondary',
                        flight: 'bg-blue-500',
                        other: 'bg-gray-500'
                    };
                    return map[cat] || 'bg-gray-500';
                };
                const getCategoryLabel = (cat) => {
                    const map = {
                        attraction: '景點',
                        food: '美食',
                        shopping: '逛街', // New label
                        hotel: '住宿',
                        flight: '航班',
                        other: '其他'
                    };
                    return map[cat] || '其他';
                };
                const getExpenseIcon = (cat) => {
                    const map = {
                        food: 'fa-solid fa-utensils',
                        shopping: 'fa-solid fa-bag-shopping',
                        transport: 'fa-solid fa-train-subway',
                        ticket: 'fa-solid fa-ticket',
                        hotel: 'fa-solid fa-hotel',
                        other: 'fa-solid fa-money-bill'
                    };
                    return map[cat] || 'fa-solid fa-money-bill';
                };


                // Watchers
                watch(currentTab, () => {
                    // 確保點擊分頁時關閉所有 Modal
                    showModal.value = { itinerary: false, shop: false, expense: false, wishlist: false, infoEdit: false, hotel: false };
                    showExchangeSidebar.value = false;
                });
                watch(exchange.value, () => { saveToLocal(); }, { deep: true });

                // 首次載入 (略)
                onMounted(() => {
                    // Load header image if available
                    const savedData = loadFromLocal('data', {});
                    if (savedData.headerImage) {
                        headerImage.value = savedData.headerImage;
                    }
                });

                return {
                    currentTab, tabs, headerImage, uploadHeader,
                    timeSlots,
                    tripDays, currentDayIndex, currentDayItinerary,
                    itineraryData, showModal, form, isEditMode,
                    saveItinerary, deleteItem, editItem, openModal, closeModal, openMap, handleItineraryImage,
                    getCategoryColor, getCategoryLabel,
                    exchange, calculateTWDFromJPY, calculateJPYFromTWD, showExchangeSidebar,
                    expenses, totalExpense,
                    openExpenseModal, expenseForm, saveExpense, getExpenseIcon, editExpense, deleteExpenseItem, isExpenseEditMode, // 記帳相關
                    wishList, openWishModal, wishForm, saveWish, editWish, removeWish, deleteWishItem, isWishEditMode,
                    wishlistCategories, wishFilter, filteredWishList, wishCategoryCounts,
                    shoppingList, shopForm, openShopModal, saveShopping, handleShopImage, removeShoppingItem, deleteShopItem, isShopEditMode, shopCategories, getShoppingCategoryColor, // 購物車
                    infoEditMode, checklist, newChecklistItem, addChecklistItem, removeChecklistItem,
                    infoEditTarget, infoEditTargetLabel, openInfoEditModal, infoForms, saveInfoEdit,
                    hotelList, hotelForm, openHotelModal, saveHotel, deleteHotel, deleteHotelItem, isHotelEditMode, // 住宿相關
                    saveToLocal
                };
            }
        }).mount('#app');
    </script>
</body>

</html>