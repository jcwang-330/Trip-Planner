<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KYOTO & OSAKA | Trip Planner</title>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap"
        rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        kyoto: {
                            bg: '#F7F4EF',
                            primary: '#6A7F60',
                            secondary: '#8F7762',
                            accent: '#D48666',
                            dark: '#4A4036',
                            light: '#FFFFFF'
                        }
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(106, 127, 96, 0.15)',
                        'float': '0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1)',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #F7F4EF;
            font-family: 'Noto Sans TC', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .header-curve {
            border-radius: 30px 30px 0 0;
            margin-top: -30px;
            position: relative;
            z-index: 10;
            background-color: #F7F4EF;
        }

        /* Modal 從底部彈出動畫 */
        .modal-enter-active .modal-content,
        .modal-leave-active .modal-content {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }

        .modal-enter-from .modal-content,
        .modal-leave-to .modal-content {
            transform: translateY(100%);
            opacity: 0.5;
        }

        /* 側邊欄動畫 */
        .sidebar-enter-active,
        .sidebar-leave-active {
            transition: transform 0.3s ease-out;
        }

        .sidebar-enter-from,
        .sidebar-leave-to {
            transform: translateX(100%);
        }

        /* 浮動按鈕美化與位置調整 */
        .fab-button {
            transform: translateZ(0);
            z-index: 40;
        }

        /* 時間軸樣式 */
        .timeline-wrapper {
            border-left: 2px solid #8F776230;
            /* 垂直時間軸線 */
            padding-left: 1rem;
            margin-left: 10px;
            /* 預留左側空間 */
        }

        .timeline-item {
            position: relative;
            margin-bottom: 2rem;
        }

        .timeline-dot {
            position: absolute;
            left: -18px;
            /* 剛好與線條對齊 */
            top: 4px;
            width: 16px;
            height: 16px;
            background-color: #F7F4EF;
            /* 點的背景色 */
            border: 3px solid #8F7762;
            /* 點的顏色 */
            border-radius: 50%;
            z-index: 2;
        }

        .timeline-item:last-child {
            margin-bottom: 0;
            /* 最後一個項目不要額外間距 */
        }

        .timeline-item:last-child .timeline-dot {
            border-color: #6A7F60;
            /* 最後一個點變綠色 */
        }

        /* 移除交通圖標，只顯示時間，線條作為分隔 */
        .traffic-divider {
            height: 100%;
            width: 100%;
            position: relative;
            z-index: 0;
            display: flex;
            justify-content: center;
            padding: 8px 0;
        }

        .traffic-line-segment {
            height: 100%;
            width: 1px;
            background-color: #8F776230;
            margin-top: 4px;
            /* 調整位置 */
        }
    </style>
</head>

<body class="text-kyoto-dark">

    <div id="app" class="relative min-h-screen pb-[80px]">

        <header class="relative w-full h-[180px] md:h-[250px] overflow-hidden bg-gray-300">
            <img :src="headerImage" class="w-full h-full object-cover transition-all duration-300" alt="Kyoto Header">

            <input type="file" @change="uploadHeader" class="absolute inset-0 opacity-0 cursor-pointer z-30"
                title="點擊更換封面">

        </header>

        <main class="header-curve px-4 pt-6">

            <div v-if="currentTab === 'itinerary'">

                <div class="flex overflow-x-auto hide-scrollbar space-x-3 mb-6 pb-2">
                    <div v-for="(day, index) in tripDays" :key="index" @click="currentDayIndex = index" :class="['flex-shrink-0 w-24 h-20 rounded-2xl flex flex-col items-center justify-center cursor-pointer transition-colors',
                            currentDayIndex === index ?
                            'bg-kyoto-secondary text-white shadow-lg' : 'bg-white text-kyoto-secondary']">
                        <span class="text-xs opacity-80">{{ `Day ${index + 1}` }}</span>
                        <span class="text-xl font-bold">{{ day.date }}</span>
                    </div>
                </div>

                <div class="timeline-wrapper pb-4">
                    <template v-for="(slotLabel, slotKey) in timeSlots" :key="slotKey">
                        <div v-if="currentDayItinerary.filter(item => item.timeSlot === slotKey).length > 0">
                            <div class="mb-3 mt-4 font-bold text-kyoto-secondary flex items-center gap-2 relative">
                                <div
                                    class="w-3 h-3 rounded-full bg-kyoto-accent absolute left-[-18px] border-4 border-kyoto-bg">
                                </div>
                                <span class="text-base">{{ slotLabel }}</span>
                            </div>

                            <template
                                v-for="(item, index) in currentDayItinerary.filter(item => item.timeSlot === slotKey)"
                                :key="item.id">
                                <div class="timeline-item group">

                                    <div class="timeline-dot"></div>

                                    <div class="bg-white rounded-2xl p-4 shadow-soft relative overflow-hidden">

                                        <div class="flex justify-between items-start mb-2">
                                            <div class="flex gap-2 items-center">
                                                <span class="font-bold text-sm text-white px-3 py-1 rounded-full"
                                                    :class="getCategoryColor(item.category)">
                                                    {{ getCategoryLabel(item.category) }}
                                                </span>

                                                <span class="text-xs font-medium px-2 py-0.5 rounded-full"
                                                    :class="item.location === 'osaka' ?
                                                    'bg-red-500/10 text-red-500' : 'bg-kyoto-primary/10 text-kyoto-primary'">
                                                    <i class="fa-solid fa-location-dot mr-1"></i> {{ item.location ===
                                                    'osaka' ? '大阪' : '京都' }}
                                                </span>
                                            </div>

                                            <div class="flex gap-2" @click.stop>
                                                <button @click="editItem(item, index)"
                                                    class="text-gray-400 hover:text-kyoto-accent"><i
                                                        class="fa-solid fa-pen"></i></button>
                                                <button @click="deleteItem(item.id)"
                                                    class="text-gray-400 hover:text-red-500"><i
                                                        class="fa-solid fa-xmark"></i></button>
                                            </div>
                                        </div>

                                        <div v-if="item.image"
                                            class="w-full h-32 bg-gray-100 rounded-lg overflow-hidden mb-3">
                                            <img :src="item.image" class="w-full h-full object-cover" alt="行程圖片">
                                        </div>

                                        <h3 class="font-bold text-xl text-kyoto-dark">{{ item.name }}</h3>

                                        <div class="text-sm text-gray-500 mt-2 space-y-1">
                                            <p v-if="item.category === 'flight'">
                                                <i class="fa-solid fa-plane-departure w-5 text-center"></i> {{
                                                item.flightTime || '時間待定' }}
                                            </p>
                                            <div v-if="item.timeSlot || item.expectedHours"
                                                class="text-kyoto-secondary">
                                                <i class="fa-regular fa-clock w-5 text-center"></i>
                                                <span v-if="item.timeSlot" class="mr-2 font-medium">{{
                                                    timeSlots[item.timeSlot] }}</span>
                                                <span v-if="item.expectedHours"> (預計 {{ item.expectedHours }} 小時)</span>
                                            </div>
                                            <p v-if="item.ticket && item.category === 'attraction'"><i
                                                    class="fa-solid fa-ticket w-5 text-center"></i> {{ item.ticket }}
                                            </p>
                                            <p v-if="item.notes" class="text-kyoto-accent mt-2 text-xs"><i
                                                    class="fa-regular fa-note-sticky w-5 text-center"></i> {{ item.notes
                                                }}</p>
                                        </div>

                                        <button v-if="item.mapLink" @click.stop="openMap(item.mapLink, item.name)"
                                            class="mt-4 w-full bg-kyoto-bg text-kyoto-primary py-2 rounded-lg text-sm font-bold active:bg-kyoto-secondary/10 transition-colors">
                                            <i class="fa-solid fa-location-arrow mr-1"></i> 導航前往
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>

                    <div v-if="currentDayItinerary.length === 0" class="text-center text-gray-400 py-10">
                        <i class="fa-solid fa-map-location-dot text-4xl mb-3"></i>
                        <p>尚無行程，點擊右下角新增</p>
                    </div>
                </div>

                <button @click="openModal()"
                    class="fixed bottom-[90px] right-6 w-14 h-14 bg-kyoto-dark text-white rounded-full shadow-float flex items-center justify-center text-2xl fab-button active:scale-95 transition-transform z-50">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <div v-if="currentTab === 'wishlist'" class="pb-4">
                <div class="flex overflow-x-auto hide-scrollbar space-x-2 mb-6">
                    <button @click="wishFilter = null" :class="['flex-shrink-0 px-4 py-1 rounded-full text-sm transition-all', wishFilter === null ?
                        'bg-kyoto-secondary text-white shadow-md' : 'bg-white text-gray-600 border border-gray-200']">
                        全部 ({{ wishList.length }})
                    </button>
                    <button v-for="(cat, key) in wishlistCategories" :key="key" @click="wishFilter = key" :class="['flex-shrink-0 px-4 py-1 rounded-full text-sm transition-all', wishFilter === key ?
                        'bg-kyoto-primary text-white shadow-md' : 'bg-white text-gray-600 border border-gray-200']">
                        {{ cat.label }} ({{ wishCategoryCounts[key] }})
                    </button>
                </div>

                <div class="space-y-4">
                    <div v-for="(wish, index) in filteredWishList" :key="wish.id"
                        class="bg-white rounded-2xl p-4 shadow-soft relative flex gap-3 items-start">
                        <div class="absolute top-0 left-0 w-1.5 h-full rounded-tl-2xl rounded-bl-2xl"
                            :class="getCategoryColor(wish.category)"></div>
                        <div class="pl-2 flex-1">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-bold text-lg text-kyoto-dark">{{ wish.name }}</h3>

                                <div class="flex items-center gap-2">
                                    <div class="text-yellow-500 text-sm flex items-center">
                                        <i v-for="n in 5" :key="n"
                                            :class="['fa-star', n <= wish.starRating ? 'fa-solid' : 'fa-regular']"
                                            class="mr-0.5"></i>
                                    </div>
                                    <button @click="editWish(wish, index)"
                                        class="text-gray-400 hover:text-kyoto-accent"><i
                                            class="fa-solid fa-pen"></i></button>
                                    <button @click="removeWish(wish.id)" class="text-gray-400 hover:text-red-500"><i
                                            class="fa-solid fa-xmark"></i></button>
                                </div>
                            </div>

                            <div class="text-sm text-gray-500 space-y-1">
                                <div class="flex flex-wrap items-center gap-2">
                                    <span class="text-xs font-medium px-2 py-0.5 rounded-full"
                                        :class="wish.location === 'osaka' ? 'bg-red-500/10 text-red-500' : 'bg-kyoto-primary/10 text-kyoto-primary'">
                                        <i class="fa-solid fa-location-dot mr-1"></i> {{ wish.location === 'osaka' ?
                                        '大阪' : '京都' }}
                                    </span>
                                    <span class="inline-block px-2 py-0.5 text-xs rounded-full text-white"
                                        :class="getCategoryColor(wish.category)">{{ getCategoryLabel(wish.category)
                                        }}</span>
                                </div>
                                <p v-if="wish.notes" class="mt-2 text-xs text-gray-600">{{ wish.notes }}</p>
                            </div>

                            <div class="flex flex-wrap gap-2 mt-3">
                                <a v-if="wish.mapLink" :href="wish.mapLink" target="_blank"
                                    class="inline-flex items-center text-sm font-medium text-kyoto-primary hover:underline bg-kyoto-bg px-2 py-1 rounded">
                                    <i class="fa-solid fa-location-arrow mr-1 text-xs"></i> 導航前往
                                </a>
                                <a v-if="wish.guideLink" :href="wish.guideLink" target="_blank"
                                    class="inline-flex items-center text-sm font-medium text-kyoto-accent hover:underline bg-kyoto-bg px-2 py-1 rounded">
                                    <i class="fa-solid fa-book-open mr-1 text-xs"></i> 攻略連結
                                </a>
                            </div>
                        </div>
                    </div>

                    <div v-if="filteredWishList.length === 0" class="text-center text-gray-400 py-10">
                        <i class="fa-solid fa-star text-4xl mb-3"></i>
                        <p>此類別暫無攻略項目</p>
                    </div>
                </div>

                <button @click="openWishModal()"
                    class="fixed bottom-[90px] right-6 w-14 h-14 bg-kyoto-primary text-white rounded-full shadow-float flex items-center justify-center text-2xl fab-button z-50">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <div v-if="currentTab === 'shopping'" class="pb-4">
                <div class="space-y-4">
                    <div v-for="(item, index) in shoppingList" :key="item.id"
                        class="bg-white rounded-2xl p-4 shadow-soft relative flex gap-3 items-start">
                        <div class="absolute top-0 left-0 w-1.5 h-full rounded-tl-2xl rounded-bl-2xl"
                            :class="getShoppingCategoryColor(item.tagCategory)"></div>
                        <div v-if="item.image" class="w-20 h-20 flex-shrink-0 bg-gray-100 rounded-lg overflow-hidden">
                            <img :src="item.image" class="w-full h-full object-cover" :alt="item.itemName">
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between items-start mb-1">
                                <h3 class="font-bold text-lg text-kyoto-dark">{{ item.itemName }}</h3>
                                <div class="flex items-center gap-2">
                                    <div class="text-yellow-500 text-sm flex items-center">
                                        <i v-for="n in 5" :key="n"
                                            :class="['fa-star', n <= item.starRating ? 'fa-solid' : 'fa-regular']"
                                            class="mr-0.5"></i>
                                    </div>
                                    <button @click="openShopModal(item, index)"
                                        class="text-gray-400 hover:text-kyoto-accent"><i
                                            class="fa-solid fa-pen"></i></button>
                                    <button @click="removeShoppingItem(item.id)"
                                        class="text-gray-400 hover:text-red-500"><i
                                            class="fa-solid fa-xmark"></i></button>
                                </div>
                            </div>
                            <div class="text-sm text-gray-500 space-y-1">
                                <div class="flex flex-wrap items-center gap-2">
                                    <span class="inline-block px-2 py-0.5 text-xs rounded-full text-white"
                                        :class="getShoppingCategoryColor(item.tagCategory)">{{
                                        shopCategories[item.tagCategory] }}</span>
                                    <span class="text-xs font-medium text-gray-600">哪裡買: {{ item.whereToBuy }}</span>
                                </div>
                                <p v-if="item.notes" class="mt-2 text-xs text-gray-600"><i
                                        class="fa-regular fa-note-sticky mr-1"></i>{{ item.notes }}</p>
                            </div>
                            <div class="flex flex-wrap gap-2 mt-3">
                                <a v-if="item.mapLink" :href="item.mapLink" target="_blank"
                                    class="inline-flex items-center text-sm font-medium text-kyoto-primary hover:underline bg-kyoto-bg px-2 py-1 rounded">
                                    <i class="fa-solid fa-location-arrow mr-1 text-xs"></i> 導航前往
                                </a>
                                <a v-if="item.guideLink" :href="item.guideLink" target="_blank"
                                    class="inline-flex items-center text-sm font-medium text-kyoto-accent hover:underline bg-kyoto-bg px-2 py-1 rounded">
                                    <i class="fa-solid fa-book-open mr-1 text-xs"></i> 推薦文連結
                                </a>
                            </div>
                        </div>
                    </div>
                    <div v-if="shoppingList.length === 0" class="text-center text-gray-400 py-10">
                        <i class="fa-solid fa-bag-shopping text-4xl mb-3"></i>
                        <p>尚無購物清單項目，點擊右下角新增</p>
                    </div>
                </div>

                <button @click="openShopModal()"
                    class="fixed bottom-[90px] right-6 w-14 h-14 bg-kyoto-dark text-white rounded-full shadow-float flex items-center justify-center text-2xl fab-button active:scale-95 transition-transform z-50">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <div v-if="currentTab === 'expense'" class="pb-4">
                <div
                    class="bg-kyoto-secondary text-white rounded-2xl p-4 shadow-lg mb-6 flex justify-between items-center">
                    <div>
                        <span class="text-sm opacity-80">總花費 (JPY)</span>
                        <p class="text-3xl font-bold mt-1">¥ {{ totalExpense.toLocaleString() }}</p>
                    </div>
                    <button @click="showExchangeSidebar = true"
                        class="bg-kyoto-primary text-white px-3 py-1.5 rounded-full text-sm font-medium active:bg-kyoto-primary/80 transition-colors">
                        <i class="fa-solid fa-right-left mr-1"></i> 換算
                    </button>
                </div>

                <div class="space-y-4">
                    <div v-for="(item, index) in expenses" :key="item.id"
                        class="bg-white rounded-2xl p-4 shadow-soft relative flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-10 h-10 rounded-full bg-kyoto-bg flex items-center justify-center text-kyoto-primary text-lg">
                                <i :class="getExpenseIcon(item.category)"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg text-kyoto-dark">{{ item.name }}</h3>
                                <p class="text-xs text-gray-500">
                                    {{ item.date }} · {{ item.category === 'other' ? '其他' :
                                    (item.category === 'food' ? '餐飲' :
                                    (item.category === 'shopping' ? '購物' :
                                    (item.category === 'transport' ? '交通' :
                                    (item.category === 'ticket' ? '門票' : '住宿'))))
                                    }}
                                </p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-lg text-red-500">- ¥ {{ Number(item.amount).toLocaleString() }}</p>
                            <div class="flex gap-2 text-sm text-gray-500">
                                <span class="text-xs">{{ item.method === 'cash' ? '現金' : '信用卡' }}</span>
                                <button @click="editExpense(item, index)"
                                    class="text-gray-400 hover:text-kyoto-accent"><i
                                        class="fa-solid fa-pen"></i></button>
                            </div>
                        </div>
                    </div>
                    <div v-if="expenses.length === 0" class="text-center text-gray-400 py-10">
                        <i class="fa-solid fa-money-bill-transfer text-4xl mb-3"></i>
                        <p>尚無記帳項目，點擊右下角新增</p>
                    </div>
                </div>

                <button @click="openExpenseModal()"
                    class="fixed bottom-[90px] right-6 w-14 h-14 bg-kyoto-dark text-white rounded-full shadow-float flex items-center justify-center text-2xl fab-button active:scale-95 transition-transform z-50">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <div v-if="currentTab === 'info'" class="pb-20 space-y-4">

                <section class="bg-white rounded-2xl p-5 shadow-soft">
                    <h3
                        class="text-lg font-bold text-kyoto-primary mb-4 border-b pb-2 flex justify-between items-center">
                        <i class="fa-solid fa-list-check mr-2"></i>行前清單
                    </h3>
                    <div class="space-y-3">
                        <div v-for="(item, index) in checklist" :key="index" class="flex items-center gap-2 text-sm">
                            <input type="checkbox" v-model="item.checked" @change="saveToLocal"
                                class="form-checkbox text-kyoto-primary h-5 w-5 rounded focus:ring-0">
                            <span :class="{'line-through text-gray-400': item.checked}">{{ item.text }}</span>
                            <button v-if="infoEditMode" @click="removeChecklistItem(index)"
                                class="text-red-400 ml-auto"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                    </div>
                    <div v-if="infoEditMode" class="flex gap-2 pt-4 border-t mt-4">
                        <input type="text" v-model="newChecklistItem" @keyup.enter="addChecklistItem"
                            placeholder="新增項目..."
                            class="flex-1 p-2 bg-gray-50 rounded text-sm border focus:border-kyoto-primary">
                        <button @click="addChecklistItem"
                            class="bg-kyoto-primary text-white px-3 rounded text-sm">新增</button>
                    </div>
                </section>

                <section class="bg-white rounded-2xl p-5 shadow-soft">
                    <h3
                        class="text-lg font-bold text-kyoto-primary mb-4 border-b pb-2 flex justify-between items-center">
                        <i class="fa-solid fa-plane mr-2"></i>航班資訊
                        <button @click="openInfoEditModal('flight')"
                            class="text-sm text-gray-400 hover:text-kyoto-accent">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                    </h3>
                    <pre class="text-sm text-gray-700 whitespace-pre-wrap">{{ infoForms.flight }}</pre>
                </section>

                <section class="bg-white rounded-2xl p-5 shadow-soft">
                    <h3
                        class="text-lg font-bold text-kyoto-primary mb-4 border-b pb-2 flex justify-between items-center">
                        <i class="fa-solid fa-bus-simple mr-2"></i>交通資料
                        <button @click="openInfoEditModal('transport')"
                            class="text-sm text-gray-400 hover:text-kyoto-accent">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                    </h3>
                    <pre class="text-sm text-gray-700 whitespace-pre-wrap">{{ infoForms.transport }}</pre>
                </section>


                <section class="bg-white rounded-2xl p-5 shadow-soft">
                    <h3
                        class="text-lg font-bold text-kyoto-primary mb-4 border-b pb-2 flex justify-between items-center">
                        <i class="fa-solid fa-hotel mr-2"></i>住宿資訊
                        <button @click="openHotelModal()"
                            class="text-kyoto-primary hover:text-kyoto-accent text-sm font-bold">
                            <i class="fa-solid fa-plus mr-1"></i>新增
                        </button>
                    </h3>
                    <div class="space-y-3">
                        <div v-for="(hotel, index) in hotelList" :key="index"
                            class="p-3 border rounded-xl bg-kyoto-bg/50">
                            <div class="flex justify-between items-start">
                                <h4 class="font-bold text-base text-kyoto-dark">{{ hotel.name }}</h4>
                                <div class="flex gap-2">
                                    <button @click="openHotelModal(hotel, index)"
                                        class="text-gray-400 hover:text-kyoto-accent text-sm"><i
                                            class="fa-solid fa-pen"></i></button>
                                    <button @click="deleteHotel(hotel.name)"
                                        class="text-red-400 hover:text-red-500 text-sm"><i
                                            class="fa-solid fa-xmark"></i></button>
                                </div>
                            </div>
                            <p class="text-sm text-gray-700 mt-1">入住期間: {{ hotel.period }}</p>
                            <p class="text-sm text-gray-700">電話: {{ hotel.phone }}</p>
                            <p class="text-sm text-gray-700">地址: {{ hotel.address }}</p>
                            <a v-if="hotel.mapLink" :href="hotel.mapLink" target="_blank"
                                class="text-sm text-kyoto-accent hover:underline inline-block mt-2">
                                <i class="fa-solid fa-location-arrow mr-1 text-xs"></i> 導航連結
                            </a>
                        </div>
                        <div v-if="hotelList.length === 0" class="text-center text-gray-400 py-4 text-sm">
                            <p>尚無住宿資訊</p>
                        </div>
                    </div>
                </section>

                <button v-if="currentTab === 'info'" @click="toggleInfoEditMode"
                    :class="['fixed bottom-[90px] right-6 w-14 h-14 rounded-full shadow-float flex items-center justify-center text-2xl fab-button active:scale-95 transition-transform z-50', infoEditMode ? 'bg-red-500 text-white' : 'bg-kyoto-primary text-white']">
                    <i class="fa-solid" :class="infoEditMode ? 'fa-check' : 'fa-pen-to-square'"></i>
                </button>
            </div>

            <nav
                class="fixed bottom-0 left-0 right-0 h-[70px] bg-white border-t border-gray-200 shadow-lg z-30 flex justify-around items-center">
                <button @click="currentTab = 'itinerary'" :class="['flex flex-col items-center p-2 transition-colors',
                    currentTab === 'itinerary' ? 'text-kyoto-primary' : 'text-gray-400 hover:text-gray-600']">
                    <i class="fa-solid fa-route text-xl"></i>
                    <span class="text-xs mt-1">行程</span>
                </button>
                <button @click="currentTab = 'wishlist'" :class="['flex flex-col items-center p-2 transition-colors',
                    currentTab === 'wishlist' ? 'text-kyoto-primary' : 'text-gray-400 hover:text-gray-600']">
                    <i class="fa-solid fa-list-check text-xl"></i>
                    <span class="text-xs mt-1">攻略</span>
                </button>
                <button @click="currentTab = 'shopping'" :class="['flex flex-col items-center p-2 transition-colors',
                    currentTab === 'shopping' ? 'text-kyoto-primary' : 'text-gray-400 hover:text-gray-600']">
                    <i class="fa-solid fa-bag-shopping text-xl"></i>
                    <span class="text-xs mt-1">購物</span>
                </button>
                <button @click="currentTab = 'expense'" :class="['flex flex-col items-center p-2 transition-colors',
                    currentTab === 'expense' ? 'text-kyoto-primary' : 'text-gray-400 hover:text-gray-600']">
                    <i class="fa-solid fa-yen-sign text-xl"></i>
                    <span class="text-xs mt-1">記帳</span>
                </button>
                <button @click="currentTab = 'info'" :class="['flex flex-col items-center p-2 transition-colors',
                    currentTab === 'info' ? 'text-kyoto-primary' : 'text-gray-400 hover:text-gray-600']">
                    <i class="fa-solid fa-info-circle text-xl"></i>
                    <span class="text-xs mt-1">資訊</span>
                </button>
            </nav>

        </main>

        <transition name="modal">
            <div v-if="showModal.itinerary" class="fixed inset-0 bg-black/50 z-50 flex items-end justify-center p-4"
                @click.self="closeModal">
                <div class="bg-white w-full max-w-md rounded-2xl p-6 modal-content">
                    <h3 class="text-xl font-bold mb-4">{{ isEditMode ? '編輯行程' : '新增行程' }}</h3>
                    <div class="space-y-3 max-h-[70vh] overflow-y-auto pr-2">
                        <div v-if="!isEditMode">
                            <label class="block text-sm text-gray-500 mb-1">選擇日期 (必填)</label>
                            <select v-model="form.date" required
                                class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                                <option value="">請選擇日期</option>
                                <option v-for="day in tripDays" :value="day.fullDate" :key="day.fullDate">{{ day.date }}
                                    ({{ day.fullDate }})</option>
                            </select>
                        </div>

                        <label class="block text-sm text-gray-500 mb-1">類別 (必填)</label>
                        <select v-model="form.category" required
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                            <option v-for="(cat, key) in itineraryCategories" :value="key" :key="key">{{ cat.label }}
                            </option>
                        </select>

                        <label class="block text-sm text-gray-500 mb-1">地點 (必填)</label>
                        <select v-model="form.location" required
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                            <option value="kyoto">京都</option>
                            <option value="osaka">大阪</option>
                        </select>

                        <input type="text" v-model="form.name" placeholder="行程/地點名稱 (必填)" required
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">

                        <div>
                            <label class="block text-sm text-gray-500 mb-1">圖片 (選填)</label>
                            <input type="file" @change="handleItineraryImage" accept="image/*"
                                class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                            <img v-if="form.image" :src="form.image" class="w-20 h-20 object-cover rounded-lg mt-2" />
                        </div>

                        <textarea v-model="form.notes" placeholder="特色 & 備註 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 h-24"></textarea>

                        <div class="mt-4">
                            <label class="block text-sm text-gray-500 mb-1">時段 (必填)</label>
                            <select v-model="form.timeSlot" required
                                class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                                <option value="">請選擇時段</option>
                                <option value="morning">{{ timeSlots.morning }}</option>
                                <option value="afternoon">{{ timeSlots.afternoon }}</option>
                                <option value="evening">{{ timeSlots.evening }}</option>
                                <option value="allday">{{ timeSlots.allday }}</option>
                            </select>
                        </div>

                        <div class="mt-4">
                            <label class="block text-sm text-gray-500 mb-1">預計停留時間 (小時, 選填)</label>
                            <input type="number" v-model.number="form.expectedHours" placeholder="例如: 3.5"
                                class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                        </div>

                        <input v-if="form.category === 'flight'" type="text" v-model="form.flightTime"
                            placeholder="航班時間，例如：TPE 10:00 -> KIX 13:30"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">

                        <input type="text" v-model="form.ticket" placeholder="門票費用 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200"
                            v-if="form.category === 'attraction'">

                        <input type="url" v-model="form.mapLink" placeholder="Google Map 導航連結 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                    </div>

                    <div class="flex gap-3 mt-6">
                        <button v-if="isEditMode" @click="deleteItem(form.id)"
                            class="flex-1 bg-red-100 text-red-500 py-3 rounded-xl font-bold">刪除</button>
                        <button @click="closeModal"
                            class="flex-1 bg-gray-200 text-gray-600 py-3 rounded-xl font-bold">取消</button>
                        <button @click="saveItinerary"
                            class="flex-1 bg-kyoto-primary text-white py-3 rounded-xl font-bold">確認</button>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="modal">
            <div v-if="showModal.wishlist" class="fixed inset-0 bg-black/50 z-50 flex items-end justify-center p-4"
                @click.self="showModal.wishlist = false">
                <div class="bg-white w-full max-w-md rounded-2xl p-6 modal-content">
                    <h3 class="text-xl font-bold mb-4">{{ isWishEditMode ? '編輯攻略項目' : '新增攻略項目' }}</h3>
                    <div class="space-y-3 max-h-[70vh] overflow-y-auto pr-2">
                        <label class="block text-sm text-gray-500 mb-1">類別 (必填)</label>
                        <select v-model="wishForm.category" required
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                            <option v-for="(cat, key) in wishlistCategories" :value="key" :key="key">{{ cat.label }}
                            </option>
                        </select>
                        <label class="block text-sm text-gray-500 mb-1">地點 (必填)</label>
                        <select v-model="wishForm.location" required
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                            <option value="kyoto">京都</option>
                            <option value="osaka">大阪</option>
                        </select>
                        <input type="text" v-model="wishForm.name" placeholder="攻略/地點名稱 (必填)" required
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                        <input type="url" v-model="wishForm.guideLink" placeholder="推薦文/攻略連結 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                        <input type="url" v-model="wishForm.mapLink" placeholder="Google Map 導航連結 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                        <div class="mt-4">
                            <label class="block text-sm text-gray-500 mb-2">想去程度 (必填)</label>
                            <div class="flex gap-1">
                                <i v-for="n in 5" :key="n" @click="wishForm.starRating = n"
                                    :class="[n <= wishForm.starRating ? 'fa-solid text-yellow-500' : 'fa-regular text-gray-400']"
                                    class="cursor-pointer text-xl transition-colors"></i>
                            </div>
                        </div>
                        <textarea v-model="wishForm.notes" placeholder="特色 & 備註 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 h-24"></textarea>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button v-if="isWishEditMode" @click="deleteWishItem"
                            class="flex-1 bg-red-100 text-red-500 py-3 rounded-xl font-bold">刪除</button>
                        <button @click="showModal.wishlist = false"
                            class="flex-1 bg-gray-200 text-gray-600 py-3 rounded-xl font-bold">取消</button>
                        <button @click="saveWish"
                            class="flex-1 bg-kyoto-primary text-white py-3 rounded-xl font-bold">確認</button>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="modal">
            <div v-if="showModal.shop" class="fixed inset-0 bg-black/50 z-50 flex items-end justify-center p-4"
                @click.self="showModal.shop = false">
                <div class="bg-white w-full max-w-md rounded-2xl p-6 modal-content">
                    <h3 class="text-xl font-bold mb-4">{{ isShopEditMode ? '編輯購物項目' : '新增購物項目' }}</h3>
                    <div class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                        <label class="block text-sm text-gray-500">標籤分類</label>
                        <select v-model="shopForm.tagCategory"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                            <option v-for="(label, key) in shopCategories" :value="key" :key="key">{{ label }}</option>
                        </select>
                        <input type="text" v-model="shopForm.itemName" placeholder="品項名稱 (必填)" required
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                        <input type="text" v-model="shopForm.whereToBuy" placeholder="哪裡買 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                        <div>
                            <label class="block text-sm text-gray-500 mb-1">圖片 (選填)</label>
                            <input type="file" @change="handleShopImage" accept="image/*"
                                class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                            <img v-if="shopForm.image" :src="shopForm.image"
                                class="w-20 h-20 object-cover rounded-lg mt-2" />
                        </div>
                        <div class="pt-2">
                            <label class="block text-sm text-gray-500 mb-2">想買程度 (必填)</label>
                            <div class="flex gap-1">
                                <i v-for="n in 5" :key="n" @click="shopForm.starRating = n"
                                    :class="[n <= shopForm.starRating ? 'fa-solid text-yellow-500' : 'fa-regular text-gray-400']"
                                    class="cursor-pointer text-xl transition-colors"></i>
                            </div>
                        </div>
                        <input type="url" v-model="shopForm.guideLink" placeholder="推薦文連結 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                        <input type="url" v-model="shopForm.mapLink" placeholder="導航連結 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                        <textarea v-model="shopForm.notes" placeholder="詳細備註 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 h-24"></textarea>
                    </div>

                    <div class="flex gap-3 mt-6">
                        <button v-if="isShopEditMode" @click="deleteShopItem"
                            class="flex-1 bg-red-100 text-red-500 py-3 rounded-xl font-bold">刪除</button>
                        <button @click="showModal.shop = false"
                            class="flex-1 bg-gray-200 text-gray-600 py-3 rounded-xl font-bold">取消</button>
                        <button @click="saveShopping"
                            class="flex-1 bg-kyoto-primary text-white py-3 rounded-xl font-bold">確認</button>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="modal">
            <div v-if="showModal.expense" class="fixed inset-0 bg-black/50 z-50 flex items-end justify-center p-4"
                @click.self="showModal.expense = false">
                <div class="bg-white w-full max-w-md rounded-2xl p-6 modal-content">
                    <h3 class="text-xl font-bold mb-4">{{ isExpenseEditMode ? '編輯記帳項目' : '新增記帳項目' }}</h3>
                    <div class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                        <input type="text" v-model="expenseForm.name" placeholder="花費名稱/品項 (必填)" required
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                        <input type="number" v-model.number="expenseForm.amount" placeholder="金額 (日幣, 必填)" required
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                        <label class="block text-sm text-gray-500 pt-2">日期 (必填)</label>
                        <input type="date" v-model="expenseForm.date" required
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                        <label class="block text-sm text-gray-500 pt-2">分類</label>
                        <select v-model="expenseForm.category"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                            <option value="food">美食/餐飲</option>
                            <option value="shopping">購物/藥妝</option>
                            <option value="transport">交通</option>
                            <option value="ticket">門票/體驗</option>
                            <option value="hotel">住宿</option>
                            <option value="other">其他</option>
                        </select>
                        <label class="block text-sm text-gray-500 pt-2">支付方式</label>
                        <select v-model="expenseForm.method"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                            <option value="cash">現金 (Cash)</option>
                            <option value="card">信用卡/電子支付 (Card)</option>
                        </select>
                        <input type="text" v-model="expenseForm.split" placeholder="分帳對象/備註 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                        <textarea v-model="expenseForm.notes" placeholder="詳細備註 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 h-24"></textarea>
                    </div>

                    <div class="flex gap-3 mt-6">
                        <button v-if="isExpenseEditMode" @click="deleteExpenseItem"
                            class="flex-1 bg-red-100 text-red-500 py-3 rounded-xl font-bold">刪除</button>
                        <button @click="showModal.expense = false"
                            class="flex-1 bg-gray-200 text-gray-600 py-3 rounded-xl font-bold">取消</button>
                        <button @click="saveExpense"
                            class="flex-1 bg-kyoto-primary text-white py-3 rounded-xl font-bold">確認</button>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="modal">
            <div v-if="showModal.infoEdit" class="fixed inset-0 bg-black/50 z-50 flex items-end justify-center p-4"
                @click.self="showModal.infoEdit = false">
                <div class="bg-white w-full max-w-md rounded-2xl p-6 modal-content">
                    <h3 class="text-xl font-bold mb-4">編輯 {{ infoEditTargetLabel }}</h3>
                    <textarea v-model="infoForms[infoEditTarget]" placeholder="請輸入資訊..."
                        class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 h-48"></textarea>
                    <div class="flex gap-3 mt-6">
                        <button @click="showModal.infoEdit = false"
                            class="flex-1 bg-gray-200 text-gray-600 py-3 rounded-xl font-bold">取消</button>
                        <button @click="saveInfoEdit"
                            class="flex-1 bg-kyoto-primary text-white py-3 rounded-xl font-bold">儲存</button>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="modal">
            <div v-if="showModal.hotel" class="fixed inset-0 bg-black/50 z-50 flex items-end justify-center p-4"
                @click.self="showModal.hotel = false">
                <div class="bg-white w-full max-w-md rounded-2xl p-6 modal-content">
                    <h3 class="text-xl font-bold mb-4">{{ isHotelEditMode ? '編輯住宿資訊' : '新增住宿資訊' }}</h3>
                    <div class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                        <input type="text" v-model="hotelForm.name" placeholder="住宿名稱 (必填)" required
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                        <input type="text" v-model="hotelForm.period" placeholder="入住期間/日期 (必填)" required
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                        <input type="tel" v-model="hotelForm.phone" placeholder="電話 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                        <input type="text" v-model="hotelForm.address" placeholder="地址 (必填)" required
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                        <input type="url" v-model="hotelForm.mapLink" placeholder="地圖導航連結 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                    </div>

                    <div class="flex gap-3 mt-6">
                        <button v-if="isHotelEditMode" @click="deleteHotelItem"
                            class="flex-1 bg-red-100 text-red-500 py-3 rounded-xl font-bold">刪除</button>
                        <button @click="showModal.hotel = false"
                            class="flex-1 bg-gray-200 text-gray-600 py-3 rounded-xl font-bold">取消</button>
                        <button @click="saveHotel"
                            class="flex-1 bg-kyoto-primary text-white py-3 rounded-xl font-bold">儲存</button>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="sidebar">
            <div v-if="showExchangeSidebar"
                class="fixed inset-y-0 right-0 w-full max-w-xs bg-kyoto-bg p-6 shadow-2xl z-50">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-kyoto-dark">貨幣換算</h3>
                    <button @click="showExchangeSidebar = false" class="text-gray-500 hover:text-kyoto-dark text-2xl">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>

                <div class="space-y-4">
                    <div class="bg-white p-4 rounded-xl flex flex-col shadow-soft">
                        <label class="text-xs text-gray-500 mb-1">日幣 (JPY)</label>
                        <input type="number" v-model.number="exchange.jpy" @input="calculateTWDFromJPY" placeholder="0"
                            class="w-full p-2 text-2xl font-bold text-kyoto-dark focus:outline-none focus:ring-0">
                    </div>

                    <div class="text-center text-kyoto-secondary font-bold text-2xl py-2">
                        <i class="fa-solid fa-arrows-down-up"></i>
                    </div>

                    <div class="bg-white p-4 rounded-xl flex flex-col shadow-soft">
                        <label class="text-xs text-gray-500 mb-1">台幣 (TWD)</label>
                        <input type="number" v-model.number="exchange.twd" @input="calculateJPYFromTWD" placeholder="0"
                            class="w-full p-2 text-2xl font-bold text-kyoto-dark focus:outline-none focus:ring-0">
                    </div>

                    <div class="text-center text-sm text-gray-500 pt-2">
                        目前匯率: 1 JPY = {{ exchange.rate.toFixed(4) }} TWD
                    </div>

                    <div class="pt-4">
                        <label class="block text-sm text-gray-500 mb-1">自訂匯率 (1 JPY = ? TWD)</label>
                        <input type="number" v-model.number="exchange.rate" @input="saveToLocal"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200" step="0.0001">
                    </div>
                </div>
            </div>
        </transition>


    </div>

    <script>
        const { createApp, ref, computed, watch } = Vue;

        createApp({
            setup() {
                // --- Helper Functions ---
                const saveToLocal = (key, data) => {
                    localStorage.setItem(key, JSON.stringify(data));
                };

                const loadFromLocal = (key, defaultValue) => {
                    const saved = localStorage.getItem(key);
                    return saved ? JSON.parse(saved) : defaultValue;
                };

                // --- State (ref) ---

                const currentTab = ref(loadFromLocal('currentTab', 'itinerary'));
                // 修正：確保變數被正確初始化
                const showExchangeSidebar = ref(false);

                // 1. 圖片記憶: 從 localStorage 載入，並設定預設圖片
                const headerImage = ref(loadFromLocal('headerImage', 'https://i.imgur.com/example.jpg'));

                // 行程相關
                const itineraryCategories = {
                    attraction: { label: '景點', color: 'bg-kyoto-accent' },
                    food: { label: '餐飲', color: 'bg-red-500' },
                    hotel: { label: '住宿', color: 'bg-green-600' },
                    transport: { label: '交通', color: 'bg-blue-500' },
                    flight: { label: '航班', color: 'bg-indigo-600' },
                    // 2. 新增 '逛街'
                    shopping: { label: '逛街', color: 'bg-pink-500' },
                };

                const timeSlots = {
                    allday: '全天 (All Day)',
                    morning: '上午 (9:00 - 12:00)',
                    afternoon: '下午 (12:00 - 18:00)',
                    evening: '晚上 (18:00 - 22:00)',
                };

                // **** 日期修正: 預設載入 3/6 - 3/11 共六天 ****
                const itineraryData = ref(loadFromLocal('itineraryData', {
                    '2025-03-06': { items: [] },
                    '2025-03-07': { items: [] },
                    '2025-03-08': { items: [] },
                    '2025-03-09': { items: [] },
                    '2025-03-10': { items: [] },
                    '2025-03-11': { items: [] }
                }));

                const currentDayIndex = ref(loadFromLocal('currentDayIndex', 0));


                const showModal = ref({
                    itinerary: false,
                    wishlist: false,
                    shop: false,
                    expense: false,
                    infoEdit: false,
                    hotel: false
                });

                const form = ref({
                    id: null,
                    date: '',
                    category: 'attraction',
                    name: '',
                    location: 'kyoto',
                    notes: '',
                    timeSlot: 'allday',
                    expectedHours: null,
                    flightTime: '',
                    ticket: '',
                    mapLink: '',
                    image: null
                });
                const isEditMode = ref(false);
                const editingId = ref(null);

                // 攻略相關
                const wishList = ref(loadFromLocal('wishList', []));
                const wishlistCategories = {
                    attraction: { label: '景點', color: 'bg-kyoto-accent' },
                    food: { label: '美食', color: 'bg-red-500' },
                    transport: { label: '交通', color: 'bg-blue-500' },
                    other: { label: '其他', color: 'bg-gray-500' }
                };
                const wishFilter = ref(null);
                const wishForm = ref({
                    id: Date.now(), // 3. 確保初始值有 ID
                    category: 'attraction',
                    name: '',
                    location: 'kyoto',
                    guideLink: '',
                    mapLink: '',
                    starRating: 3,
                    notes: ''
                });
                const isWishEditMode = ref(false);
                const editingIndex = ref(null);

                // 購物車相關
                const shoppingList = ref(loadFromLocal('shoppingList', []));
                // 4. 更新購物車分類
                const shopCategories = {
                    snack: '零食',
                    drugstore: '藥妝',
                    clothes: '服飾鞋包',
                    souvenir: '紀念品',
                    daily: '日用品',
                    other: '其他',
                };
                const shopForm = ref({
                    id: null,
                    tagCategory: 'snack', // 更新預設值
                    itemName: '',
                    whereToBuy: '',
                    image: null,
                    mapLink: '',
                    guideLink: '',
                    starRating: 3,
                    notes: ''
                });
                const isShopEditMode = ref(false);

                // 記帳相關
                const expenses = ref(loadFromLocal('expenses', []));
                const expenseForm = ref({
                    id: null,
                    name: '',
                    amount: '',
                    date: new Date().toISOString().substring(0, 10),
                    category: 'food',
                    method: 'cash',
                    split: '',
                    notes: ''
                });
                const isExpenseEditMode = ref(false);
                const editingExpenseIndex = ref(null);

                // 資訊區相關
                const infoEditMode = ref(false); // 6. 行前清單編輯模式
                const newChecklistItem = ref('');
                const checklist = ref(loadFromLocal('checklist', [
                    { text: '確認護照效期', checked: false },
                    { text: '兌換日幣', checked: false },
                ]));
                // 6. 資訊區塊新增 transport
                const infoForms = ref(loadFromLocal('infoForms', {
                    flight: 'TPE (桃園) -> KIX (關西)\n航班編號: XXXX\n起飛/抵達時間: 10:00 / 13:30',
                    transport: '主要使用 ICOCA 卡，建議儲值 5000 日圓。\n可搭乘南海電鐵從機場到大阪。\n京都公車一日券 700 日圓。',
                    // Note: 'transport' is added here
                }));
                const infoEditTarget = ref(null);
                const infoEditTargetLabel = ref('');

                // 住宿資訊
                const hotelList = ref(loadFromLocal('hotelList', []));
                const hotelForm = ref({
                    id: null,
                    name: '',
                    period: '',
                    phone: '',
                    address: '',
                    mapLink: ''
                });
                const isHotelEditMode = ref(false);
                const editingHotelIndex = ref(null);

                // 匯率相關
                const exchange = ref(loadFromLocal('exchange', {
                    rate: 0.22,
                    jpy: 0,
                    twd: 0
                }));

                // --- Computed ---

                const tripDays = computed(() => {
                    const dates = Object.keys(itineraryData.value).sort();
                    return dates.map(fullDate => {
                        const dateObj = new Date(fullDate);
                        const month = dateObj.getMonth() + 1;
                        const day = dateObj.getDate();
                        return {
                            fullDate: fullDate,
                            date: `${month}/${day}`
                        };
                    });
                });

                const currentDayItinerary = computed(() => {
                    if (tripDays.value.length === 0) return [];
                    const currentDayKey = tripDays.value[currentDayIndex.value]?.fullDate;
                    const items = itineraryData.value[currentDayKey] ? itineraryData.value[currentDayKey].items : [];
                    // 排序規則： allday, morning, afternoon, evening
                    const order = ['allday', 'morning', 'afternoon', 'evening'];
                    return items.sort((a, b) => {
                        return order.indexOf(a.timeSlot || 'allday') - order.indexOf(b.timeSlot || 'allday');
                    });
                });

                const filteredWishList = computed(() => {
                    if (!wishFilter.value) return wishList.value;
                    return wishList.value.filter(wish => wish.category === wishFilter.value);
                });

                const wishCategoryCounts = computed(() => {
                    const counts = { all: wishList.value.length };
                    for (const key in wishlistCategories) {
                        counts[key] = wishList.value.filter(wish => wish.category === key).length;
                    }
                    return counts;
                });

                const totalExpense = computed(() => {
                    return expenses.value.reduce((sum, item) => sum + Number(item.amount), 0);
                });

                // --- Methods ---

                // 1. 圖片記憶 - 上傳並儲存
                const uploadHeader = (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            headerImage.value = e.target.result;
                            saveToLocal('headerImage', headerImage.value); // 確保儲存
                        };
                        reader.readAsDataURL(file);
                    }
                };

                // 行程相關方法 (略)
                const openModal = (item = null, index = null) => {
                    if (item) {
                        isEditMode.value = true;
                        editingId.value = item.id;
                        form.value = { ...item };
                    } else {
                        isEditMode.value = false;
                        editingId.value = Date.now();
                        form.value = {
                            id: editingId.value,
                            date: tripDays.value[currentDayIndex.value].fullDate,
                            category: 'attraction',
                            name: '',
                            location: 'kyoto',
                            notes: '',
                            timeSlot: 'allday',
                            expectedHours: null,
                            flightTime: '',
                            ticket: '',
                            mapLink: '',
                            image: null
                        };
                    }
                    showModal.value.itinerary = true;
                };

                const closeModal = () => {
                    showModal.value.itinerary = false;
                };

                const saveItinerary = () => {
                    if (!form.value.name || !form.value.category || !form.value.date || !form.value.timeSlot) {
                        return alert('請填寫完整必填欄位 (名稱、類別、日期、時段)');
                    }

                    const newItem = { ...form.value };
                    const dayKey = newItem.date;

                    if (!itineraryData.value[dayKey]) {
                        itineraryData.value[dayKey] = { items: [] };
                    }

                    if (isEditMode.value) {
                        // 處理跨日編輯 (需先從舊的日期移除)
                        const oldDayKey = tripDays.value.find(d => itineraryData.value[d.fullDate]?.items.some(i => i.id === newItem.id))?.fullDate;

                        if (oldDayKey && oldDayKey !== dayKey) {
                            itineraryData.value[oldDayKey].items = itineraryData.value[oldDayKey].items.filter(item => item.id !== newItem.id);
                        }

                        // 更新項目
                        const dayItems = itineraryData.value[dayKey].items;
                        const index = dayItems.findIndex(item => item.id === newItem.id);
                        if (index !== -1) {
                            dayItems[index] = newItem;
                        } else {
                            // 如果在舊日期找不到，就當作新項目加入
                            dayItems.push(newItem);
                        }
                    } else {
                        itineraryData.value[dayKey].items.push(newItem);
                    }

                    saveToLocal('itineraryData', itineraryData.value);
                    closeModal();
                };

                const deleteItem = (id) => {
                    if (confirm('確定刪除此行程項目？')) {
                        const dayKey = form.value.date || tripDays.value[currentDayIndex.value].fullDate;
                        if (itineraryData.value[dayKey]) {
                            itineraryData.value[dayKey].items = itineraryData.value[dayKey].items.filter(item => item.id !== id);
                            saveToLocal('itineraryData', itineraryData.value);
                            closeModal();
                        }
                    }
                };

                const editItem = (item) => {
                    // 為了能在編輯 modal 中顯示日期，需要找到項目所在的日期
                    const dayKey = tripDays.value.find(d => itineraryData.value[d.fullDate]?.items.some(i => i.id === item.id))?.fullDate;
                    openModal({ ...item, date: dayKey });
                };

                const openMap = (link, name) => {
                    window.open(link, '_blank');
                };

                const handleItineraryImage = (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            form.value.image = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                };

                const getCategoryColor = (category) => {
                    return itineraryCategories[category]?.color || 'bg-gray-500';
                };

                const getCategoryLabel = (category) => {
                    return itineraryCategories[category]?.label || '其他';
                };

                // 攻略相關方法
                const openWishModal = (wish = null, index = null) => {
                    if (wish) {
                        isWishEditMode.value = true;
                        editingIndex.value = index;
                        wishForm.value = { ...wish };
                    } else {
                        isWishEditMode.value = false;
                        editingIndex.value = null;
                        // 3. 確保新增時 ID 被正確設定
                        wishForm.value = {
                            id: Date.now(),
                            category: 'attraction',
                            name: '',
                            location: 'kyoto',
                            guideLink: '',
                            mapLink: '',
                            starRating: 3,
                            notes: ''
                        };
                    }
                    showModal.value.wishlist = true;
                };

                const editWish = (wish, index) => {
                    openWishModal(wish, index);
                };

                const saveWish = () => {
                    if (!wishForm.value.name || !wishForm.value.category) return alert('請填寫攻略名稱和分類');
                    if (isWishEditMode.value) {
                        wishList.value[editingIndex.value] = { ...wishForm.value };
                    } else {
                        // 3. 新增邏輯：ID 在 openWishModal 已生成
                        wishList.value.push({ ...wishForm.value });
                    }
                    saveToLocal('wishList', wishList.value);
                    showModal.value.wishlist = false;
                };

                const removeWish = (id) => {
                    if (confirm('確定刪除此攻略項目？')) {
                        wishList.value = wishList.value.filter(item => item.id !== id);
                        saveToLocal('wishList', wishList.value);
                    }
                };

                const deleteWishItem = () => {
                    if (confirm('確定刪除此攻略項目？')) {
                        wishList.value.splice(editingIndex.value, 1);
                        saveToLocal('wishList', wishList.value);
                        showModal.value.wishlist = false;
                    }
                };

                // 購物車相關方法
                const getShoppingCategoryColor = (tagCategory) => {
                    // Simple color mapping for new categories
                    const colors = {
                        snack: 'bg-yellow-500',
                        drugstore: 'bg-green-500',
                        clothes: 'bg-indigo-500',
                        souvenir: 'bg-kyoto-accent',
                        daily: 'bg-blue-500',
                        other: 'bg-gray-500'
                    };
                    return colors[tagCategory] || 'bg-gray-500';
                };

                const openShopModal = (item = null, index = null) => {
                    if (item) {
                        isShopEditMode.value = true;
                        shopForm.value = { ...item };
                        editingIndex.value = index;
                    } else {
                        isShopEditMode.value = false;
                        shopForm.value = {
                            id: Date.now(),
                            tagCategory: 'snack', // 4. 更新預設分類
                            itemName: '',
                            whereToBuy: '',
                            image: null,
                            mapLink: '',
                            guideLink: '',
                            starRating: 3,
                            notes: ''
                        };
                    }
                    showModal.value.shop = true;
                };

                const saveShopping = () => {
                    if (!shopForm.value.itemName || !shopForm.value.tagCategory) return alert('請填寫品項名稱和分類');

                    if (isShopEditMode.value) {
                        // 編輯
                        const index = shoppingList.value.findIndex(item => item.id === shopForm.value.id);
                        if (index !== -1) {
                            shoppingList.value[index] = { ...shopForm.value };
                        }
                    } else {
                        // 新增
                        shoppingList.value.push({ ...shopForm.value });
                    }
                    saveToLocal('shoppingList', shoppingList.value);
                    showModal.value.shop = false;
                };

                const removeShoppingItem = (id) => {
                    if (confirm('確定刪除此購物項目？')) {
                        shoppingList.value = shoppingList.value.filter(item => item.id !== id);
                        saveToLocal('shoppingList', shoppingList.value);
                    }
                };

                const deleteShopItem = () => {
                    if (confirm('確定刪除此購物項目？')) {
                        shoppingList.value = shoppingList.value.filter(item => item.id !== shopForm.value.id);
                        saveToLocal('shoppingList', shoppingList.value);
                        showModal.value.shop = false;
                    }
                };

                const handleShopImage = (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            shopForm.value.image = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                };

                // 記帳相關方法 (略)
                const openExpenseModal = (item = null, index = null) => {
                    if (item) {
                        isExpenseEditMode.value = true;
                        editingExpenseIndex.value = index;
                        expenseForm.value = { ...item, amount: String(item.amount) }; // 轉回字串方便編輯
                    } else {
                        isExpenseEditMode.value = false;
                        editingExpenseIndex.value = null;
                        expenseForm.value = {
                            id: Date.now(),
                            name: '',
                            amount: '',
                            date: new Date().toISOString().substring(0, 10),
                            category: 'food',
                            method: 'cash',
                            split: '',
                            notes: ''
                        };
                    }
                    showModal.value.expense = true;
                };

                const saveExpense = () => {
                    if (!expenseForm.value.name || !expenseForm.value.amount || !expenseForm.value.date) {
                        return alert('請填寫花費名稱、金額和日期');
                    }
                    const newItem = { ...expenseForm.value, amount: Number(expenseForm.value.amount) };
                    if (isExpenseEditMode.value) {
                        expenses.value[editingExpenseIndex.value] = newItem;
                    } else {
                        expenses.value.push(newItem);
                    }
                    saveToLocal('expenses', expenses.value);
                    showModal.value.expense = false;
                };

                const editExpense = (item, index) => {
                    openExpenseModal(item, index);
                };

                const deleteExpenseItem = () => {
                    if (confirm('確定刪除此記帳項目？')) {
                        expenses.value.splice(editingExpenseIndex.value, 1);
                        saveToLocal('expenses', expenses.value);
                        showModal.value.expense = false;
                    }
                };

                const getExpenseIcon = (cat) => {
                    const map = {
                        food: 'fa-solid fa-utensils',
                        shopping: 'fa-solid fa-bag-shopping',
                        transport: 'fa-solid fa-train-subway',
                        ticket: 'fa-solid fa-ticket',
                        hotel: 'fa-solid fa-hotel',
                        other: 'fa-solid fa-money-bill'
                    };
                    return map[cat] || 'fa-solid fa-money-bill';
                };


                // 住宿相關方法
                const openHotelModal = (hotel = null, index = null) => {
                    if (hotel) {
                        isHotelEditMode.value = true;
                        editingHotelIndex.value = index;
                        hotelForm.value = { ...hotel };
                    } else {
                        isHotelEditMode.value = false;
                        editingHotelIndex.value = null;
                        hotelForm.value = { id: Date.now(), name: '', period: '', phone: '', address: '', mapLink: '' };
                    }
                    showModal.value.hotel = true;
                };

                const saveHotel = () => {
                    if (!hotelForm.value.name || !hotelForm.value.period || !hotelForm.value.address) {
                        return alert('請填寫住宿名稱、期間和地址');
                    }
                    if (isHotelEditMode.value) {
                        hotelList.value[editingHotelIndex.value] = { ...hotelForm.value };
                    } else {
                        hotelList.value.push({ ...hotelForm.value });
                    }
                    saveToLocal('hotelList', hotelList.value);
                    showModal.value.hotel = false;
                };

                const deleteHotelItem = () => {
                    if (confirm('確定刪除此住宿資訊？')) {
                        hotelList.value.splice(editingHotelIndex.value, 1);
                        saveToLocal('hotelList', hotelList.value);
                        showModal.value.hotel = false;
                    }
                };

                const deleteHotel = (name) => {
                    if (confirm(`確定刪除 ${name} 的住宿資訊？`)) {
                        hotelList.value = hotelList.value.filter(item => item.name !== name);
                        saveToLocal('hotelList', hotelList.value);
                    }
                };


                // 資訊區相關方法
                const addChecklistItem = () => {
                    if (newChecklistItem.value.trim() !== '') {
                        checklist.value.push({ text: newChecklistItem.value, checked: false });
                        newChecklistItem.value = '';
                        saveToLocal('checklist', checklist.value);
                    }
                };

                const removeChecklistItem = (index) => {
                    checklist.value.splice(index, 1);
                    saveToLocal('checklist', checklist.value);
                };

                const openInfoEditModal = (target) => {
                    infoEditTarget.value = target;
                    const labels = {
                        flight: '航班資訊',
                        transport: '交通資料'
                    };
                    infoEditTargetLabel.value = labels[target] || '資訊';
                    showModal.value.infoEdit = true;
                };

                const saveInfoEdit = () => {
                    saveToLocal('infoForms', infoForms.value);
                    showModal.value.infoEdit = false;
                };

                // 6. 資訊頁編輯模式切換
                const toggleInfoEditMode = () => {
                    infoEditMode.value = !infoEditMode.value;
                    if (infoEditMode.value) {
                        alert('行前清單進入編輯模式，可新增/刪除項目。');
                    } else {
                        alert('行前清單離開編輯模式。');
                    }
                };


                // 匯率相關
                const calculateTWDFromJPY = () => {
                    exchange.value.twd = exchange.value.jpy * exchange.value.rate;
                    saveToLocal('exchange', exchange.value);
                };

                const calculateJPYFromTWD = () => {
                    exchange.value.jpy = exchange.value.twd / exchange.value.rate;
                    saveToLocal('exchange', exchange.value);
                };


                // --- Watchers (Persistence) ---

                watch(itineraryData, (newVal) => {
                    saveToLocal('itineraryData', newVal);
                }, { deep: true });

                watch(wishList, (newVal) => {
                    saveToLocal('wishList', newVal);
                }, { deep: true });

                watch(shoppingList, (newVal) => {
                    saveToLocal('shoppingList', newVal);
                }, { deep: true });

                watch(expenses, (newVal) => {
                    saveToLocal('expenses', newVal);
                }, { deep: true });

                watch(checklist, (newVal) => {
                    saveToLocal('checklist', newVal);
                }, { deep: true });

                watch(infoForms, (newVal) => {
                    saveToLocal('infoForms', newVal);
                }, { deep: true });

                watch(hotelList, (newVal) => {
                    saveToLocal('hotelList', newVal);
                }, { deep: true });

                watch(headerImage, (newVal) => {
                    saveToLocal('headerImage', newVal);
                }, { deep: true });

                watch(currentDayIndex, (newVal) => {
                    saveToLocal('currentDayIndex', newVal);
                });


                return {
                    currentTab, showExchangeSidebar, // ⬅️ 修正：已將 showExchangeSidebar 導出
                    headerImage, uploadHeader,
                    timeSlots, itineraryCategories,
                    tripDays, currentDayIndex, currentDayItinerary,
                    itineraryData, showModal, form, isEditMode,
                    saveItinerary, deleteItem, editItem, openModal, closeModal, openMap, handleItineraryImage,
                    getCategoryColor, getCategoryLabel,
                    exchange, calculateTWDFromJPY, calculateJPYFromTWD,
                    wishList, openWishModal, wishForm, saveWish, editWish, removeWish, deleteWishItem, isWishEditMode,
                    wishlistCategories, wishFilter, filteredWishList, wishCategoryCounts,
                    shoppingList, shopForm, openShopModal, saveShopping, handleShopImage, removeShoppingItem, deleteShopItem, isShopEditMode, shopCategories, getShoppingCategoryColor,
                    expenses, totalExpense, openExpenseModal, expenseForm, saveExpense, getExpenseIcon, editExpense, deleteExpenseItem, isExpenseEditMode,
                    // 6. 資訊頁相關
                    infoEditMode, checklist, newChecklistItem, addChecklistItem, removeChecklistItem, toggleInfoEditMode,
                    infoEditTarget, infoEditTargetLabel, openInfoEditModal, infoForms, saveInfoEdit,
                    hotelList, hotelForm, openHotelModal, saveHotel, deleteHotel, deleteHotelItem, isHotelEditMode,
                    saveToLocal
                };
            }
        }).mount('#app');
    </script>
</body>

</html>