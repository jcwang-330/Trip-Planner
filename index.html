<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KYOTO & OSAKA | Trip Planner</title>

    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@100;400;500;700;900&display=swap"
        rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        kyoto: {
                            bg: '#F7F4EF',
                            primary: '#6A7F60',
                            secondary: '#8F7762',
                            accent: '#D48666',
                            dark: '#4A4036',
                            light: '#FFFFFF'
                        },
                        calculator: {
                            keypad: '#E8E4DF',
                            op: '#D2CDC7',
                            equal: '#8F7762'
                        }
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                    }
                },
            },
        }
    </script>

    <style>
        body {
            background-color: #F7F4EF;
            font-family: 'Noto Sans TC', sans-serif;
        }

        /* 隱藏滾動條 */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
        }

        /* 模態框動畫 */
        .modal-enter-active,
        .modal-leave-active {
            transition: opacity 0.3s ease;
        }

        .modal-enter-from,
        .modal-leave-to {
            opacity: 0;
        }

        .modal-enter-active .modal-content,
        .modal-leave-active .modal-content {
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .modal-enter-from .modal-content,
        .modal-leave-to .modal-content {
            transform: translateY(100%);
        }

        /* 軟陰影 */
        .shadow-soft {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
        }

        /* 行程列表過渡動畫 */
        .itinerary-list-enter-active,
        .itinerary-list-leave-active {
            transition: all 0.5s ease;
        }

        .itinerary-list-enter-from,
        .itinerary-list-leave-to {
            opacity: 0;
            transform: translateX(30px);
        }

        /* 計算機按鍵樣式 */
        .calc-key {
            height: 55px;
            border-radius: 12px;
            font-size: 1.5rem;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: background-color 0.1s;
        }

        .calc-key:active {
            opacity: 0.8;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        /* 表單統一風格 */
        .form-input-style {
            background-color: #F8F8F8;
            border: 1px solid #E5E5E5;
            padding: 12px;
            border-radius: 12px;
            width: 100%;
            transition: border-color 0.2s;
        }

        .form-input-style:focus {
            outline: none;
            border-color: #6A7F60;
            /* kyoto-primary */
        }
    </style>

</head>

<body>
    <div id="app" class="max-w-md mx-auto min-h-screen flex flex-col">

        <div class="relative h-64 overflow-hidden shadow-soft">
            <img :src="headerImage" alt="Kyoto Street View" class="w-full h-full object-cover">
            <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent flex items-end p-6 text-white">
                <h1 class="text-4xl font-bold tracking-wide whitespace-nowrap">KYOTO & OSAKA | Trip Planner</h1>
            </div>
            <label
                class="absolute top-4 right-4 bg-white/30 hover:bg-white/50 p-2 rounded-full cursor-pointer transition-colors">
                <i class="fa-solid fa-camera text-white text-lg"></i>
                <input type="file" @change="uploadHeader" class="hidden" accept="image/*">
            </label>
        </div>


        <main class="flex-grow p-4 space-y-4">

            <iframe :src="weatherIframeSrc" width="100%" height="100" frameborder="0"
                class="rounded-2xl shadow-soft"></iframe>


            <div class="bg-kyoto-light rounded-2xl p-4 shadow-soft space-y-3">
                <div class="text-right space-y-1">
                    <div class="text-sm text-gray-500">
                        1 {{ exchange.fromCurrency }} ≈ {{ exchange.rate }} {{ exchange.toCurrency }}
                    </div>
                    <div class="text-2xl font-bold text-kyoto-dark">
                        {{ exchange.toCurrency }} {{ calculatorResult }}
                    </div>
                </div>

                <div class="flex items-center justify-between">
                    <input type="text" v-model="currentInput" placeholder="預設空白"
                        class="text-4xl font-light w-1/2 p-0 text-left bg-transparent border-none focus:outline-none"
                        :placeholder="exchange.fromCurrency">

                    <div @click="swapCurrencies"
                        class="flex items-center space-x-2 text-kyoto-primary cursor-pointer active:opacity-75 transition-opacity">
                        <i class="fa-solid fa-rotate text-lg"></i>
                        <span class="text-lg font-bold">{{ exchange.fromCurrency }} &rarr; {{ exchange.toCurrency
                            }}</span>
                    </div>
                </div>

                <div class="bg-calculator-keypad rounded-xl p-3 shadow-inner grid grid-cols-4 gap-2">
                    <button @click="appendDigit('7')" class="calc-key bg-white text-kyoto-dark">7</button>
                    <button @click="appendDigit('8')" class="calc-key bg-white text-kyoto-dark">8</button>
                    <button @click="appendDigit('9')" class="calc-key bg-white text-kyoto-dark">9</button>
                    <button @click="clearInput" class="calc-key bg-calculator-op text-kyoto-dark">C</button>

                    <button @click="appendDigit('4')" class="calc-key bg-white text-kyoto-dark">4</button>
                    <button @click="appendDigit('5')" class="calc-key bg-white text-kyoto-dark">5</button>
                    <button @click="appendDigit('6')" class="calc-key bg-white text-kyoto-dark">6</button>
                    <button @click="deleteDigit" class="calc-key bg-calculator-op text-kyoto-dark"><i
                            class="fa-solid fa-delete-left"></i></button>

                    <button @click="appendDigit('1')" class="calc-key bg-white text-kyoto-dark">1</button>
                    <button @click="appendDigit('2')" class="calc-key bg-white text-kyoto-dark">2</button>
                    <button @click="appendDigit('3')" class="calc-key bg-white text-kyoto-dark">3</button>
                    <button @click="toggleSign" class="calc-key bg-calculator-op text-kyoto-dark">±</button>

                    <button @click="appendDigit('0')" class="calc-key bg-white text-kyoto-dark col-span-2">0</button>
                    <button @click="appendDecimal" class="calc-key bg-white text-kyoto-dark">.</button>
                    <button @click="openModal('exchange')" class="calc-key bg-calculator-equal text-white"><i
                            class="fa-solid fa-gear"></i></button>
                </div>
            </div>


            <div class="flex overflow-x-auto py-2 space-x-3 hide-scrollbar">
                <div v-for="(day, index) in tripDays" :key="index" @click="currentDayIndex = index"
                    :class="{ 'bg-kyoto-primary text-white shadow-md': currentDayIndex === index, 'bg-kyoto-light text-kyoto-dark hover:bg-gray-100': currentDayIndex !== index }"
                    class="flex-shrink-0 w-16 h-20 rounded-xl flex flex-col items-center justify-center cursor-pointer transition-colors">
                    <span class="text-xs">{{ day.weekDay }}</span>
                    <span class="text-2xl font-bold mt-1">{{ day.date }}</span>
                </div>
            </div>

            <div class="flex justify-between bg-kyoto-light rounded-2xl p-2 shadow-soft">
                <div v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id"
                    :class="{ 'bg-kyoto-primary text-white': currentTab === tab.id, 'text-kyoto-dark': currentTab !== tab.id }"
                    class="flex-1 text-center py-2 rounded-xl cursor-pointer transition-colors text-sm font-medium flex items-center justify-center space-x-2">
                    <i :class="tab.icon"></i>
                    <span>{{ tab.label }}</span>
                </div>
            </div>

            <hr class="border-t border-kyoto-secondary/20 my-4">

            <div v-if="currentTab === 'itinerary'" class="space-y-6">
                <div class="flex items-center space-x-2">
                    <div class="text-sm font-medium">篩選地點:</div>
                    <select v-model="itineraryLocationFilter"
                        class="p-2 bg-white rounded-lg border border-gray-300 text-sm form-input-style">
                        <option value="">所有地點</option>
                        <option v-for="loc in uniqueLocations" :key="loc" :value="loc">{{ loc }}</option>
                    </select>
                </div>

                <transition-group name="itinerary-list" tag="div" class="relative space-y-4">
                    <div v-for="(group, groupName) in groupedItinerary" :key="groupName" class="space-y-4 pt-2">
                        <h3 v-if="group.items.length > 0"
                            class="text-xl font-bold text-kyoto-secondary/80 border-b pb-1">
                            {{ group.label }}
                        </h3>

                        <div v-for="(locationGroup, locationIndex) in group.items" :key="locationGroup.location"
                            class="bg-kyoto-light rounded-2xl p-4 shadow-soft">

                            <div class="flex items-center justify-between cursor-pointer"
                                @click="locationGroup.expanded = !locationGroup.expanded">
                                <h4 class="text-xl font-bold text-kyoto-dark">{{ locationGroup.location }}</h4>
                                <i :class="{ 'fa-chevron-up': locationGroup.expanded, 'fa-chevron-down': !locationGroup.expanded }"
                                    class="fa-solid text-kyoto-primary transition-transform"></i>
                            </div>

                            <transition name="fade">
                                <div v-if="locationGroup.expanded" class="mt-4 space-y-3">
                                    <div v-for="(item, itemIndex) in locationGroup.items" :key="item.id"
                                        class="itinerary-item border-l-4 p-3 rounded-r-lg shadow-sm relative transition-all"
                                        :class="getCategoryColor(item.category)">

                                        <button @click.stop="editItem(item.id)"
                                            class="absolute top-2 right-2 text-gray-400 hover:text-kyoto-accent transition-colors">
                                            <i class="fa-solid fa-pen text-sm"></i>
                                        </button>

                                        <div class="flex items-start space-x-3">
                                            <div class="flex flex-col items-center">
                                                <div class="text-sm font-bold">{{ item.startTime }}</div>
                                            </div>

                                            <div class="flex-grow">
                                                <h5 class="font-bold text-kyoto-dark">{{ item.name }}</h5>
                                                <p class="text-sm text-gray-600">{{ item.description }}</p>
                                                <div class="mt-2 space-y-2">

                                                    <div v-if="item.stayDuration || item.duration"
                                                        class="flex items-center text-sm text-gray-600">
                                                        <span v-if="item.stayDuration" class="mr-3">
                                                            <i class="fa-solid fa-clock w-4 mr-1 text-kyoto-accent"></i>
                                                            {{ item.stayDuration }}
                                                        </span>
                                                        <span v-if="item.duration">
                                                            <i :class="getTransportIcon(item.transport)"
                                                                class="w-4 mr-1 text-kyoto-primary"></i>
                                                            {{ item.duration }}
                                                        </span>
                                                    </div>

                                                    <div v-if="item.imageUrl"
                                                        class="relative h-24 w-full rounded-lg overflow-hidden mt-2">
                                                        <img :src="item.imageUrl" alt="Itinerary Image"
                                                            class="w-full h-full object-cover">
                                                    </div>

                                                    <button v-if="item.mapLink"
                                                        @click.stop="openMap(item.mapLink, item.name)"
                                                        class="mt-2 w-full bg-kyoto-bg text-kyoto-primary py-2 rounded-lg text-sm font-bold active:bg-kyoto-secondary/10 transition-colors">
                                                        <i class="fa-solid fa-map-location-dot mr-1"></i> 前往地圖
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <div v-if="itemIndex < locationGroup.items.length - 1" class="text-center pt-2">
                                            <i :class="getTransportIcon(locationGroup.items[itemIndex + 1].transport)"
                                                class="text-xl text-kyoto-secondary"></i>
                                        </div>

                                    </div>
                                </div>
                            </transition>

                        </div>
                    </div>
                </transition-group>

                <div class="text-center pt-4">
                    <button @click="openModal('itinerary')"
                        class="w-full py-3 rounded-xl bg-kyoto-primary text-white font-bold shadow-soft hover:bg-kyoto-secondary transition-colors">
                        <i class="fa-solid fa-plus mr-2"></i> 新增行程
                    </button>
                </div>
            </div>

            <div v-if="currentTab === 'strategy'" class="space-y-6">

                <div class="grid grid-cols-2 gap-3">
                    <div v-for="(stats, key) in strategyStats" :key="key"
                        class="bg-kyoto-light rounded-xl p-3 shadow-soft text-center"
                        :class="strategyCategories[key].cardClass">
                        <div class="text-sm opacity-80">{{ strategyCategories[key].label }}</div>
                        <div class="text-2xl font-bold mt-1">{{ stats.count }}</div>
                    </div>
                </div>


                <div class="flex flex-wrap gap-2">
                    <select v-model="strategyLocationFilter"
                        class="p-2 bg-white rounded-lg border text-sm form-input-style">
                        <option value="">所有地點</option>
                        <option value="Kyoto">京都</option>
                        <option value="Osaka">大阪</option>
                        <option value="Other">其他</option>
                    </select>
                    <select v-model="strategyFilter" class="p-2 bg-white rounded-lg border text-sm form-input-style">
                        <option value="">所有類別</option>
                        <option v-for="(cat, key) in strategyCategories" :key="key" :value="key">{{ cat.label }}
                        </option>
                    </select>
                </div>

                <transition-group name="strategy-list" tag="div" class="space-y-4">
                    <div v-for="item in filteredStrategyList" :key="item.id"
                        class="bg-kyoto-light rounded-2xl p-4 shadow-soft space-y-2 relative">
                        <span :class="strategyCategories[item.category].color"
                            class="text-white text-xs font-medium px-2 py-0.5 rounded-full absolute top-2 left-2">
                            {{ strategyCategories[item.category].label }}
                        </span>

                        <h3 class="text-xl font-bold pt-4 text-kyoto-dark">{{ item.title }}</h3>
                        <p class="text-sm text-gray-600">地點：{{ item.location }}</p>
                        <div class="text-kyoto-accent text-lg">
                            <i v-for="n in 5" :key="n"
                                :class="{'fa-solid': n <= item.starRating, 'fa-regular': n > item.starRating}"
                                class="fa-star"></i>
                        </div>
                        <p class="text-base whitespace-pre-line">{{ item.notes }}</p>

                        <div v-if="item.imageUrl" class="h-40 w-full rounded-lg overflow-hidden mt-2">
                            <img :src="item.imageUrl" alt="Strategy Image" class="w-full h-full object-cover">
                        </div>

                        <div class="flex justify-end space-x-3 pt-2">
                            <a v-if="item.mapLink" :href="item.mapLink" target="_blank"
                                class="text-kyoto-primary hover:text-kyoto-accent transition-colors text-sm">
                                導航前往 <i class="fa-solid fa-location-arrow"></i>
                            </a>
                            <a v-if="item.infoLink" :href="item.infoLink" target="_blank"
                                class="text-kyoto-primary hover:text-kyoto-accent transition-colors text-sm">
                                攻略連結 <i class="fa-solid fa-link"></i>
                            </a>

                            <button @click="editStrategy(item.id)"
                                class="text-kyoto-accent hover:text-kyoto-primary transition-colors text-sm">
                                編輯 <i class="fa-solid fa-pen"></i>
                            </button>
                            <button @click="removeStrategy(item.id)"
                                class="text-red-500 hover:text-red-700 transition-colors text-sm">
                                刪除 <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </transition-group>

                <div class="text-center pt-4">
                    <button @click="openStrategyModal()"
                        class="w-full py-3 rounded-xl bg-kyoto-primary text-white font-bold shadow-soft hover:bg-kyoto-secondary transition-colors">
                        <i class="fa-solid fa-plus mr-2"></i> 新增攻略
                    </button>
                </div>
            </div>

            <div v-if="currentTab === 'expense'" class="pb-4 space-y-6">
                <div class="bg-kyoto-dark text-white rounded-2xl p-4 shadow-soft text-center">
                    <div class="text-sm opacity-80">總花費 (JPY)</div>
                    <div class="text-3xl font-bold mt-1">¥ {{ totalExpense.toLocaleString() }}</div>
                </div>

                <div class="space-y-3">
                    <div v-for="(exp, index) in expenses" :key="exp.id"
                        class="bg-white rounded-xl p-4 shadow-sm flex items-center space-x-4">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center text-white"
                            :class="getExpenseIcon(exp.category).color">
                            <i :class="getExpenseIcon(exp.category).icon"></i>
                        </div>
                        <div class="flex-grow">
                            <div class="font-bold text-kyoto-dark">{{ exp.name }}</div>
                            <div class="text-xs text-gray-500">{{ exp.date }} / {{ exp.method }}</div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button @click="editExpense(exp)" class="text-gray-400 hover:text-kyoto-accent"><i
                                    class="fa-solid fa-pen text-sm"></i></button>
                            <div class="font-bold text-kyoto-dark">¥ {{ parseInt(exp.amount).toLocaleString() }}</div>
                        </div>
                    </div>
                </div>

                <div class="text-center pt-4">
                    <button @click="openExpenseModal()"
                        class="w-full py-3 rounded-xl bg-kyoto-primary text-white font-bold shadow-soft hover:bg-kyoto-secondary transition-colors">
                        <i class="fa-solid fa-plus mr-2"></i> 新增花費
                    </button>
                </div>
            </div>

            <div v-if="currentTab === 'hotel'" class="space-y-4">
                <div v-for="(hotel, index) in hotelList" :key="hotel.id"
                    class="bg-kyoto-light rounded-2xl p-4 shadow-soft space-y-3">
                    <div class="flex justify-between items-start">
                        <h3 class="text-xl font-bold text-kyoto-dark">{{ hotel.name }}</h3>
                        <button @click="openHotelModal(hotel, index)"
                            class="text-kyoto-primary hover:text-kyoto-accent">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                    </div>
                    <p class="text-sm text-gray-600">{{ hotel.period }}</p>
                    <div class="space-y-2">
                        <div v-if="hotel.phone" class="flex items-center text-sm text-gray-600">
                            <i class="fa-solid fa-phone w-4 mr-2 text-kyoto-accent"></i>
                            <span>{{ hotel.phone }}</span>
                        </div>
                        <div v-if="hotel.address" class="flex items-center text-sm text-gray-600">
                            <i class="fa-solid fa-location-dot w-4 mr-2 text-kyoto-accent"></i>
                            <span>{{ hotel.address }}</span>
                        </div>
                    </div>
                    <button v-if="hotel.mapLink" @click="openMap(hotel.mapLink, hotel.name)"
                        class="mt-2 w-full bg-kyoto-bg text-kyoto-primary py-2 rounded-lg text-sm font-bold active:bg-kyoto-secondary/10 transition-colors">
                        <i class="fa-solid fa-map-location-dot mr-1"></i> 前往地圖
                    </button>
                </div>

                <div class="text-center pt-4">
                    <button @click="openHotelModal()"
                        class="w-full py-3 rounded-xl bg-kyoto-primary text-white font-bold shadow-soft hover:bg-kyoto-secondary transition-colors">
                        <i class="fa-solid fa-plus mr-2"></i> 新增住宿
                    </button>
                </div>
            </div>


            <div v-if="currentTab === 'info'" class="space-y-6">
                <div class="bg-kyoto-light rounded-2xl p-4 shadow-soft">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-xl font-bold">行前檢查清單</h3>
                        <button @click="infoEditMode.checklist = !infoEditMode.checklist"
                            class="text-sm text-kyoto-primary hover:text-kyoto-accent">{{ infoEditMode.checklist ? '完成'
                            : '編輯' }}</button>
                    </div>
                    <div class="space-y-2">
                        <div v-for="(item, index) in checklist" :key="index" class="flex items-center justify-between">
                            <label class="flex items-center">
                                <input type="checkbox" v-model="item.done" @change="saveToLocal"
                                    class="form-checkbox text-kyoto-primary h-4 w-4 rounded border-gray-300">
                                <span :class="{'line-through text-gray-400': item.done}" class="ml-2">{{ item.text
                                    }}</span>
                            </label>
                            <button v-if="infoEditMode.checklist" @click="removeChecklistItem(index)"
                                class="text-red-500 ml-3 hover:text-red-700">
                                <i class="fa-solid fa-trash text-sm"></i>
                            </button>
                        </div>
                    </div>
                    <div v-if="infoEditMode.checklist" class="mt-3 flex">
                        <input type="text" v-model="newChecklistItem" placeholder="新增清單項目"
                            @keyup.enter="addChecklistItem"
                            class="flex-grow form-input-style p-2 bg-gray-50 rounded-l-xl border focus:outline-none">
                        <button @click="addChecklistItem"
                            class="bg-kyoto-primary text-white p-2 rounded-r-xl">新增</button>
                    </div>
                </div>

                <div class="space-y-4">
                    <div v-for="(form, key) in infoForms" :key="key" class="bg-kyoto-light rounded-2xl p-4 shadow-soft">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-xl font-bold">{{ form.label }}</h3>
                            <button @click="openInfoEditModal(key)"
                                class="text-sm text-kyoto-primary hover:text-kyoto-accent">
                                編輯 <i class="fa-solid fa-pen ml-1"></i>
                            </button>
                        </div>
                        <p class="text-gray-600 whitespace-pre-line">{{ form.content || '尚未填寫' }}</p>
                    </div>
                </div>
            </div>


        </main>

        <button v-if="currentTab === 'itinerary'" @click="openModal('itinerary')"
            class="fixed bottom-6 right-6 w-14 h-14 rounded-full bg-kyoto-primary text-white text-2xl shadow-lg hover:bg-kyoto-secondary transition-colors z-40">
            <i class="fa-solid fa-plus"></i>
        </button>


        <transition name="modal">
            <div v-if="showModal.itinerary" class="fixed inset-0 bg-black/50 z-50 flex items-end justify-center p-4">
                <div class="bg-white w-full max-w-md rounded-2xl p-6 modal-content">
                    <h3 class="text-xl font-bold mb-4">{{ isEditMode ? '編輯行程' : '新增行程' }}</h3>
                    <div class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                        <select v-model="form.location" class="form-input-style">
                            <option value="">地點 (京都/大阪)</option>
                            <option value="Kyoto">京都</option>
                            <option value="Osaka">大阪</option>
                            <option value="Other">其他</option>
                        </select>
                        <input type="text" v-model="form.name" placeholder="活動名稱 (例如：參觀本堂)" class="form-input-style">

                        <input type="time" v-model="form.startTime" placeholder="時間 (24小時制)" class="form-input-style">

                        <input type="text" v-model="form.stayDuration" placeholder="停留時間 (例如：2小時 或 90分鐘)"
                            class="form-input-style">

                        <textarea v-model="form.description" placeholder="備註或簡介" rows="3"
                            class="form-input-style"></textarea>

                        <select v-model="form.category" class="form-input-style">
                            <option value="">選擇類別</option>
                            <option value="attraction">景點</option>
                            <option value="food">美食</option>
                            <option value="shopping">購物</option>
                            <option value="other">其他</option>
                        </select>

                        <div class="text-lg font-bold text-kyoto-dark pt-2 pb-1 border-b border-kyoto-secondary/50">交通資訊
                            (接續下個地點)</div>
                        <select v-model="form.transport" class="form-input-style">
                            <option value="">選擇交通方式</option>
                            <option value="walk">步行</option>
                            <option value="train">電車/地鐵</option>
                            <option value="bus">公車</option>
                            <option value="taxi">計程車</option>
                            <option value="plane">飛機</option>
                        </select>
                        <input type="text" v-model="form.duration" placeholder="交通所需時間 (例如：20分鐘)"
                            class="form-input-style">
                        <input type="url" v-model="form.mapLink" placeholder="Google Map 導航連結" class="form-input-style">

                        <div class="pt-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">行程圖片 (選填)</label>
                            <input type="file" @change="handleItineraryImage"
                                class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-kyoto-bg file:text-kyoto-primary hover:file:bg-kyoto-secondary/10">
                            <img v-if="form.imageUrl" :src="form.imageUrl" alt="預覽"
                                class="mt-2 w-full h-24 object-cover rounded-lg">
                        </div>

                    </div>
                    <div class="flex gap-3 mt-4">
                        <button v-if="isEditMode" @click="deleteItem(form.id); closeModal('itinerary')"
                            class="flex-1 bg-red-100 text-red-500 py-3 rounded-xl font-bold">刪除</button>
                        <button @click="closeModal('itinerary')"
                            class="flex-1 bg-gray-200 text-gray-600 py-3 rounded-xl font-bold">取消</button>
                        <button @click="saveItinerary"
                            class="flex-1 bg-kyoto-primary text-white py-3 rounded-xl font-bold">確認</button>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="modal">
            <div v-if="showModal.strategy" class="fixed inset-0 bg-black/50 z-50 flex items-end justify-center p-4">
                <div class="bg-white w-full max-w-md rounded-2xl p-6 modal-content">
                    <h3 class="text-xl font-bold mb-4">{{ isStrategyEditMode ? '編輯攻略' : '新增攻略' }}</h3>
                    <div class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                        <input type="text" v-model="strategyForm.title" placeholder="標題/名稱" class="form-input-style">

                        <select v-model="strategyForm.category" class="form-input-style">
                            <option value="">選擇類別</option>
                            <option v-for="(cat, key) in strategyCategories" :key="key" :value="key">{{ cat.label }}
                            </option>
                        </select>

                        <select v-model="strategyForm.location" class="form-input-style">
                            <option value="">地點 (京都/大阪)</option>
                            <option value="Kyoto">京都</option>
                            <option value="Osaka">大阪</option>
                            <option value="Other">其他</option>
                        </select>

                        <div class="form-input-style flex items-center justify-between">
                            <label class="text-sm text-gray-700">想去/購買程度:</label>
                            <div class="text-xl text-kyoto-accent space-x-1">
                                <i v-for="n in 5" :key="n" @click="strategyForm.starRating = n"
                                    :class="{'fa-solid': n <= strategyForm.starRating, 'fa-regular': n > strategyForm.starRating}"
                                    class="fa-star cursor-pointer transition-colors"></i>
                            </div>
                        </div>

                        <textarea v-model="strategyForm.notes" placeholder="筆記/心得/攻略細節" rows="5"
                            class="form-input-style"></textarea>

                        <input type="url" v-model="strategyForm.infoLink" placeholder="攻略連結 (Blog, 官網)"
                            class="form-input-style">
                        <input type="url" v-model="strategyForm.mapLink" placeholder="導航前往連結 (Google Map)"
                            class="form-input-style">


                        <div class="pt-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">攻略圖片 (選填)</label>
                            <input type="file" @change="handleStrategyImage"
                                class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-kyoto-bg file:text-kyoto-primary hover:file:bg-kyoto-secondary/10">
                            <img v-if="strategyForm.imageUrl" :src="strategyForm.imageUrl" alt="預覽"
                                class="mt-2 w-full h-24 object-cover rounded-lg">
                        </div>
                    </div>
                    <div class="flex gap-3 mt-4">
                        <button v-if="isStrategyEditMode"
                            @click="deleteStrategyItem(strategyForm.id); closeModal('strategy')"
                            class="flex-1 bg-red-100 text-red-500 py-3 rounded-xl font-bold">刪除</button>
                        <button @click="closeModal('strategy')"
                            class="flex-1 bg-gray-200 text-gray-600 py-3 rounded-xl font-bold">取消</button>
                        <button @click="saveStrategy"
                            class="flex-1 bg-kyoto-primary text-white py-3 rounded-xl font-bold">確認</button>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="modal">
            <div v-if="showModal.exchange" class="fixed inset-0 bg-black/50 z-50 flex items-end justify-center p-4">
                <div class="bg-white w-full max-w-md rounded-2xl p-6 modal-content">
                    <h3 class="text-xl font-bold mb-4">匯率設定</h3>
                    <div class="space-y-3">
                        <div class="flex items-center space-x-3">
                            <input type="text" v-model="exchange.fromCurrency" placeholder="來源幣種 (例如: TWD)"
                                class="form-input-style w-1/3 text-center font-bold">
                            <span class="text-lg font-bold">=</span>
                            <input type="number" v-model.number="exchange.rate" placeholder="匯率數值 (例如: 4.6)"
                                class="form-input-style w-1/3 text-center">
                            <input type="text" v-model="exchange.toCurrency" placeholder="目標幣種 (例如: JPY)"
                                class="form-input-style w-1/3 text-center font-bold">
                        </div>
                        <div class="text-sm text-gray-600">設定格式為：1 [來源幣種] = [匯率數值] [目標幣種]</div>
                    </div>
                    <div class="flex gap-3 mt-4">
                        <button @click="closeModal('exchange')"
                            class="flex-1 bg-gray-200 text-gray-600 py-3 rounded-xl font-bold">取消</button>
                        <button @click="saveExchange"
                            class="flex-1 bg-kyoto-primary text-white py-3 rounded-xl font-bold">儲存</button>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="modal">
            <div v-if="showModal.expense" class="fixed inset-0 bg-black/50 z-50 flex items-end justify-center p-4">
                <div class="bg-white w-full max-w-md rounded-2xl p-6 modal-content">
                    <h3 class="text-xl font-bold mb-4">{{ isExpenseEditMode ? '編輯花費' : '新增花費' }}</h3>
                    <div class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                        <input type="text" v-model="expenseForm.name" placeholder="消費名稱 (例如：拉麵午餐)"
                            class="form-input-style">
                        <input type="number" v-model.number="expenseForm.amount" placeholder="金額 (日圓)"
                            class="form-input-style">
                        <input type="date" v-model="expenseForm.date" class="form-input-style">

                        <select v-model="expenseForm.category" class="form-input-style">
                            <option value="food">飲食</option>
                            <option value="shopping">購物</option>
                            <option value="transport">交通</option>
                            <option value="attraction">門票/景點</option>
                            <option value="accommodation">住宿</option>
                            <option value="other">其他</option>
                        </select>

                        <select v-model="expenseForm.method" class="form-input-style">
                            <option value="cash">現金 (Cash)</option>
                            <option value="card">信用卡/電子支付 (Card)</option>
                        </select>
                        <input type="text" v-model="expenseForm.notes" placeholder="備註" class="form-input-style">
                    </div>
                    <div class="flex gap-3 mt-4">
                        <button v-if="isExpenseEditMode"
                            @click="deleteExpenseItem(expenseForm.id); closeModal('expense')"
                            class="flex-1 bg-red-100 text-red-500 py-3 rounded-xl font-bold">刪除</button>
                        <button @click="closeModal('expense')"
                            class="flex-1 bg-gray-200 text-gray-600 py-3 rounded-xl font-bold">取消</button>
                        <button @click="saveExpense"
                            class="flex-1 bg-kyoto-primary text-white py-3 rounded-xl font-bold">確認</button>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="modal">
            <div v-if="showModal.infoEdit" class="fixed inset-0 bg-black/50 z-50 flex items-end justify-center p-4">
                <div class="bg-white w-full max-w-md rounded-2xl p-6 modal-content">
                    <h3 class="text-xl font-bold mb-4">編輯 {{ infoEditTargetLabel }}</h3>
                    <textarea v-model="infoForms[infoEditTarget].content" placeholder="在此輸入內容..." rows="10"
                        class="form-input-style"></textarea>
                    <div class="flex gap-3 mt-4">
                        <button @click="closeModal('infoEdit')"
                            class="flex-1 bg-gray-200 text-gray-600 py-3 rounded-xl font-bold">取消</button>
                        <button @click="saveInfoEdit"
                            class="flex-1 bg-kyoto-primary text-white py-3 rounded-xl font-bold">儲存</button>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="modal">
            <div v-if="showModal.hotel" class="fixed inset-0 bg-black/50 z-50 flex items-end justify-center p-4">
                <div class="bg-white w-full max-w-md rounded-2xl p-6 modal-content">
                    <h3 class="text-xl font-bold mb-4">{{ isHotelEditMode ? '編輯住宿資訊' : '新增住宿資訊' }}</h3>
                    <div class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                        <input type="text" v-model="hotelForm.name" placeholder="飯店名稱" class="form-input-style">
                        <input type="text" v-model="hotelForm.period" placeholder="入住/退房日期 (例如：3/6 - 3/8)"
                            class="form-input-style">
                        <input type="tel" v-model="hotelForm.phone" placeholder="電話" class="form-input-style">
                        <input type="text" v-model="hotelForm.address" placeholder="地址" class="form-input-style">
                        <input type="url" v-model="hotelForm.mapLink" placeholder="導航連結 (Google Map)"
                            class="form-input-style">
                    </div>
                    <div class="flex gap-3 mt-4">
                        <button v-if="isHotelEditMode" @click="deleteHotel(editingHotelIndex); closeModal('hotel');"
                            class="flex-1 bg-red-100 text-red-500 py-3 rounded-xl font-bold">刪除</button>
                        <button @click="closeModal('hotel')" class="flex-1 bg-gray-200 py-3 rounded-xl">取消</button>
                        <button @click="saveHotel"
                            class="flex-1 bg-kyoto-primary text-white py-3 rounded-xl">儲存</button>
                    </div>
                </div>
            </div>
        </transition>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                // --- 常數設定 ---
                const LOCAL_STORAGE_KEY = 'kyotoTripData_V7'; // 更改版本號 V7
                const INITIAL_DAYS = 5; // 預設行程天數
                const DEFAULT_IMAGE = 'https://i.imgur.com/Gj9X7qL.jpeg'; // 預設圖片連結

                // --- 響應式數據 (State) ---
                const headerImage = ref(DEFAULT_IMAGE);
                const currentTab = ref('itinerary');
                const showModal = ref({
                    itinerary: false,
                    strategy: false,
                    expense: false,
                    infoEdit: false,
                    hotel: false,
                    exchange: false // 新增匯率設定 Modal
                });

                // UI 相關設定 (調整 Tab 順序與名稱)
                const tabs = [
                    { id: 'itinerary', icon: 'fa-solid fa-map-location-dot', label: '行程' },
                    { id: 'strategy', icon: 'fa-solid fa-book-reader', label: '攻略' }, // 許願清單改為攻略 (需求 8)
                    { id: 'expense', icon: 'fa-solid fa-yen-sign', label: '花費' },
                    { id: 'hotel', icon: 'fa-solid fa-hotel', label: '住宿' },
                    { id: 'info', icon: 'fa-solid fa-circle-info', label: '資訊' }
                ];


                // --- 行程規劃 (Itinerary) ---
                const itineraryData = ref([]);
                const currentDayIndex = ref(0);
                const form = ref({}); // 行程表單
                const isEditMode = ref(false);
                const editingId = ref(null);
                const itineraryLocationFilter = ref(''); // 需求 9: 行程地點篩選器


                // --- 攻略規劃 (Strategy) (取代許願清單) ---
                const strategyList = ref([]);
                const strategyForm = ref({});
                const isStrategyEditMode = ref(false);
                const strategyFilter = ref(''); // 類別篩選
                const strategyLocationFilter = ref(''); // 需求 9: 地點篩選 (京都/大阪)
                const strategyCategories = {
                    attraction: { label: '景點', color: 'bg-red-500', cardClass: 'text-red-700 bg-red-100' },
                    food: { label: '美食', color: 'bg-orange-500', cardClass: 'text-orange-700 bg-orange-100' },
                    'shopping-place': { label: '購物地點', color: 'bg-pink-500', cardClass: 'text-pink-700 bg-pink-100' },
                    'good-item': { label: '好物推薦', color: 'bg-teal-500', cardClass: 'text-teal-700 bg-teal-100' },
                    traffic: { label: '交通/票券', color: 'bg-blue-500', cardClass: 'text-blue-700 bg-blue-100' },
                    other: { label: '其他', color: 'bg-gray-500', cardClass: 'text-gray-700 bg-gray-100' }
                };


                // --- 匯率計算機 (Calculator) ---
                const exchange = ref({
                    rate: 4.60,
                    fromCurrency: 'TWD',
                    toCurrency: 'JPY',
                });
                const currentInput = ref(''); // 需求 1: 預設空白


                // --- 花費紀錄 (Expense) ---
                const expenses = ref([]);
                const expenseForm = ref({ id: null, category: 'food', name: '', date: new Date().toISOString().split('T')[0], amount: null, method: 'cash', notes: '' });
                const isExpenseEditMode = ref(false);
                const editingExpenseId = ref(null);


                // --- 資訊頁面 (Info) ---
                const checklist = ref([]);
                const newChecklistItem = ref('');
                const infoEditMode = ref({ checklist: false });
                const infoForms = ref({
                    passport: { label: '護照/簽證資訊', content: '' },
                    tickets: { label: '交通/票券預訂', content: '' },
                    insurance: { label: '旅遊保險', content: '' },
                    notes: { label: '重要筆記', content: '' }
                });
                const infoEditTarget = ref(null);
                const infoEditTargetLabel = ref('');


                // --- 住宿資訊 (Hotel) ---
                const hotelList = ref([]);
                const hotelForm = ref({});
                const isHotelEditMode = ref(false);
                const editingHotelIndex = ref(null);

                // --- 方法 Methods ---

                // Helper: 儲存至 LocalStorage
                const saveToLocal = () => {
                    const data = {
                        headerImage: headerImage.value,
                        itineraryData: itineraryData.value,
                        strategyList: strategyList.value,
                        exchange: exchange.value,
                        expenses: expenses.value,
                        checklist: checklist.value,
                        infoForms: infoForms.value,
                        hotelList: hotelList.value,
                    };
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(data));
                };

                // Helper: 載入 LocalStorage
                const loadFromLocal = () => {
                    const data = localStorage.getItem(LOCAL_STORAGE_KEY);
                    if (data) {
                        const parsedData = JSON.parse(data);
                        headerImage.value = parsedData.headerImage || DEFAULT_IMAGE;
                        itineraryData.value = parsedData.itineraryData || [];
                        strategyList.value = parsedData.strategyList || [];
                        exchange.value = parsedData.exchange || exchange.value;
                        expenses.value = parsedData.expenses || [];
                        checklist.value = parsedData.checklist || [];
                        infoForms.value = parsedData.infoForms || infoForms.value;
                        hotelList.value = parsedData.hotelList || [];
                    }
                };

                // 圖片上傳
                const uploadHeader = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => headerImage.value = event.target.result;
                        reader.readAsDataURL(file);
                        saveToLocal();
                    }
                };
                const handleItineraryImage = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => form.value.imageUrl = event.target.result;
                        reader.readAsDataURL(file);
                    }
                };
                const handleStrategyImage = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => strategyForm.value.imageUrl = event.target.result;
                        reader.readAsDataURL(file);
                    }
                };


                // 打開/初始化模態框
                const openModal = (target, item = null) => {
                    showModal.value[target] = true;
                    if (target === 'itinerary') {
                        if (item) {
                            // 編輯模式
                            isEditMode.value = true;
                            editingId.value = item.id;
                            form.value = { ...item };
                        } else {
                            // 新增模式 (新增 stayDuration 欄位)
                            isEditMode.value = false;
                            form.value = {
                                id: Date.now(),
                                location: '',
                                name: '',
                                startTime: '10:00', // 需求 5: 24 小時制預設時間
                                stayDuration: '', // 需求 5: 新增停留時間
                                description: '',
                                category: 'attraction',
                                transport: 'walk',
                                duration: '',
                                mapLink: '',
                                imageUrl: ''
                            };
                        }
                    } else if (target === 'exchange') {
                        // 需求 7: 重設輸入框
                        currentInput.value = '';
                    }
                };

                // 關閉模態框
                const closeModal = (target) => {
                    showModal.value[target] = false;
                    // 重置所有編輯狀態和表單 (避免殘留數據)
                    isEditMode.value = false;
                    isStrategyEditMode.value = false;
                    isExpenseEditMode.value = false;
                    isHotelEditMode.value = false;

                    // 重置表單 (避免數據污染)
                    form.value = {};
                    strategyForm.value = {};
                    expenseForm.value = { id: null, category: 'food', name: '', date: new Date().toISOString().split('T')[0], amount: null, method: 'cash', notes: '' };
                    hotelForm.value = {};
                };

                // 行程：儲存
                const saveItinerary = () => {
                    if (!form.value.location || !form.value.name) return alert('請填寫地點和活動名稱');

                    const newDayIndex = currentDayIndex.value;
                    const newItem = { ...form.value };

                    if (isEditMode.value) {
                        // 編輯現有項目
                        const dayData = itineraryData.value[newDayIndex];
                        const itemIndex = dayData.items.findIndex(i => i.id === editingId.value);
                        if (itemIndex !== -1) {
                            dayData.items[itemIndex] = newItem;
                        }
                    } else {
                        // 新增項目到當前天數
                        itineraryData.value[newDayIndex].items.push(newItem);
                    }

                    // 排序：按時間排序
                    itineraryData.value[newDayIndex].items.sort((a, b) => (a.startTime || '00:00').localeCompare(b.startTime || '00:00'));

                    saveToLocal();
                    closeModal('itinerary');
                };

                // 行程：刪除
                const deleteItem = (idToDelete) => {
                    if (!confirm('確定刪除此行程項目嗎？')) return;
                    const dayData = itineraryData.value[currentDayIndex.value];
                    dayData.items = dayData.items.filter(item => item.id !== idToDelete);
                    saveToLocal();
                };

                // 行程：編輯
                const editItem = (idToEdit) => {
                    const dayData = itineraryData.value[currentDayIndex.value];
                    const item = dayData.items.find(i => i.id === idToEdit);
                    if (item) {
                        openModal('itinerary', item);
                    }
                };

                // 行程：打開地圖
                const openMap = (url, name) => {
                    if (url) {
                        window.open(url, '_blank');
                    } else {
                        alert(`「${name}」沒有提供地圖連結`);
                    }
                };

                // 攻略：打開/初始化 Modal
                const openStrategyModal = (item = null) => {
                    showModal.value.strategy = true;
                    if (item) {
                        isStrategyEditMode.value = true;
                        strategyForm.value = { ...item };
                    } else {
                        isStrategyEditMode.value = false;
                        strategyForm.value = {
                            id: Date.now(),
                            title: '',
                            category: 'attraction',
                            location: 'Kyoto', // 需求 9: 預設地點
                            notes: '',
                            mapLink: '', // 需求 10: 導航連結
                            infoLink: '', // 需求 10: 攻略連結
                            starRating: 3, // 需求 10: 預設星級
                            imageUrl: ''
                        };
                    }
                };

                // 攻略：儲存
                const saveStrategy = () => {
                    if (!strategyForm.value.title || !strategyForm.value.category) return alert('請填寫標題和類別');

                    if (isStrategyEditMode.value) {
                        const index = strategyList.value.findIndex(item => item.id === strategyForm.value.id);
                        if (index !== -1) {
                            strategyList.value[index] = { ...strategyForm.value };
                        }
                    } else {
                        strategyList.value.push({ ...strategyForm.value });
                    }
                    saveToLocal();
                    closeModal('strategy');
                };

                // 攻略：編輯
                const editStrategy = (idToEdit) => {
                    const item = strategyList.value.find(i => i.id === idToEdit);
                    if (item) {
                        openStrategyModal(item);
                    }
                };

                // 攻略：刪除
                const removeStrategy = (idToDelete) => {
                    if (!confirm('確定刪除此攻略筆記嗎？')) return;
                    strategyList.value = strategyList.value.filter(item => item.id !== idToDelete);
                    saveToLocal();
                };

                // 攻略：實際刪除項目 (從 Modal 內觸發)
                const deleteStrategyItem = (idToDelete) => {
                    if (!confirm('確定刪除此攻略筆記嗎？')) return;
                    strategyList.value = strategyList.value.filter(item => item.id !== idToDelete);
                    saveToLocal();
                };


                // 匯率設定：儲存 (需求 7)
                const saveExchange = () => {
                    if (!exchange.value.rate || exchange.value.rate <= 0) return alert('請輸入有效的匯率數值');
                    saveToLocal();
                    closeModal('exchange');
                };


                // 花費：打開/初始化 Modal
                const openExpenseModal = (item = null) => {
                    showModal.value.expense = true;
                    if (item) {
                        isExpenseEditMode.value = true;
                        expenseForm.value = { ...item };
                    } else {
                        isExpenseEditMode.value = false;
                        expenseForm.value = { id: Date.now(), category: 'food', name: '', date: new Date().toISOString().split('T')[0], amount: null, method: 'cash', notes: '' };
                    }
                };

                // 花費：儲存
                const saveExpense = () => {
                    if (!expenseForm.value.name || !expenseForm.value.amount) return alert('請填寫名稱和金額');

                    const newExpense = { ...expenseForm.value, amount: parseFloat(expenseForm.value.amount) };

                    if (isExpenseEditMode.value) {
                        const index = expenses.value.findIndex(item => item.id === newExpense.id);
                        if (index !== -1) {
                            expenses.value[index] = newExpense;
                        }
                    } else {
                        expenses.value.push(newExpense);
                    }
                    saveToLocal();
                    closeModal('expense');
                };

                // 花費：編輯
                const editExpense = (item) => {
                    openExpenseModal(item);
                };

                // 花費：刪除
                const deleteExpenseItem = (idToDelete) => {
                    if (!confirm('確定刪除此筆花費嗎？')) return;
                    expenses.value = expenses.value.filter(item => item.id !== idToDelete);
                    saveToLocal();
                };

                // 資訊：打開編輯 Modal
                const openInfoEditModal = (targetKey) => {
                    infoEditTarget.value = targetKey;
                    infoEditTargetLabel.value = infoForms.value[targetKey].label;
                    showModal.value.infoEdit = true;
                };

                // 資訊：儲存編輯
                const saveInfoEdit = () => {
                    saveToLocal();
                    closeModal('infoEdit');
                };

                // 資訊：新增 CheckList 項目
                const addChecklistItem = () => {
                    if (newChecklistItem.value.trim() !== '') {
                        checklist.value.push({ text: newChecklistItem.value.trim(), done: false });
                        newChecklistItem.value = '';
                        saveToLocal();
                    }
                };

                // 資訊：移除 CheckList 項目
                const removeChecklistItem = (index) => {
                    checklist.value.splice(index, 1);
                    saveToLocal();
                };

                // 住宿：打開/初始化 Modal
                const openHotelModal = (item = null, index = null) => {
                    showModal.value.hotel = true;
                    if (item) {
                        isHotelEditMode.value = true;
                        editingHotelIndex.value = index;
                        hotelForm.value = { ...item };
                    } else {
                        isHotelEditMode.value = false;
                        hotelForm.value = {
                            id: Date.now(),
                            name: '',
                            period: '',
                            phone: '',
                            address: '',
                            mapLink: ''
                        };
                    }
                };

                // 住宿：儲存
                const saveHotel = () => {
                    if (!hotelForm.value.name) return alert('請填寫飯店名稱');

                    if (isHotelEditMode.value) {
                        hotelList.value[editingHotelIndex.value] = { ...hotelForm.value };
                    } else {
                        hotelList.value.push({ ...hotelForm.value });
                    }
                    saveToLocal();
                    closeModal('hotel');
                };

                // 住宿：刪除
                const deleteHotel = (indexToDelete) => {
                    if (!confirm('確定刪除此住宿資訊嗎？')) return;
                    hotelList.value.splice(indexToDelete, 1);
                    saveToLocal();
                };


                // --- 計算屬性 Computed ---

                // 天數計算
                const tripDays = computed(() => {
                    const days = [];
                    for (let i = 0; i < INITIAL_DAYS; i++) {
                        const date = new Date();
                        date.setDate(date.getDate() + i);
                        const month = date.getMonth() + 1;
                        const day = date.getDate();
                        const weekDays = ['日', '一', '二', '三', '四', '五', '六'];
                        days.push({
                            date: day,
                            month: month,
                            weekDay: weekDays[date.getDay()],
                            fullDate: date.toISOString().split('T')[0]
                        });
                    }
                    return days;
                });

                // 行程：按時間分組 (需求 4)
                const groupedItinerary = computed(() => {
                    if (!itineraryData.value[currentDayIndex.value]) return [];

                    const items = itineraryData.value[currentDayIndex.value].items
                        .filter(item => !itineraryLocationFilter.value || item.location === itineraryLocationFilter.value);

                    const groups = {
                        morning: { label: '上午 (00:00 - 12:00)', items: [] },
                        afternoon: { label: '下午 (12:00 - 18:00)', items: [] },
                        evening: { label: '晚上 (18:00 - 24:00)', items: [] },
                    };

                    const locationMap = {};

                    items.forEach(item => {
                        const time = item.startTime || '00:00';
                        const hour = parseInt(time.split(':')[0]);
                        let groupKey;

                        if (hour >= 0 && hour < 12) {
                            groupKey = 'morning';
                        } else if (hour >= 12 && hour < 18) {
                            groupKey = 'afternoon';
                        } else {
                            groupKey = 'evening';
                        }

                        // 內部按地點分組
                        if (!locationMap[item.location]) {
                            // expanded: true 預設展開
                            locationMap[item.location] = { location: item.location, items: [], expanded: true };
                        }
                        locationMap[item.location].items.push(item);
                    });

                    // 將地點分組結果分配給時間段 (以該地點第一個行程時間為準)
                    Object.values(locationMap).forEach(locationGroup => {
                        // 確保地點內部行程按時間排序
                        locationGroup.items.sort((a, b) => (a.startTime || '00:00').localeCompare(b.startTime || '00:00'));

                        const firstItemTime = locationGroup.items[0].startTime || '00:00';
                        const firstItemHour = parseInt(firstItemTime.split(':')[0]);
                        let groupKey;

                        if (firstItemHour >= 0 && firstItemHour < 12) {
                            groupKey = 'morning';
                        } else if (firstItemHour >= 12 && firstItemHour < 18) {
                            groupKey = 'afternoon';
                        } else {
                            groupKey = 'evening';
                        }

                        groups[groupKey].items.push(locationGroup);
                    });

                    // 確保時間段內的地點也是按最早時間排序
                    Object.values(groups).forEach(group => {
                        group.items.sort((a, b) => (a.items[0].startTime || '00:00').localeCompare(b.items[0].startTime || '00:00'));
                    });


                    return groups;
                });

                // 行程：獲取當前天數所有不重複地點
                const uniqueLocations = computed(() => {
                    if (!itineraryData.value[currentDayIndex.value]) return [];
                    const locations = itineraryData.value[currentDayIndex.value].items.map(item => item.location);
                    return [...new Set(locations)];
                });


                // 攻略：篩選列表
                const filteredStrategyList = computed(() => {
                    return strategyList.value.filter(item => {
                        const categoryMatch = !strategyFilter.value || item.category === strategyFilter.value;
                        const locationMatch = !strategyLocationFilter.value || item.location === strategyLocationFilter.value;
                        return categoryMatch && locationMatch;
                    });
                });

                // 攻略：分類統計卡片數 (需求 8)
                const strategyStats = computed(() => {
                    const stats = {};
                    Object.keys(strategyCategories).forEach(key => {
                        stats[key] = { count: 0 };
                    });

                    strategyList.value.forEach(item => {
                        if (stats[item.category]) {
                            stats[item.category].count++;
                        }
                    });
                    return stats;
                });

                // 花費：總金額
                const totalExpense = computed(() => {
                    return expenses.value.reduce((sum, item) => sum + item.amount, 0);
                });

                // 匯率：計算結果 (需求 7)
                const calculatorResult = computed(() => {
                    const inputVal = parseFloat(currentInput.value);
                    if (isNaN(inputVal) || currentInput.value.trim() === '') return '';
                    let result;

                    // 假設 rate 是 1 fromCurrency = rate toCurrency
                    if (exchange.value.fromCurrency === 'TWD' && exchange.value.toCurrency === 'JPY') {
                        result = inputVal * exchange.value.rate;
                    } else if (exchange.value.fromCurrency === 'JPY' && exchange.value.toCurrency === 'TWD') {
                        result = inputVal / exchange.value.rate;
                    } else if (exchange.value.fromCurrency === exchange.value.toCurrency) {
                        result = inputVal;
                    } else {
                        // 其他複雜幣種兌換，暫時只支持 TWD <-> JPY，其他預設為 1:1
                        result = inputVal;
                    }

                    // 格式化輸出
                    return result.toLocaleString('en-US', {
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 2
                    });
                });


                // --- 匯率計算機方法 (需求 7) ---
                const clearInput = () => currentInput.value = ''; // 預設空白
                const deleteDigit = () => {
                    currentInput.value = currentInput.value.slice(0, -1);
                };
                const appendDigit = (digit) => {
                    currentInput.value += digit;
                };
                const appendDecimal = () => {
                    if (!currentInput.value.includes('.')) {
                        currentInput.value += '.';
                    }
                };
                const toggleSign = () => {
                    if (currentInput.value !== '' && currentInput.value !== '0') {
                        if (currentInput.value.startsWith('-')) {
                            currentInput.value = currentInput.value.substring(1);
                        } else {
                            currentInput.value = '-' + currentInput.value;
                        }
                    }
                };
                const swapCurrencies = () => {
                    [exchange.value.fromCurrency, exchange.value.toCurrency] = [exchange.value.toCurrency, exchange.value.fromCurrency];
                    currentInput.value = ''; // 清空輸入
                    saveToLocal();
                };


                // --- 輔助顯示方法 (Helper Display Methods) ---
                const getCategoryColor = (category) => {
                    switch (category) {
                        case 'attraction': return 'border-l-4 border-red-500 bg-red-50';
                        case 'food': return 'border-l-4 border-orange-500 bg-orange-50';
                        case 'shopping': return 'border-l-4 border-pink-500 bg-pink-50';
                        case 'other':
                        default: return 'border-l-4 border-gray-500 bg-gray-50';
                    }
                };
                // 需求 5: 交通工具 icon
                const getTransportIcon = (transport) => {
                    switch (transport) {
                        case 'walk': return 'fa-solid fa-person-walking';
                        case 'train': return 'fa-solid fa-train-subway';
                        case 'bus': return 'fa-solid fa-bus';
                        case 'taxi': return 'fa-solid fa-taxi';
                        case 'plane': return 'fa-solid fa-plane';
                        default: return 'fa-solid fa-circle-question';
                    }
                };
                const getExpenseIcon = (category) => {
                    switch (category) {
                        case 'food': return { icon: 'fa-solid fa-bowl-food', color: 'bg-orange-500' };
                        case 'shopping': return { icon: 'fa-solid fa-bag-shopping', color: 'bg-pink-500' };
                        case 'transport': return { icon: 'fa-solid fa-route', color: 'bg-blue-500' };
                        case 'attraction': return { icon: 'fa-solid fa-ticket', color: 'bg-red-500' };
                        case 'accommodation': return { icon: 'fa-solid fa-hotel', color: 'bg-kyoto-primary' };
                        case 'other':
                        default: return { icon: 'fa-solid fa-ellipsis', color: 'bg-gray-500' };
                    }
                };


                // --- 生命週期與監聽 ---

                // 確保天數數據結構初始化
                const initializeItinerary = () => {
                    const daysCount = tripDays.value.length;
                    while (itineraryData.value.length < daysCount) {
                        itineraryData.value.push({
                            day: itineraryData.value.length + 1,
                            items: []
                        });
                    }
                };


                onMounted(() => {
                    loadFromLocal();
                    initializeItinerary();
                });

                // 監聽所有核心數據變動，自動保存
                watch([checklist, infoForms, expenses, strategyList, hotelList, headerImage, exchange], () => {
                    saveToLocal();
                }, { deep: true });

                // 天氣 iframe 連結 (需求 3)
                const weatherIframeSrc = computed(() => {
                    // 使用京都 (Kyoto) 的 AccuWeather 連結，確保 HTTPS 且嵌入相容
                    return 'https://www.accuweather.com/en/jp/kyoto/224967/current-weather/224967?lang=zh-tw&partner=iframe';
                });


                return {
                    // State
                    currentTab, tabs, headerImage, uploadHeader, weatherIframeSrc,

                    // Itinerary
                    tripDays, currentDayIndex, groupedItinerary, uniqueLocations, itineraryLocationFilter,
                    itineraryData, showModal, form, isEditMode,
                    saveItinerary, deleteItem, editItem, openModal, closeModal, openMap, handleItineraryImage,
                    getCategoryColor, getTransportIcon,

                    // Calculator / Exchange
                    exchange, currentInput, calculatorResult, clearInput, deleteDigit, appendDigit, appendDecimal, toggleSign, swapCurrencies, saveExchange,

                    // Expense
                    expenses, totalExpense, openExpenseModal, expenseForm, saveExpense, getExpenseIcon, editExpense, deleteExpenseItem, isExpenseEditMode,

                    // Strategy
                    strategyList, openStrategyModal, strategyForm, saveStrategy, editStrategy, removeStrategy, deleteStrategyItem, isStrategyEditMode, strategyCategories,
                    strategyFilter, filteredStrategyList, strategyLocationFilter, strategyStats,

                    // Info
                    infoEditMode, checklist, newChecklistItem, addChecklistItem, removeChecklistItem,
                    infoEditTarget, infoEditTargetLabel, openInfoEditModal, infoForms, saveInfoEdit,

                    // Hotel
                    hotelList, hotelForm, openHotelModal, saveHotel, deleteHotel, isHotelEditMode, editingHotelIndex
                };
            }
        }).mount('#app');
    </script>
</body>

</html>