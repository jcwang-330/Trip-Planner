<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KYOTO & OSAKA | Trip Planner</title>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght=300;400;500;700;900&display=swap"
        rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        kyoto: {
                            bg: '#F7F4EF',
                            primary: '#6A7F60',
                            secondary: '#8F7762',
                            accent: '#D48666',
                            dark: '#4A4036',
                            light: '#FFFFFF'
                        }
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(106, 127, 96, 0.15)',
                        'float': '0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1)',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #F7F4EF;
            font-family: 'Noto Sans TC', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .header-curve {
            border-radius: 30px 30px 0 0;
            margin-top: -30px;
            position: relative;
            z-index: 10;
            background-color: #F7F4EF;
        }

        /* 調整大標題樣式 */
        .page-title {
            font-size: 2.5rem;
            line-height: 1;
            font-weight: 900;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.7);
            letter-spacing: 0.1em;
        }

        /* Modal 從底部彈出動畫 */
        .modal-enter-active .modal-content,
        .modal-leave-active .modal-content {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }

        .modal-enter-from .modal-content,
        .modal-leave-to .modal-content {
            transform: translateY(100%);
            opacity: 0.5;
        }

        /* 側邊欄動畫 */
        .sidebar-enter-active,
        .sidebar-leave-active {
            transition: transform 0.3s ease-out;
        }

        .sidebar-enter-from,
        .sidebar-leave-to {
            transform: translateX(100%);
        }

        /* 浮動按鈕美化與位置調整 */
        .fab-button {
            transform: translateZ(0);
            z-index: 40;
        }

        /* 5. 時間軸樣式 */
        .timeline-wrapper {
            border-left: 2px solid #8F776230;
            /* 垂直時間軸線 */
            padding-left: 1rem;
            margin-left: 10px;
            /* 預留左側空間 */
        }

        .timeline-item {
            position: relative;
            margin-bottom: 2rem;
        }

        .timeline-dot {
            position: absolute;
            left: -18px;
            /* 剛好與線條對齊 */
            top: 4px;
            width: 16px;
            height: 16px;
            background-color: #F7F4EF;
            /* 點的背景色 */
            border: 3px solid #8F7762;
            /* 點的顏色 */
            border-radius: 50%;
            z-index: 2;
        }

        .timeline-item:last-child {
            margin-bottom: 0;
            /* 最後一個項目不要額外間距 */
        }

        .timeline-item:last-child .timeline-dot {
            border-color: #6A7F60;
            /* 最後一個點變綠色 */
        }

        /* 6. 交通分隔線樣式 */
        .traffic-divider {
            height: 100%;
            width: 100%;
            position: relative;
            z-index: 0;
            display: flex;
            justify-content: center;
            padding: 8px 0;
        }

        .traffic-line-segment {
            height: 100%;
            width: 1px;
            background-color: #8F776230;
            margin-top: 4px;
            /* 調整位置 */
        }

        /* 避免 Modal 彈出/關閉時，由於隱藏捲軸造成的內容橫向跳動 */
        .modal-open-prevent-shift {
            overflow: hidden;
            padding-right: 15px;
            /* 假設捲軸寬度為 15px，可依實際情況調整 */
        }

        /* 匯率計算機樣式 (新增或調整以符合整體風格) */
        .calculator-keypad button {
            transition: background-color 0.1s;
        }

        .calculator-keypad button:active {
            opacity: 0.8;
        }
    </style>
</head>

<body class="text-kyoto-dark">

    <div id="app" class="relative min-h-screen pb-[80px]">

        <header class="relative w-full h-[180px] md:h-[250px] overflow-hidden bg-gray-300">
            <img :src="headerImage" class="w-full h-full object-cover transition-all duration-300" alt="Kyoto Header">

            <input type="file" @change="uploadHeader" class="absolute inset-0 opacity-0 cursor-pointer z-30"
                title="點擊更換封面">

            <div class="absolute inset-0 flex items-end p-4 z-20">
                <h1 class="page-title text-white whitespace-nowrap">
                    KYOTO & OSAKA
                </h1>
            </div>
        </header>

        <main class="header-curve px-4 pt-6">

            <div v-if="currentTab === 'itinerary'">

                <div class="mb-4">
                    <label class="block text-sm font-medium text-kyoto-dark mb-1">篩選地點</label>
                    <select v-model="itineraryLocationFilter"
                        class="w-full p-2 bg-white rounded-xl border border-gray-200 text-sm">
                        <option :value="null">全部地點</option>
                        <option v-for="loc in locations" :key="loc" :value="loc">{{ loc }}</option>
                    </select>
                </div>

                <div class="flex overflow-x-auto hide-scrollbar space-x-3 mb-6 pb-2">
                    <div v-for="(day, index) in tripDays" :key="index" @click="currentDayIndex = index"
                        :class="['flex-shrink-0 w-20 h-20 rounded-2xl flex flex-col items-center justify-center cursor-pointer transition-colors',
                                  currentDayIndex === index ? 'bg-kyoto-secondary text-white shadow-lg' : 'bg-white text-kyoto-secondary']">
                        <span class="text-xs opacity-80">Day {{ index + 1 }}</span>
                        <span class="text-2xl font-bold">{{ day.date }}</span>
                    </div>
                </div>

                <div class="timeline-wrapper pb-4">
                    <template v-for="(items, key) in groupedItinerary" :key="key">
                        <div v-if="items.length > 0 && key !== 'unspecified'"
                            class="sticky top-0 z-10 -ml-4 pl-4 py-2 my-2 rounded-lg text-sm font-bold"
                            :class="key === 'morning' ? 'text-kyoto-primary bg-kyoto-primary/10' : key === 'afternoon' ? 'text-kyoto-accent bg-kyoto-accent/10' : 'text-kyoto-dark bg-gray-200'">
                            {{ timeGroups[key].label.split(' ')[0] }}
                        </div>

                        <div v-for="(item, index) in items" :key="item.id" class="timeline-item group">

                            <div class="timeline-dot"></div>

                            <div class="bg-white rounded-2xl p-4 shadow-soft relative overflow-hidden">
                                <div class="flex justify-between items-start mb-2">
                                    <span class="font-bold text-sm text-white px-3 py-1 rounded-full"
                                        :class="getCategoryColor(item.category)">
                                        {{ getCategoryLabel(item.category) }}
                                    </span>
                                    <div class="flex gap-2" @click.stop>
                                        <button @click="editItem(item, index)"
                                            class="text-gray-400 hover:text-kyoto-accent"><i
                                                class="fa-solid fa-pen"></i></button>
                                        <button @click="deleteItem(item.id)" class="text-gray-400 hover:text-red-500"><i
                                                class="fa-solid fa-xmark"></i></button>
                                    </div>
                                </div>

                                <div v-if="item.image" class="w-full h-32 bg-gray-100 rounded-lg overflow-hidden mb-3">
                                    <img :src="item.image" class="w-full h-full object-cover" alt="行程圖片">
                                </div>

                                <h3 class="font-bold text-xl text-kyoto-dark">{{ item.name }}</h3>

                                <div class="text-sm text-gray-500 mt-2 space-y-1">
                                    <p v-if="item.startTime || item.durationMinutes">
                                        <i class="fa-regular fa-clock w-5 text-center"></i>
                                        <span v-if="item.startTime" class="mr-2 font-medium text-kyoto-secondary">{{
                                            item.startTime }}</span>
                                        <span v-if="item.durationMinutes"> (停留 {{ item.durationMinutes }} 分鐘)</span>
                                    </p>
                                    <p v-if="item.category === 'flight'">
                                        <i class="fa-solid fa-plane-departure w-5 text-center"></i> {{ item.flightTime
                                        ||
                                        '時間待定' }}
                                    </p>
                                    <p v-if="item.ticket && item.category === 'attraction'"><i
                                            class="fa-solid fa-ticket w-5 text-center"></i> {{ item.ticket }}</p>
                                    <p v-if="item.notes" class="text-kyoto-accent mt-2 text-xs"><i
                                            class="fa-regular fa-note-sticky w-5 text-center"></i> {{ item.notes }}</p>
                                    <p class="text-xs text-gray-400 mt-1">
                                        <i class="fa-solid fa-location-dot w-5 text-center"></i> {{ item.location }}
                                    </p>
                                </div>

                                <button v-if="item.mapLink" @click.stop="openMap(item.mapLink, item.name)"
                                    class="mt-4 w-full bg-kyoto-bg text-kyoto-primary py-2 rounded-lg text-sm font-bold active:bg-kyoto-secondary/10 transition-colors">
                                    <i class="fa-solid fa-location-arrow mr-1"></i> 導航前往
                                </button>
                            </div>

                            <div v-if="index < items.length - 1" class="traffic-divider h-10">
                                <div class="traffic-line-segment absolute inset-0 top-0 bottom-0 left-[7px]"></div>
                                <div
                                    class="bg-kyoto-bg rounded-xl py-1 px-3 relative z-10 shadow-sm flex items-center gap-1 text-kyoto-secondary font-medium">
                                    <i :class="getTransportIcon(items[index+1].transportType)" class="text-sm"></i>
                                    <span class="text-xs">約 {{ items[index+1].travelTime }} 分鐘</span>
                                </div>
                            </div>
                        </div>
                    </template>

                    <div v-if="currentDayItinerary.length === 0" class="text-center text-gray-400 py-10">
                        <i class="fa-solid fa-map-location-dot text-4xl mb-3"></i>
                        <p>尚無行程，點擊右下角新增</p>
                    </div>
                </div>

                <button @click="openModal()"
                    class="fixed bottom-[90px] right-6 w-14 h-14 bg-kyoto-dark text-white rounded-full shadow-float flex items-center justify-center text-2xl fab-button active:scale-95 transition-transform">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <div v-if="currentTab === 'strategy'" class="pb-4">

                <div class="mb-4">
                    <label class="block text-sm font-medium text-kyoto-dark mb-1">篩選地點</label>
                    <select v-model="strategyLocationFilter"
                        class="w-full p-2 bg-white rounded-xl border border-gray-200 text-sm">
                        <option :value="null">全部地點</option>
                        <option v-for="loc in locations" :key="loc" :value="loc">{{ loc }}</option>
                    </select>
                </div>

                <div class="flex overflow-x-auto hide-scrollbar space-x-2 mb-6">
                    <button @click="strategyFilter = null"
                        :class="['flex-shrink-0 px-4 py-1 rounded-full text-sm transition-all', strategyFilter === null ? 'bg-kyoto-secondary text-white shadow-md' : 'bg-white text-gray-600 border border-gray-200']">
                        全部 ({{ strategyList.length }})
                    </button>
                    <button v-for="(cat, key) in strategyCategories" :key="key" @click="strategyFilter = key"
                        :class="['flex-shrink-0 px-4 py-1 rounded-full text-sm transition-all', strategyFilter === key ? 'bg-kyoto-primary text-white shadow-md' : 'bg-white text-gray-600 border border-gray-200']">
                        {{ cat.label }} ({{ strategyCategoryCounts[key] || 0 }})
                    </button>
                </div>

                <div class="space-y-4">
                    <div v-for="(strategy, index) in filteredStrategyList" :key="strategy.id"
                        class="bg-white rounded-2xl p-4 shadow-soft relative flex gap-3 items-start">
                        <div class="absolute top-0 left-0 w-1.5 h-full rounded-tl-2xl rounded-bl-2xl"
                            :class="getCategoryColor(strategy.category)"></div>
                        <div class="pl-2 flex-1">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-bold text-lg text-kyoto-dark">{{ strategy.name }}</h3>
                                <div class="flex gap-2">
                                    <button @click="openStrategyModal(strategy, index)"
                                        class="text-gray-400 hover:text-kyoto-accent"><i
                                            class="fa-solid fa-pen"></i></button>
                                    <button @click="removeStrategy(strategy.id)"
                                        class="text-gray-400 hover:text-red-500"><i
                                            class="fa-solid fa-xmark"></i></button>
                                </div>
                            </div>

                            <div class="text-sm text-gray-500">
                                <span class="inline-block px-2 py-0.5 text-xs rounded-full text-white"
                                    :class="getCategoryColor(strategy.category)">{{
                                    strategyCategories[strategy.category].label
                                    }}</span>

                                <span class="ml-2 px-2 py-0.5 text-xs rounded-full bg-gray-100 text-gray-600">{{
                                    strategy.location
                                    }}</span>

                                <div class="mt-2 flex items-center">
                                    <i v-for="n in 5" :key="n"
                                        :class="['fa-star mr-0.5', n <= strategy.rating ? 'fa-solid text-yellow-400' : 'fa-regular text-gray-300']"></i>
                                </div>

                                <p v-if="strategy.notes" class="mt-2 text-xs text-gray-600">{{ strategy.notes }}</p>
                            </div>

                            <div class="mt-3 flex gap-3 flex-wrap">
                                <a v-if="strategy.mapLink" :href="strategy.mapLink" target="_blank"
                                    class="inline-flex items-center text-kyoto-primary text-sm font-medium hover:underline">
                                    導航前往 <i class="fa-solid fa-location-arrow ml-1 text-xs"></i>
                                </a>
                                <a v-if="strategy.strategyLink" :href="strategy.strategyLink" target="_blank"
                                    class="inline-flex items-center text-kyoto-accent text-sm font-medium hover:underline">
                                    攻略連結 <i class="fa-solid fa-arrow-up-right-from-square ml-1 text-xs"></i>
                                </a>
                            </div>
                        </div>
                    </div>

                    <div v-if="filteredStrategyList.length === 0" class="text-center text-gray-400 py-10">
                        <i class="fa-solid fa-book-open-reader text-4xl mb-3"></i>
                        <p>此類別暫無攻略項目</p>
                    </div>
                </div>

                <button @click="openStrategyModal()"
                    class="fixed bottom-[90px] right-6 w-14 h-14 bg-kyoto-primary text-white rounded-full shadow-float flex items-center justify-center text-2xl fab-button">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <div v-if="currentTab === 'shopping'" class="pb-4">
                <div class="grid grid-cols-2 gap-4">
                    <div v-for="(item, index) in shoppingList" :key="index"
                        class="bg-white rounded-2xl p-3 shadow-soft flex flex-col relative">
                        <button @click="openShopEdit(index)"
                            class="absolute top-2 right-2 bg-gray-100 rounded-full w-6 h-6 flex items-center justify-center text-gray-400 hover:text-kyoto-accent"><i
                                class="fa-solid fa-pen text-sm"></i></button>

                        <div class="h-32 bg-gray-100 rounded-xl overflow-hidden mb-2 flex items-center justify-center">
                            <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                            <i v-else class="fa-solid fa-bag-shopping text-3xl text-gray-300"></i>
                        </div>

                        <div class="font-bold text-kyoto-dark truncate">{{ item.name }}</div>
                        <div class="text-xs text-gray-400 mt-1">
                            <span v-if="item.place" class="mr-2">{{ item.place }}</span>
                            {{ item.price ? '¥' + parseInt(item.price).toLocaleString() : '待定' }}
                        </div>
                        <a v-if="item.externalLink" :href="item.externalLink" target="_blank"
                            class="mt-1 text-xs text-kyoto-accent hover:underline">連結</a>
                    </div>

                    <div v-if="shoppingList.length === 0" class="col-span-2 text-center text-gray-400 py-10">
                        <i class="fa-solid fa-cart-shopping text-4xl mb-3"></i>
                        <p>購物車是空的，點擊右下角新增</p>
                    </div>
                </div>
                <button @click="openShopModal"
                    class="fixed bottom-[90px] right-6 w-14 h-14 bg-kyoto-accent text-white rounded-full shadow-float flex items-center justify-center text-2xl fab-button">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <div v-if="currentTab === 'expense'" class="pb-4 space-y-6">
                <div class="bg-kyoto-dark text-white rounded-2xl p-4 shadow-soft text-center">
                    <div class="text-sm opacity-80">總花費 (JPY)</div>
                    <div class="text-3xl font-bold mt-1">¥ {{ totalExpense.toLocaleString() }}</div>
                </div>

                <div class="space-y-3">
                    <div v-for="(exp, index) in expenses" :key="exp.id"
                        class="bg-white rounded-xl p-4 shadow-sm flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-10 h-10 rounded-full bg-kyoto-bg flex items-center justify-center text-kyoto-primary">
                                <i :class="getExpenseIcon(exp.category)"></i>
                            </div>
                            <div>
                                <div class="font-bold text-gray-800">{{ exp.name }}</div>
                                <div class="text-xs text-gray-400">{{ exp.date }} · {{ exp.method === 'cash' ? '現金' :
                                    '信用卡' }}</div>
                                <div v-if="exp.split" class="text-xs text-kyoto-secondary mt-0.5">
                                    <i class="fa-solid fa-user-group text-xs mr-1"></i>分帳: {{ exp.split }}
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button @click="editExpense(exp, index)" class="text-gray-400 hover:text-kyoto-accent"><i
                                    class="fa-solid fa-pen text-sm"></i></button>
                            <div class="font-bold text-kyoto-dark">¥ {{ parseInt(exp.amount).toLocaleString() }}</div>
                        </div>
                    </div>

                    <div v-if="expenses.length === 0" class="text-center text-gray-400 py-10">
                        <i class="fa-solid fa-yen-sign text-4xl mb-3"></i>
                        <p>點擊右下角新增記帳</p>
                    </div>
                </div>

                <button @click="openExpenseModal"
                    class="fixed bottom-[90px] right-6 w-14 h-14 bg-yellow-600 text-white rounded-full shadow-float flex items-center justify-center text-2xl fab-button">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <div v-if="currentTab === 'info'" class="pb-4 space-y-6">
                <section class="bg-white rounded-2xl p-4 shadow-soft">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-bold text-lg text-kyoto-dark">行前 Check List</h2>
                        <button @click="infoEditMode = !infoEditMode"
                            class="text-sm text-kyoto-primary hover:text-kyoto-accent">
                            <i :class="infoEditMode ? 'fa-solid fa-check' : 'fa-solid fa-pen'"></i> {{ infoEditMode ?
                            '完成' : '編輯' }}
                        </button>
                    </div>
                    <ul class="space-y-3">
                        <li v-for="(item, index) in checklist" :key="index"
                            class="flex items-center justify-between transition-colors p-2 rounded-lg"
                            :class="item.checked ? 'bg-kyoto-primary/5' : 'hover:bg-gray-50'">
                            <label class="flex items-center flex-1 cursor-pointer">
                                <input type="checkbox" v-model="item.checked" @change="saveToLocal"
                                    class="form-checkbox h-5 w-5 text-kyoto-primary rounded border-gray-300">
                                <span class="ml-3 text-sm"
                                    :class="item.checked ? 'line-through text-gray-500' : 'text-kyoto-dark'">{{
                                    item.text }}</span>
                            </label>
                            <button v-if="infoEditMode" @click="removeChecklistItem(index)"
                                class="text-red-400 hover:text-red-600 p-1"><i
                                    class="fa-solid fa-trash-can text-sm"></i></button>
                        </li>
                    </ul>
                    <div v-if="infoEditMode" class="mt-4 flex gap-2">
                        <input type="text" v-model="newChecklistItem" placeholder="新增待辦項目"
                            @keyup.enter="addChecklistItem" class="flex-1 p-2 border rounded-lg bg-gray-50 text-sm">
                        <button @click="addChecklistItem"
                            class="bg-kyoto-primary text-white px-4 py-2 rounded-lg text-sm font-bold">新增</button>
                    </div>
                </section>

                <section class="bg-white rounded-2xl p-4 shadow-soft space-y-3">
                    <h2 class="font-bold text-lg text-kyoto-dark">重要資訊</h2>
                    <div class="bg-gray-50 p-3 rounded-xl flex justify-between items-center cursor-pointer hover:bg-gray-100"
                        @click="openInfoEditModal('exchange')">
                        <div class="text-sm text-gray-500">當前匯率 (JPY:TWD)</div>
                        <div class="font-bold text-kyoto-dark">1 : {{ infoForms.exchange || '0.22' }}</div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-xl flex justify-between items-center cursor-pointer hover:bg-gray-100"
                        @click="openInfoEditModal('notes')">
                        <div class="text-sm text-gray-500">旅行筆記</div>
                        <div class="text-kyoto-primary"><i class="fa-solid fa-pen text-xs"></i></div>
                    </div>
                </section>

                <section class="bg-white rounded-2xl p-4 shadow-soft space-y-3">
                    <div class="flex justify-between items-center">
                        <h2 class="font-bold text-lg text-kyoto-dark">住宿資訊</h2>
                        <button @click="openHotelModal()" class="text-sm text-kyoto-primary hover:text-kyoto-accent">
                            <i class="fa-solid fa-plus"></i> 新增
                        </button>
                    </div>
                    <div v-for="(hotel, index) in hotelList" :key="index"
                        class="bg-gray-50 p-3 rounded-xl border border-gray-200">
                        <div class="flex justify-between items-center">
                            <h3 class="font-bold text-kyoto-dark text-base">{{ hotel.name }}</h3>
                            <div class="flex gap-2 text-gray-400">
                                <button @click="openHotelModal(hotel, index)" class="hover:text-kyoto-accent"><i
                                        class="fa-solid fa-pen text-sm"></i></button>
                                <button @click="deleteHotel(index)" class="hover:text-red-500"><i
                                        class="fa-solid fa-trash-can"></i></button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-500 mt-1"><i class="fa-solid fa-calendar-day w-5 text-center"></i>
                            {{ hotel.period }}</p>
                        <p class="text-sm text-gray-500 mt-1"><i class="fa-solid fa-phone w-5 text-center"></i> {{
                            hotel.phone }}</p>
                        <p class="text-sm text-gray-500 mt-1"><i class="fa-solid fa-location-dot w-5 text-center"></i>
                            {{ hotel.address }}</p>
                        <a v-if="hotel.mapLink" :href="hotel.mapLink" target="_blank"
                            class="block mt-3 text-center bg-kyoto-bg text-kyoto-primary py-2 rounded-lg text-sm font-bold">導航前往</a>
                    </div>
                    <div v-if="hotelList.length === 0" class="text-center text-gray-400 py-4">
                        <p>點擊右上角新增住宿</p>
                    </div>
                </section>

            </div>

        </main>

        <button @click="showExchangeSidebar = true"
            class="fixed bottom-6 right-6 w-14 h-14 bg-kyoto-accent text-white rounded-full shadow-float flex items-center justify-center text-2xl fab-button z-40 active:scale-95 transition-transform">
            <i class="fa-solid fa-calculator"></i>
        </button>


        <nav
            class="fixed bottom-0 left-0 w-full h-[70px] bg-white shadow-float flex justify-around items-center z-50 rounded-t-2xl">
            <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id"
                :class="['flex flex-col items-center justify-center p-2 transition-colors', currentTab === tab.id ? 'text-kyoto-dark' : 'text-gray-400']">
                <i :class="tab.icon" class="text-xl"></i>
                <span class="text-xs mt-1">{{ tab.label }}</span>
            </button>
        </nav>


        <transition name="modal">
            <div v-if="showModal.itinerary" class="fixed inset-0 bg-black/50 z-50 flex items-end justify-center p-4">
                <div class="bg-white w-full max-w-md rounded-2xl p-6 modal-content">
                    <h3 class="text-xl font-bold mb-4">{{ isEditMode ? '編輯行程' : '新增行程' }}</h3>
                    <div class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                        <input type="text" v-model="form.name" placeholder="地點/活動名稱 (必填)"
                            class="w-full p-3 bg-kyoto-bg rounded-xl border border-kyoto-secondary/50 font-bold">
                        <select v-model="form.category" class="w-full p-3 bg-gray-50 rounded-xl border">
                            <option value="attraction">景點/活動</option>
                            <option value="food">美食</option>
                            <option value="flight">交通 (飛機)</option>
                            <option value="hotel">住宿</option>
                            <option value="other">其他</option>
                        </select>

                        <div class="bg-gray-50 p-3 rounded-xl">
                            <label class="text-xs text-gray-500 mb-1 block">地點</label>
                            <select v-model="form.location" class="w-full p-2 rounded border border-gray-200 text-sm">
                                <option v-for="loc in locations" :key="loc" :value="loc">{{ loc }}</option>
                            </select>
                        </div>

                        <div class="bg-gray-50 p-3 rounded-xl">
                            <label class="text-xs text-gray-500 mb-1 block">時間與停留</label>
                            <div class="flex gap-2">
                                <input type="time" v-model="form.startTime"
                                    class="p-2 rounded border border-gray-200 text-sm flex-1 min-w-0"
                                    placeholder="時間 (例如 09:00)">
                                <div class="flex items-center gap-1">
                                    <input type="number" v-model.number="form.durationMinutes" placeholder="停留分鐘"
                                        class="p-2 rounded border border-gray-200 text-sm w-24">
                                    <span class="text-xs text-gray-500">分</span>
                                </div>
                            </div>
                        </div>

                        <input type="text" v-model="form.flightTime" placeholder="航班時間/號碼 (例如：TPE -> KIX 13:30)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200"
                            v-if="form.category === 'flight'">

                        <input type="url" v-model="form.mapLink" placeholder="Google Map 導航連結 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                        <input type="text" v-model="form.ticket" placeholder="門票費用/預約資訊 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200"
                            v-if="form.category === 'attraction'">

                        <div class="bg-kyoto-bg p-3 rounded-xl border border-kyoto-secondary/10">
                            <label class="text-xs text-gray-500 mb-1 block font-bold text-kyoto-secondary">交通方式與時間
                                (距離上一站)</label>
                            <div class="flex gap-2">
                                <select v-model="form.transportType"
                                    class="p-2 rounded border border-gray-200 text-sm flex-1 min-w-0">
                                    <option value="walk">步行</option>
                                    <option value="car">汽車</option>
                                    <option value="transit">大眾運輸</option>
                                    <option value="plane">飛機</option>
                                    <option value="none">無 (起點/終點)</option>
                                </select>
                                <input type="number" v-model.number="form.travelTime" placeholder="分鐘"
                                    class="p-2 rounded border border-gray-200 text-sm w-20">
                            </div>
                        </div>

                        <textarea v-model="form.notes" placeholder="備註/說明 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border h-20"></textarea>

                        <div class="mt-4">
                            <label class="block text-sm text-gray-500 mb-1">上傳參考圖 (選填)</label>
                            <input type="file" @change="handleItineraryImage" accept="image/*" class="text-sm">
                            <div v-if="form.image"
                                class="h-20 w-20 bg-gray-100 rounded-xl mt-2 overflow-hidden relative">
                                <img :src="form.image" class="w-full h-full object-cover">
                                <button @click="form.image = null"
                                    class="absolute top-0 right-0 p-1 bg-black/50 text-white rounded-bl-lg text-xs">x</button>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button v-if="isEditMode" @click="deleteItem(editingId)"
                            class="flex-1 bg-red-100 text-red-500 py-3 rounded-xl font-bold">刪除</button>
                        <button @click="showModal.itinerary = false"
                            class="flex-1 bg-gray-200 py-3 rounded-xl">取消</button>
                        <button @click="saveItinerary"
                            class="flex-1 bg-kyoto-dark text-white py-3 rounded-xl">確認</button>
                    </div>
                </div>
            </div>
        </transition>


        <transition name="modal">
            <div v-if="showModal.strategy" class="fixed inset-0 bg-black/50 z-50 flex items-end justify-center p-4">
                <div class="bg-white w-full max-w-md rounded-2xl p-6 modal-content">
                    <h3 class="text-xl font-bold mb-4">{{ isStrategyEditMode ? '編輯攻略資訊' : '新增攻略資訊' }}</h3>
                    <div class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">

                        <input type="text" v-model="strategyForm.name" placeholder="地點/美食名稱 (必填)"
                            class="w-full p-3 bg-kyoto-bg rounded-xl border border-kyoto-secondary/50 font-bold">

                        <select v-model="strategyForm.category" class="w-full p-3 bg-gray-50 rounded-xl border">
                            <option value="attraction">景點</option>
                            <option value="food">美食</option>
                            <option value="others">其他</option>
                        </select>

                        <select v-model="strategyForm.location" class="w-full p-3 bg-gray-50 rounded-xl border">
                            <option v-for="loc in locations" :key="loc" :value="loc">地點: {{ loc }}</option>
                        </select>

                        <div class="bg-gray-50 p-3 rounded-xl border border-gray-200">
                            <label class="text-xs text-gray-500 mb-1 block">想去程度 (1-5 顆星)</label>
                            <div class="flex items-center">
                                <i v-for="n in 5" :key="n" @click="strategyForm.rating = n"
                                    :class="['fa-star text-xl cursor-pointer mr-2 transition-colors', 
                                             n <= strategyForm.rating ? 'fa-solid text-yellow-500' : 'fa-regular text-gray-300']"></i>
                            </div>
                        </div>

                        <input type="url" v-model="strategyForm.strategyLink" placeholder="攻略連結 (Blog/IG)"
                            class="w-full p-3 bg-gray-50 rounded-xl border">

                        <input type="url" v-model="strategyForm.mapLink" placeholder="Google Map 導航連結 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border">

                        <textarea v-model="strategyForm.notes" placeholder="筆記/備註 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border h-20"></textarea>

                    </div>
                    <div class="flex gap-3 mt-6">
                        <button v-if="isStrategyEditMode" @click="removeStrategy(strategyForm.id)"
                            class="flex-1 bg-red-100 text-red-500 py-3 rounded-xl font-bold">刪除</button>
                        <button @click="showModal.strategy = false"
                            class="flex-1 bg-gray-200 py-3 rounded-xl">取消</button>
                        <button @click="saveStrategy"
                            class="flex-1 bg-kyoto-primary text-white py-3 rounded-xl">確認</button>
                    </div>
                </div>
            </div>
        </transition>


        <transition name="modal">
            <div v-if="showModal.shopping" class="fixed inset-0 bg-black/50 z-50 flex items-end justify-center p-4">
                <div class="bg-white w-full max-w-md rounded-2xl p-6 modal-content">
                    <h3 class="text-xl font-bold mb-4">{{ isShopEditMode ? '編輯購物清單' : '新增購物清單' }}</h3>
                    <div class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                        <input type="text" v-model="shopForm.name" placeholder="商品名稱 (必填)"
                            class="w-full p-3 bg-kyoto-bg rounded-xl border border-kyoto-secondary/50 font-bold">
                        <input type="number" v-model.number="shopForm.price" placeholder="預計價格 (JPY)"
                            class="w-full p-3 bg-gray-50 rounded-xl border">
                        <input type="text" v-model="shopForm.place" placeholder="購買地點 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border">
                        <input type="url" v-model="shopForm.externalLink" placeholder="商品連結 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border">
                        <textarea v-model="shopForm.notes" placeholder="備註/規格/數量 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border h-20"></textarea>
                        <div class="mt-4">
                            <label class="block text-sm text-gray-500 mb-1">上傳參考圖 (點擊圖片即可更換)</label>
                            <input type="file" @change="handleShopImage" accept="image/*" class="text-sm">
                            <div v-if="shopForm.image"
                                class="h-20 w-20 bg-gray-100 rounded-xl mt-2 overflow-hidden relative">
                                <img :src="shopForm.image" class="w-full h-full object-cover">
                                <button @click="shopForm.image = null"
                                    class="absolute top-0 right-0 p-1 bg-black/50 text-white rounded-bl-lg text-xs">x</button>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button v-if="isShopEditMode" @click="removeShoppingItem(editingShopIndex)"
                            class="flex-1 bg-red-100 text-red-500 py-3 rounded-xl font-bold">刪除</button>
                        <button @click="showModal.shopping = false"
                            class="flex-1 bg-gray-200 py-3 rounded-xl">取消</button>
                        <button @click="saveShopping"
                            class="flex-1 bg-kyoto-accent text-white py-3 rounded-xl">確認</button>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="modal">
            <div v-if="showModal.expense" class="fixed inset-0 bg-black/50 z-50 flex items-end justify-center p-4">
                <div class="bg-white w-full max-w-md rounded-2xl p-6 modal-content">
                    <h3 class="text-xl font-bold mb-4">{{ isExpenseEditMode ? '編輯記帳' : '新增記帳' }}</h3>
                    <div class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                        <input type="text" v-model="expenseForm.name" placeholder="消費名稱/店家 (必填)"
                            class="w-full p-3 bg-kyoto-bg rounded-xl border border-kyoto-secondary/50 font-bold">
                        <select v-model="expenseForm.category" class="w-full p-3 bg-gray-50 rounded-xl border">
                            <option value="food">餐飲</option>
                            <option value="transport">交通</option>
                            <option value="hotel">住宿</option>
                            <option value="ticket">門票/活動</option>
                            <option value="shopping">購物</option>
                            <option value="other">其他</option>
                        </select>
                        <input type="number" v-model.number="expenseForm.amount" placeholder="金額 (JPY, 必填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border">
                        <input type="date" v-model="expenseForm.date" placeholder="日期 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border">
                        <select v-model="expenseForm.method" class="w-full p-3 bg-gray-50 rounded-xl border">
                            <option value="cash">現金</option>
                            <option value="card">信用卡/電子支付</option>
                        </select>
                        <input type="text" v-model="expenseForm.split" placeholder="分帳對象/金額 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border">
                        <textarea v-model="expenseForm.notes" placeholder="備註 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border h-20"></textarea>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button v-if="isExpenseEditMode" @click="deleteExpenseItem(expenseForm.id)"
                            class="flex-1 bg-red-100 text-red-500 py-3 rounded-xl font-bold">刪除</button>
                        <button @click="showModal.expense = false"
                            class="flex-1 bg-gray-200 py-3 rounded-xl">取消</button>
                        <button @click="saveExpense" class="flex-1 bg-yellow-600 text-white py-3 rounded-xl">確認</button>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="modal">
            <div v-if="showModal.hotel" class="fixed inset-0 bg-black/50 z-50 flex items-end justify-center p-4">
                <div class="bg-white w-full max-w-md rounded-2xl p-6 modal-content">
                    <h3 class="text-xl font-bold mb-4">{{ isHotelEditMode ? '編輯住宿資訊' : '新增住宿資訊' }}</h3>
                    <div class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                        <input type="text" v-model="hotelForm.name" placeholder="飯店名稱"
                            class="w-full p-3 bg-gray-50 rounded-xl border">
                        <input type="text" v-model="hotelForm.period" placeholder="入住/退房日期 (例如：3/6 - 3/8)"
                            class="w-full p-3 bg-gray-50 rounded-xl border">
                        <input type="tel" v-model="hotelForm.phone" placeholder="電話"
                            class="w-full p-3 bg-gray-50 rounded-xl border">
                        <input type="text" v-model="hotelForm.address" placeholder="地址"
                            class="w-full p-3 bg-gray-50 rounded-xl border">
                        <input type="url" v-model="hotelForm.mapLink" placeholder="導航連結 (Google Map)"
                            class="w-full p-3 bg-gray-50 rounded-xl border">
                    </div>
                    <div class="flex gap-3 mt-4">
                        <button v-if="isHotelEditMode" @click="deleteHotel(editingHotelIndex); showModal.hotel = false;"
                            class="flex-1 bg-red-100 text-red-500 py-3 rounded-xl font-bold">刪除</button>
                        <button @click="showModal.hotel = false" class="flex-1 bg-gray-200 py-3 rounded-xl">取消</button>
                        <button @click="saveHotel"
                            class="flex-1 bg-kyoto-secondary text-white py-3 rounded-xl">確認</button>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="modal">
            <div v-if="showModal.infoEdit" class="fixed inset-0 bg-black/50 z-50 flex items-end justify-center p-4">
                <div class="bg-white w-full max-w-md rounded-2xl p-6 modal-content">
                    <h3 class="text-xl font-bold mb-4">編輯 {{ infoEditTargetLabel }}</h3>
                    <div class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                        <input v-if="infoEditTarget === 'exchange'" type="number" step="0.0001"
                            v-model.number="infoForms.exchange" placeholder="當前日幣匯率 (例如 0.2200)"
                            class="w-full p-3 bg-gray-50 rounded-xl border">
                        <textarea v-if="infoEditTarget === 'notes'" v-model="infoForms.notes" placeholder="輸入旅行重要筆記"
                            class="w-full p-3 bg-gray-50 rounded-xl border h-40"></textarea>
                    </div>
                    <div class="flex gap-3 mt-4">
                        <button @click="showModal.infoEdit = false"
                            class="flex-1 bg-gray-200 py-3 rounded-xl">取消</button>
                        <button @click="saveInfoEdit"
                            class="flex-1 bg-kyoto-primary text-white py-3 rounded-xl">儲存</button>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="sidebar">
            <div v-if="showExchangeSidebar" class="fixed inset-0 z-50">
                <div class="absolute inset-0 bg-black/50" @click="showExchangeSidebar = false"></div>
                <div
                    class="absolute right-0 top-0 bottom-0 w-full max-w-sm bg-kyoto-bg p-4 shadow-2xl sidebar-content flex flex-col">

                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-kyoto-dark">匯率換算機</h3>
                        <button @click="showExchangeSidebar = false" class="text-gray-500 hover:text-kyoto-dark">
                            <i class="fa-solid fa-xmark text-2xl"></i>
                        </button>
                    </div>

                    <div class="space-y-4 mb-6">
                        <div class="bg-white p-4 rounded-xl shadow-soft">
                            <div class="text-xs text-gray-500 mb-1">日幣 (JPY)</div>
                            <div class="text-3xl font-bold text-kyoto-dark flex justify-between items-center">
                                <span class="flex-1 truncate">{{ exchange.jpyInput || '' }}</span>
                                <button @click="swapCurrencies"
                                    class="text-kyoto-accent ml-2 text-sm active:scale-95 transition-transform"><i
                                        class="fa-solid fa-arrows-up-down"></i></button>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-soft">
                            <div class="text-xs text-gray-500 mb-1">台幣 (TWD) - 參考匯率 1:{{ infoForms.exchange || '0.22' }}
                            </div>
                            <div class="text-3xl font-bold text-kyoto-accent">
                                {{ exchange.twdResult ? 'NT$ ' + exchange.twdResult.toLocaleString('en-US',
                                {maximumFractionDigits: 2}) : '' }}
                            </div>
                        </div>
                        <div class="text-center text-xs text-gray-400">
                            最後更新匯率：{{ infoForms.exchange }}
                        </div>
                    </div>

                    <div class="grid grid-cols-4 gap-2 mt-auto calculator-keypad">
                        <button @click="clearInput"
                            class="col-span-2 bg-kyoto-secondary text-white p-4 rounded-xl text-xl font-bold">C</button>
                        <button @click="deleteDigit" class="bg-gray-300 text-kyoto-dark p-4 rounded-xl text-xl"><i
                                class="fa-solid fa-delete-left"></i></button>
                        <button @click="toggleSign"
                            class="bg-gray-300 text-kyoto-dark p-4 rounded-xl text-xl font-bold">+/-</button>

                        <button @click="appendDigit('7')"
                            class="bg-white text-kyoto-dark p-4 rounded-xl text-xl font-bold">7</button>
                        <button @click="appendDigit('8')"
                            class="bg-white text-kyoto-dark p-4 rounded-xl text-xl font-bold">8</button>
                        <button @click="appendDigit('9')"
                            class="bg-white text-kyoto-dark p-4 rounded-xl text-xl font-bold">9</button>
                        <button @click="appendDecimal"
                            class="bg-gray-300 text-kyoto-dark p-4 rounded-xl text-xl font-bold">.</button>

                        <button @click="appendDigit('4')"
                            class="bg-white text-kyoto-dark p-4 rounded-xl text-xl font-bold">4</button>
                        <button @click="appendDigit('5')"
                            class="bg-white text-kyoto-dark p-4 rounded-xl text-xl font-bold">5</button>
                        <button @click="appendDigit('6')"
                            class="bg-white text-kyoto-dark p-4 rounded-xl text-xl font-bold">6</button>
                        <button @click="calculateResult"
                            class="row-span-2 bg-kyoto-primary text-white p-4 rounded-xl text-2xl font-bold flex items-center justify-center">
                            <i class="fa-solid fa-equals"></i>
                        </button>

                        <button @click="appendDigit('1')"
                            class="bg-white text-kyoto-dark p-4 rounded-xl text-xl font-bold">1</button>
                        <button @click="appendDigit('2')"
                            class="bg-white text-kyoto-dark p-4 rounded-xl text-xl font-bold">2</button>
                        <button @click="appendDigit('3')"
                            class="bg-white text-kyoto-dark p-4 rounded-xl text-xl font-bold">3</button>

                        <button @click="appendDigit('0')"
                            class="col-span-3 bg-white text-kyoto-dark p-4 rounded-xl text-xl font-bold">0</button>
                    </div>
                </div>
            </div>
        </transition>

    </div>

    <script>
        const { createApp, ref, computed, watch } = Vue;

        const STORAGE_KEY = 'kyoto-osaka-trip-planner';

        const loadFromLocal = (key, defaultValue) => {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    const data = JSON.parse(stored);
                    return data[key] !== undefined ? data[key] : defaultValue;
                }
            } catch (e) {
                console.error("Error loading from localStorage", e);
            }
            return defaultValue;
        };

        const saveToLocal = (data) => {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            } catch (e) {
                console.error("Error saving to localStorage", e);
            }
        };

        createApp({
            setup() {
                // --- Data ---
                const currentTab = ref(loadFromLocal('currentTab', 'itinerary'));
                const headerImage = ref(loadFromLocal('headerImage', 'https://images.unsplash.com/photo-1547829768-e4b52c002221?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'));
                const currentDayIndex = ref(loadFromLocal('currentDayIndex', 0));

                // 行程資料 (包含新欄位: startTime, durationMinutes, location)
                const itineraryData = ref(loadFromLocal('itinerary', [
                    [
                        { id: 1, category: 'flight', name: '桃園機場 (TPE) 出發', notes: '酷航', transportType: 'none', travelTime: 0, mapLink: '', startTime: '07:00', durationMinutes: null, location: 'Kyoto', flightTime: '07:00 - 11:00', ticket: '' },
                        { id: 2, category: 'hotel', name: '大阪梅田飯店 Check-in', notes: '放行李', transportType: 'transit', travelTime: 60, mapLink: 'https://maps.app.goo.gl/abcdef', startTime: '12:30', durationMinutes: 60, location: 'Osaka', expectedHours: 0.5, flightTime: '', ticket: '' },
                        { id: 3, category: 'attraction', name: '梅田藍天大廈 (空中庭園)', notes: '看夕陽', transportType: 'walk', travelTime: 10, mapLink: 'https://maps.app.goo.gl/abcdef', startTime: '16:00', durationMinutes: 120, location: 'Osaka', expectedHours: 2, flightTime: '', ticket: '¥1500' },
                        { id: 4, category: 'food', name: '一蘭拉麵 (梅田店)', notes: '晚餐', transportType: 'walk', travelTime: 5, mapLink: 'https://maps.app.goo.gl/abcdef', startTime: '19:00', durationMinutes: 60, location: 'Osaka', expectedHours: 1, flightTime: '', ticket: '' },
                    ]
                ]));

                // 購物清單 (未變動)
                const shoppingList = ref(loadFromLocal('shopping', []));

                // 記帳清單 (未變動)
                const expenses = ref(loadFromLocal('expenses', []));

                // 7. 許願清單改名為攻略清單 (包含新欄位: location, mapLink, strategyLink, rating)
                const strategyList = ref(loadFromLocal('strategyList', [
                    { id: 101, name: '清水寺', category: 'attraction', externalLink: 'https://kiyomizu-dera.or.jp/', notes: '賞櫻必去', location: 'Kyoto', mapLink: 'https://maps.app.goo.gl/kiyomizu', strategyLink: 'https://blog.example.com/kiyomizu', rating: 5 },
                    { id: 102, name: '黑門市場', category: 'food', externalLink: 'https://kuromon.com/', notes: '吃海鮮', location: 'Osaka', mapLink: 'https://maps.app.goo.gl/kuromon', strategyLink: '', rating: 4 },
                ]));

                // 住宿清單 (未變動)
                const hotelList = ref(loadFromLocal('hotelList', []));

                // 資訊表單 (未變動)
                const infoForms = ref(loadFromLocal('infoForms', {
                    exchange: 0.2200, // 匯率
                    notes: '請記得買京都地鐵一日券！',
                }));

                // Modal 狀態
                const showModal = ref({
                    itinerary: false,
                    shopping: false,
                    expense: false,
                    strategy: false, // RENAME: wishlist -> strategy
                    hotel: false,
                    infoEdit: false,
                });

                // 行程表單 (更新欄位)
                const form = ref({
                    category: 'attraction',
                    name: '',
                    notes: '',
                    transportType: 'walk',
                    travelTime: 15,
                    mapLink: '',
                    startTime: '', // NEW: 24小時制
                    durationMinutes: null, // NEW: 停留時間 (分鐘)
                    location: 'Kyoto', // NEW: 地點
                    expectedHours: null,
                    flightTime: '',
                    ticket: '',
                    image: null,
                });

                // 攻略表單 (更新欄位)
                const strategyForm = ref({
                    id: null,
                    name: '',
                    category: 'attraction',
                    externalLink: '',
                    notes: '',
                    location: 'Kyoto', // NEW: 地點
                    mapLink: '', // NEW: 導航前往
                    strategyLink: '', // NEW: 攻略連結
                    rating: 3, // NEW: 想去幾顆星 (1-5)
                });

                // ... 其他表單 (購物/記帳/住宿) 保持不變 ...

                // 攻略分類 (更新: 移除好物推薦)
                const strategyCategories = {
                    attraction: { label: '景點', color: 'bg-kyoto-secondary' },
                    food: { label: '美食', color: 'bg-kyoto-accent' },
                    others: { label: '其他', color: 'bg-gray-400' },
                };

                // 地點列表
                const locations = ['Kyoto', 'Osaka'];

                // 篩選器
                const itineraryLocationFilter = ref(loadFromLocal('itineraryLocationFilter', null));
                const strategyLocationFilter = ref(loadFromLocal('strategyLocationFilter', null));
                const strategyFilter = ref(loadFromLocal('strategyFilter', null));

                // 匯率計算機狀態
                const exchange = ref(loadFromLocal('exchange', {
                    jpyInput: '', // 1. 空格預設空白
                    twdResult: '',
                    isJPYSide: true, // true: 輸入 JPY, 輸出 TWD
                }));
                const showExchangeSidebar = ref(false);


                // --- Computed Properties ---
                const tabs = [
                    { id: 'itinerary', label: '行程', icon: 'fa-solid fa-map-location-dot' },
                    { id: 'strategy', label: '攻略', icon: 'fa-solid fa-book-open-reader' }, // 7. 許願改攻略
                    { id: 'shopping', label: '購物', icon: 'fa-solid fa-bag-shopping' },
                    { id: 'expense', label: '記帳', icon: 'fa-solid fa-yen-sign' },
                    { id: 'info', label: '資訊', icon: 'fa-solid fa-circle-info' },
                ];

                const tripDays = computed(() => {
                    return itineraryData.value.map((day, index) => ({
                        date: `0${index + 1}/??`,
                        items: day
                    }));
                });

                // 篩選後的當前日期行程 (包含地點篩選)
                const currentDayItinerary = computed(() => {
                    const dailyItems = itineraryData.value[currentDayIndex.value] || [];
                    let filtered = dailyItems;

                    if (itineraryLocationFilter.value) {
                        filtered = filtered.filter(item => item.location === itineraryLocationFilter.value);
                    }
                    // 根據 startTime 排序 (確保時間軸順序正確)
                    filtered.sort((a, b) => {
                        if (!a.startTime) return b.startTime ? 1 : 0;
                        if (!b.startTime) return -1;
                        return a.startTime.localeCompare(b.startTime);
                    });
                    return filtered;
                });

                // 4. 行程左側時間軸分出上午下午晚上 (分組邏輯)
                const timeGroups = {
                    morning: { label: '上午 🌅 (06:00 - 11:59)', start: 6, end: 12 },
                    afternoon: { label: '下午 ☀️ (12:00 - 17:59)', start: 12, end: 18 },
                    evening: { label: '晚上 🌙 (18:00 - 05:59)', start: 18, end: 6 },
                };

                const getGroupKey = (startTime) => {
                    if (!startTime || startTime.length < 5) return 'unspecified';
                    const hour = parseInt(startTime.split(':')[0]);
                    if (isNaN(hour)) return 'unspecified';
                    if (hour >= timeGroups.morning.start && hour < timeGroups.afternoon.start) return 'morning';
                    if (hour >= timeGroups.afternoon.start && hour < timeGroups.evening.start) return 'afternoon';
                    return 'evening'; // 包含 18:00 到 05:59
                };

                const groupedItinerary = computed(() => {
                    const groups = { morning: [], afternoon: [], evening: [], unspecified: [] };
                    currentDayItinerary.value.forEach(item => {
                        const key = getGroupKey(item.startTime);
                        // 將未指定時間的項目歸類到 unspecified，並在 HTML 中處理
                        if (key === 'unspecified') {
                            groups.unspecified.push(item);
                        } else {
                            groups[key].push(item);
                        }
                    });
                    return groups;
                });

                // 7. 攻略統計卡片數
                const strategyCategoryCounts = computed(() => {
                    const counts = {};
                    Object.keys(strategyCategories).forEach(key => {
                        counts[key] = strategyList.value.filter(s => s.category === key).length;
                    });
                    return counts;
                });

                // 篩選後的攻略列表
                const filteredStrategyList = computed(() => {
                    let list = strategyList.value;
                    if (strategyFilter.value) {
                        list = list.filter(s => s.category === strategyFilter.value);
                    }
                    if (strategyLocationFilter.value) {
                        list = list.filter(s => s.location === strategyLocationFilter.value);
                    }
                    return list;
                });

                // 記帳總花費
                const totalExpense = computed(() => {
                    return expenses.value.reduce((sum, item) => sum + Number(item.amount), 0);
                });

                // --- Methods ---

                // Helper: Save to LocalStorage
                const saveStateToLocal = () => {
                    saveToLocal({
                        currentTab: currentTab.value,
                        headerImage: headerImage.value,
                        itinerary: itineraryData.value,
                        shopping: shoppingList.value,
                        expenses: expenses.value,
                        strategyList: strategyList.value, // RENAME
                        hotelList: hotelList.value,
                        infoForms: infoForms.value,
                        currentDayIndex: currentDayIndex.value,
                        exchange: exchange.value,
                        itineraryLocationFilter: itineraryLocationFilter.value,
                        strategyLocationFilter: strategyLocationFilter.value,
                        strategyFilter: strategyFilter.value,
                    });
                };

                // 匯率計算邏輯 (1. 空格預設空白)
                const calculateTWDFromJPY = () => {
                    if (!exchange.value.jpyInput) {
                        exchange.value.twdResult = '';
                        return;
                    }
                    const jpy = Number(exchange.value.jpyInput);
                    const rate = Number(infoForms.value.exchange);
                    if (!isNaN(jpy) && !isNaN(rate) && rate > 0) {
                        exchange.value.twdResult = jpy * rate;
                    } else {
                        exchange.value.twdResult = '';
                    }
                    saveStateToLocal();
                };

                const calculateJPYFromTWD = () => {
                    if (!exchange.value.jpyInput) {
                        exchange.value.twdResult = '';
                        return;
                    }
                    const twd = Number(exchange.value.jpyInput);
                    const rate = Number(infoForms.value.exchange);
                    if (!isNaN(twd) && !isNaN(rate) && rate > 0) {
                        exchange.value.twdResult = twd / rate;
                    } else {
                        exchange.value.twdResult = '';
                    }
                    saveStateToLocal();
                };

                const calculateResult = () => {
                    if (exchange.value.isJPYSide) {
                        calculateTWDFromJPY();
                    } else {
                        calculateJPYFromTWD();
                    }
                };

                // 計算機操作
                const appendDigit = (digit) => {
                    // 確保輸入不超過一定長度
                    if (exchange.value.jpyInput.length >= 15) return;
                    // 初始為空或 '0' 時替換
                    if (exchange.value.jpyInput === '0' || exchange.value.jpyInput === '') {
                        exchange.value.jpyInput = digit;
                    } else {
                        exchange.value.jpyInput += digit;
                    }
                    calculateResult();
                };

                const appendDecimal = () => {
                    if (!exchange.value.jpyInput.includes('.')) {
                        exchange.value.jpyInput += '.';
                    }
                    // 不需要計算結果，因為還在輸入小數點後
                };

                const clearInput = () => {
                    exchange.value.jpyInput = '';
                    exchange.value.twdResult = '';
                    saveStateToLocal();
                };

                const deleteDigit = () => {
                    exchange.value.jpyInput = exchange.value.jpyInput.slice(0, -1);
                    calculateResult();
                };

                const toggleSign = () => {
                    if (exchange.value.jpyInput.startsWith('-')) {
                        exchange.value.jpyInput = exchange.value.jpyInput.substring(1);
                    } else if (exchange.value.jpyInput !== '' && exchange.value.jpyInput !== '0') {
                        exchange.value.jpyInput = '-' + exchange.value.jpyInput;
                    }
                    calculateResult();
                };

                const swapCurrencies = () => {
                    exchange.value.isJPYSide = !exchange.value.isJPYSide;
                    // 交換輸入/輸出值
                    exchange.value.jpyInput = exchange.value.twdResult ? String(exchange.value.twdResult) : '';
                    calculateResult();
                };

                // 圖片上傳 (Header)
                const uploadHeader = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => headerImage.value = e.target.result;
                        reader.readAsDataURL(file);
                        saveStateToLocal();
                    }
                };

                // 行程相關
                const openModal = (item = null, index = null) => {
                    const todayItems = itineraryData.value[currentDayIndex.value] || [];

                    if (item && index !== null) {
                        // 編輯模式
                        isEditMode.value = true;
                        editingId.value = item.id;
                        editingIndex.value = index; // 用於當日陣列
                        form.value = {
                            ...item,
                            travelTime: Number(item.travelTime),
                            durationMinutes: Number(item.durationMinutes) || null,
                            expectedHours: Number(item.expectedHours) || null,
                        };
                    } else {
                        // 新增模式
                        isEditMode.value = false;
                        editingId.value = null;
                        editingIndex.value = null;
                        form.value = {
                            category: 'attraction',
                            name: '',
                            notes: '',
                            transportType: 'walk',
                            travelTime: 15,
                            mapLink: '',
                            startTime: '', // 5. 新增行程時間可選24小時
                            durationMinutes: null, // 5. 新增停留時間
                            location: itineraryLocationFilter.value || 'Kyoto', // 8. 預設為當前篩選地點
                            expectedHours: null,
                            flightTime: '',
                            ticket: '',
                            image: null,
                        };
                    }
                    showModal.value.itinerary = true;
                };

                const saveItinerary = () => {
                    if (!form.value.name) return;

                    const newItem = {
                        ...form.value,
                        travelTime: Number(form.value.travelTime) || 0,
                        durationMinutes: Number(form.value.durationMinutes) || null,
                        expectedHours: Number(form.value.expectedHours) || null,
                    };

                    if (isEditMode.value) {
                        // 編輯模式
                        const dayItems = itineraryData.value[currentDayIndex.value];
                        const globalIndex = dayItems.findIndex(i => i.id === editingId.value);
                        if (globalIndex !== -1) {
                            dayItems[globalIndex] = newItem;
                        }
                    } else {
                        // 新增模式
                        if (!itineraryData.value[currentDayIndex.value]) {
                            itineraryData.value[currentDayIndex.value] = [];
                        }
                        itineraryData.value[currentDayIndex.value].push({
                            ...newItem,
                            id: Date.now(),
                        });
                    }

                    // 重新排序當日行程
                    itineraryData.value[currentDayIndex.value].sort((a, b) => {
                        if (!a.startTime) return 1;
                        if (!b.startTime) return -1;
                        return a.startTime.localeCompare(b.startTime);
                    });

                    saveStateToLocal();
                    showModal.value.itinerary = false;
                };

                const deleteItem = (id) => {
                    if (confirm('確定刪除此行程？')) {
                        const dayItems = itineraryData.value[currentDayIndex.value];
                        const index = dayItems.findIndex(i => i.id === id);
                        if (index !== -1) {
                            dayItems.splice(index, 1);
                            saveStateToLocal();
                            showModal.value.itinerary = false;
                        }
                    }
                };

                // 購物相關 (未變動)
                // ... openShopModal, openShopEdit, handleShopImage, saveShopping, removeShoppingItem ...
                const openShopModal = () => { /* ... existing logic ... */ showModal.value.shopping = true; saveStateToLocal(); };
                const openShopEdit = (index) => { /* ... existing logic ... */ showModal.value.shopping = true; saveStateToLocal(); };
                const saveShopping = () => { /* ... existing logic ... */ showModal.value.shopping = false; saveStateToLocal(); };
                const removeShoppingItem = (index) => { /* ... existing logic ... */ saveStateToLocal(); };

                // 記帳相關 (未變動)
                // ... openExpenseModal, editExpense, saveExpense, deleteExpenseItem ...
                const openExpenseModal = () => { /* ... existing logic ... */ showModal.value.expense = true; saveStateToLocal(); };
                const editExpense = (exp, index) => { /* ... existing logic ... */ showModal.value.expense = true; saveStateToLocal(); };
                const saveExpense = () => { /* ... existing logic ... */ showModal.value.expense = false; saveStateToLocal(); };
                const deleteExpenseItem = (id) => { /* ... existing logic ... */ saveStateToLocal(); };


                // 攻略相關 (RENAME & UPDATE: Requests 7, 9, 10)
                const openStrategyModal = (strategy = null, index = null) => {
                    if (strategy) {
                        isStrategyEditMode.value = true;
                        editingIndex.value = index;
                        strategyForm.value = {
                            ...strategy,
                            rating: Number(strategy.rating) || 3,
                        };
                    } else {
                        isStrategyEditMode.value = false;
                        editingIndex.value = null;
                        strategyForm.value = {
                            id: Date.now(),
                            name: '',
                            category: 'attraction',
                            externalLink: '',
                            notes: '',
                            location: strategyLocationFilter.value || 'Kyoto', // 8. 預設為篩選地點
                            mapLink: '',
                            strategyLink: '',
                            rating: 3,
                        };
                    }
                    showModal.value.strategy = true;
                };

                const saveStrategy = () => {
                    if (!strategyForm.value.name) return;

                    strategyForm.value.rating = Number(strategyForm.value.rating);

                    if (isStrategyEditMode.value) {
                        // 雖然 filteredStrategyList 是 computed property，但編輯操作是針對原始 strategyList
                        // 需要找到原始 list 中的 index
                        const originalIndex = strategyList.value.findIndex(s => s.id === strategyForm.value.id);
                        if (originalIndex !== -1) {
                            strategyList.value[originalIndex] = { ...strategyForm.value };
                        }
                    } else {
                        strategyList.value.push({ ...strategyForm.value });
                    }
                    saveStateToLocal();
                    showModal.value.strategy = false;
                };

                const removeStrategy = (id) => {
                    if (confirm('確定刪除此攻略項目？')) {
                        const index = strategyList.value.findIndex(s => s.id === id);
                        if (index !== -1) {
                            strategyList.value.splice(index, 1);
                            saveStateToLocal();
                            if (showModal.value.strategy) showModal.value.strategy = false;
                        }
                    }
                };

                // 住宿相關 (未變動)
                // ... openHotelModal, saveHotel, deleteHotel ...
                const openHotelModal = (hotel = null, index = null) => { /* ... existing logic ... */ showModal.value.hotel = true; saveStateToLocal(); };
                const saveHotel = () => { /* ... existing logic ... */ showModal.value.hotel = false; saveStateToLocal(); };
                const deleteHotel = (index) => { /* ... existing logic ... */ saveStateToLocal(); };

                // Info 編輯 (未變動)
                const openInfoEditModal = (target) => { /* ... existing logic ... */ showModal.value.infoEdit = true; };
                const saveInfoEdit = () => {
                    saveStateToLocal();
                    showModal.value.infoEdit = false;
                    if (infoEditTarget.value === 'exchange') {
                        calculateResult(); // 匯率更新後重新計算
                    }
                };

                // Helper: Get Category Color
                const getCategoryColor = (cat) => {
                    const map = {
                        attraction: 'bg-kyoto-secondary',
                        food: 'bg-kyoto-accent',
                        flight: 'bg-indigo-500',
                        hotel: 'bg-rose-500',
                        other: 'bg-gray-400',
                        others: 'bg-gray-400', // for strategy category
                    };
                    return map[cat] || 'bg-gray-500';
                };

                // Helper: Get Category Label
                const getCategoryLabel = (cat) => {
                    const map = {
                        attraction: '景點/活動',
                        food: '美食',
                        flight: '飛機交通',
                        hotel: '住宿',
                        other: '其他',
                        others: '其他',
                    };
                    return map[cat] || '未分類';
                };

                // Helper: Get Transport Icon (5. 加入交通工具小icon)
                const getTransportIcon = (type) => {
                    const map = {
                        walk: 'fa-person-walking',
                        car: 'fa-car',
                        transit: 'fa-train-subway',
                        plane: 'fa-plane',
                        none: 'fa-circle-dot'
                    };
                    return map[type] || 'fa-circle-dot';
                };

                // Helper: Get Expense Icon (未變動)
                const getExpenseIcon = (cat) => {
                    const map = {
                        food: 'fa-utensils',
                        transport: 'fa-train',
                        hotel: 'fa-bed',
                        ticket: 'fa-ticket',
                        shopping: 'fa-bag-shopping',
                        other: 'fa-coins'
                    };
                    return map[cat] || 'fa-coins';
                };

                // --- Watchers ---
                watch([itineraryData, currentDayIndex, strategyList, shoppingList, expenses, hotelList, infoForms, currentTab, itineraryLocationFilter, strategyLocationFilter, strategyFilter, headerImage], saveStateToLocal, { deep: true });

                // 匯率輸入監聽
                watch(() => exchange.value.jpyInput, calculateResult);
                watch(() => exchange.value.isJPYSide, calculateResult);
                watch(() => infoForms.value.exchange, calculateResult);

                // 處理 Modal 開啟/關閉時的 body 樣式 (避免畫面跳動)
                watch(showModal, (newVal) => {
                    const isModalOpen = Object.values(newVal).some(Boolean);
                    if (isModalOpen || showExchangeSidebar.value) {
                        document.body.classList.add('modal-open-prevent-shift');
                    } else {
                        document.body.classList.remove('modal-open-prevent-shift');
                    }
                }, { deep: true });

                watch(showExchangeSidebar, (newVal) => {
                    const isModalOpen = Object.values(showModal.value).some(Boolean);
                    if (newVal || isModalOpen) {
                        document.body.classList.add('modal-open-prevent-shift');
                    } else {
                        document.body.classList.remove('modal-open-prevent-shift');
                    }
                    if (newVal) {
                        clearInput(); // 1. 開啟時預設空白
                    }
                });

                return {
                    currentTab, tabs, headerImage, uploadHeader,
                    tripDays, currentDayIndex, currentDayItinerary,
                    groupedItinerary, timeGroups, getGroupKey, // 4. 行程分組
                    itineraryLocationFilter, locations, // 8. 地點篩選
                    itineraryData, showModal, form, isEditMode: ref(false), editingId: ref(null), editingIndex: ref(null),
                    saveItinerary, deleteItem, openModal,
                    getCategoryColor, getCategoryLabel, getTransportIcon,

                    // 1. 匯率計算機
                    exchange, calculateResult, clearInput, deleteDigit, appendDigit, appendDecimal, toggleSign, swapCurrencies,
                    showExchangeSidebar,

                    shoppingList, openShopModal, openShopEdit, saveShopping, removeShoppingItem, shopForm: ref({}), isShopEditMode: ref(false), editingShopIndex: ref(null), // 購物
                    expenses, totalExpense, openExpenseModal, saveExpense, deleteExpenseItem, getExpenseIcon, expenseForm: ref({}), isExpenseEditMode: ref(false), // 記帳

                    // 7, 9, 10. 攻略 (RENAME)
                    strategyList, openStrategyModal, saveStrategy, removeStrategy, strategyForm, isStrategyEditMode: ref(false),
                    strategyCategories, strategyFilter, filteredStrategyList, strategyCategoryCounts, strategyLocationFilter, // 攻略

                    infoEditMode: ref(false), checklist: ref([]), newChecklistItem: ref(''), addChecklistItem: () => { /* ... existing logic ... */ }, removeChecklistItem: () => { /* ... existing logic ... */ }, // 資訊
                    infoEditTarget: ref(null), infoEditTargetLabel: ref(''), openInfoEditModal, infoForms, saveInfoEdit, // 資訊編輯
                    hotelList, openHotelModal, saveHotel, deleteHotel, hotelForm: ref({}), isHotelEditMode: ref(false), editingHotelIndex: ref(null), // 住宿
                };
            }
        }).mount('#app');
    </script>
</body>

</html>