<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KYOTO & OSAKA | Trip Planner</title>

    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@100;400;500;700;900&display=swap"
        rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        kyoto: {
                            bg: '#F7F4EF',
                            primary: '#6A7F60',
                            secondary: '#8F7762',
                            accent: '#D48666',
                            dark: '#4A4036',
                            light: '#FFFFFF'
                        },
                        calculator: {
                            keypad: '#E8E4DF',
                            op: '#D48666',
                            equal: '#6A7F60',
                        }
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(106, 127, 96, 0.15)',
                        'float': '0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1)',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #F7F4EF;
            font-family: 'Noto Sans TC', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .header-curve {
            border-radius: 30px 30px 0 0;
            margin-top: -30px;
            position: relative;
            z-index: 10;
            background-color: #F7F4EF;
        }

        .page-title {
            font-size: 2.5rem;
            /* 40px */
            line-height: 1;
            font-weight: 900;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.7);
            letter-spacing: 0.1em;
            white-space: nowrap;
            /* 不換行 */
        }

        /* Modal 從底部彈出動畫 */
        .modal-enter-active .modal-content,
        .modal-leave-active .modal-content {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }

        .modal-enter-from .modal-content,
        .modal-leave-to .modal-content {
            transform: translateY(100%);
            opacity: 0.5;
        }

        /* 行程時間軸樣式 */
        .timeline-wrapper {
            border-left: 2px solid #8F776230;
            padding-left: 1rem;
            margin-left: 10px;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 2rem;
        }

        .timeline-dot {
            position: absolute;
            left: -18px;
            top: 4px;
            width: 16px;
            height: 16px;
            background-color: #F7F4EF;
            border: 3px solid #8F7762;
            border-radius: 50%;
            z-index: 2;
        }

        .timeline-group-divider {
            position: relative;
            margin-left: -18px;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }

        .timeline-group-line {
            position: absolute;
            left: -18px;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 2px;
            background-color: #6A7F60;
            z-index: 1;
        }

        .timeline-group-label {
            position: relative;
            z-index: 2;
            padding: 2px 8px;
            background-color: #6A7F60;
            color: white;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            display: inline-block;
            margin-left: -10px;
        }

        /* 計算機按鈕樣式 */
        .calc-key {
            height: 60px;
            font-size: 1.5rem;
            font-weight: 600;
            border-radius: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: background-color 0.1s;
        }

        .calc-key:active {
            box-shadow: none;
            transform: translateY(1px);
        }
    </style>
</head>

<body class="text-kyoto-dark">

    <div id="app" class="relative min-h-screen pb-[80px]">

        <header class="relative w-full h-[180px] md:h-[250px] overflow-hidden bg-gray-300">
            <img :src="headerImage" class="w-full h-full object-cover transition-all duration-300" alt="Kyoto Header">

            <input type="file" @change="uploadHeader" class="absolute inset-0 opacity-0 cursor-pointer z-30"
                title="點擊更換封面">

            <div class="absolute inset-0 flex items-end p-4 z-20">
                <h1 class="page-title text-white">
                    KYOTO & OSAKA
                </h1>
            </div>
        </header>

        <main class="header-curve px-4 pt-6">

            <div v-if="currentTab === 'itinerary'">

                <div class="bg-white rounded-2xl p-4 shadow-soft mb-6">
                    <div class="text-sm font-bold text-kyoto-primary mb-2">
                        <i class="fa-solid fa-cloud-sun mr-1"></i> 京阪即時天氣
                    </div>
                    <iframe :src="weatherIframeSrc" class="w-full h-24 border-0 rounded-xl"
                        title="Google Weather Widget"></iframe>
                    <div class="text-xs text-gray-400 mt-2">資料來源：Google Weather。</div>
                </div>

                <div class="flex overflow-x-auto hide-scrollbar space-x-3 mb-6 pb-2">
                    <div v-for="(day, index) in tripDays" :key="index" @click="currentDayIndex = index"
                        :class="['flex-shrink-0 w-20 h-20 rounded-2xl flex flex-col items-center justify-center cursor-pointer transition-colors',
                                  currentDayIndex === index ? 'bg-kyoto-secondary text-white shadow-lg' : 'bg-white text-kyoto-secondary']">
                        <span class="text-xs opacity-80">Day {{ index + 1 }}</span>
                        <span class="text-2xl font-bold">{{ day.date }}</span>
                    </div>
                </div>

                <div class="mb-4">
                    <select v-model="itineraryLocationFilter"
                        class="w-full p-3 bg-white rounded-xl border border-gray-200 text-sm">
                        <option value="">所有地點 ({{ currentDayItinerary.length }})</option>
                        <option v-for="loc in uniqueLocations" :value="loc">{{ loc }} ({{ currentDayItinerary.filter(i
                            => i.location === loc).length }})</option>
                    </select>
                </div>


                <div class="timeline-wrapper pb-4">

                    <template v-for="(group, groupName) in groupedItinerary" :key="groupName">
                        <div v-if="group.length > 0 && groupName !== '未定時間'" class="timeline-group-divider">
                            <div class="timeline-group-line"></div>
                            <span class="timeline-group-label">{{ groupName }}</span>
                        </div>
                        <div v-if="group.length > 0 && groupName === '未定時間'" class="timeline-group-divider">
                            <div class="timeline-group-line" style="background-color: #8F7762;"></div>
                            <span class="timeline-group-label" style="background-color: #8F7762;">{{ groupName }}</span>
                        </div>

                        <div v-for="(item, index) in group" :key="item.id" class="timeline-item group">

                            <div class="timeline-dot" :style="{ borderColor: item.time ? '#6A7F60' : '#8F7762' }"></div>

                            <div class="bg-white rounded-2xl p-4 shadow-soft relative overflow-hidden">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex items-center gap-2">
                                        <span v-if="item.time" class="font-bold text-lg text-kyoto-primary">{{ item.time
                                            }}</span>
                                        <span v-else class="text-sm text-gray-400">未定</span>
                                        <span class="font-bold text-xs text-white px-2 py-0.5 rounded-full"
                                            :class="getCategoryColor(item.category)">
                                            {{ getCategoryLabel(item.category) }}
                                        </span>
                                    </div>
                                    <div class="flex gap-2" @click.stop>
                                        <button @click="editItem(item, index)"
                                            class="text-gray-400 hover:text-kyoto-accent"><i
                                                class="fa-solid fa-pen"></i></button>
                                    </div>
                                </div>

                                <div v-if="item.image" class="w-full h-32 bg-gray-100 rounded-lg overflow-hidden mb-3">
                                    <img :src="item.image" class="w-full h-full object-cover" alt="行程圖片">
                                </div>

                                <h3 class="font-bold text-xl text-kyoto-dark">{{ item.name }}</h3>

                                <div class="text-sm text-gray-500 mt-2 space-y-1">
                                    <p v-if="item.expectedMinutes">
                                        <i class="fa-regular fa-clock w-5 text-center"></i> 停留約 {{
                                        Math.floor(item.expectedMinutes / 60) }} 小時 {{ item.expectedMinutes % 60 }} 分
                                    </p>
                                    <p v-if="item.location">
                                        <i class="fa-solid fa-earth-asia w-5 text-center"></i> 地點: {{ item.location }}
                                    </p>
                                    <p v-if="item.category === 'flight'">
                                        <i class="fa-solid fa-plane-departure w-5 text-center"></i> 預計出發: {{
                                        item.flightTime || '時間待定' }}
                                    </p>
                                    <p v-if="item.notes" class="text-kyoto-accent mt-2 text-xs"><i
                                            class="fa-regular fa-note-sticky w-5 text-center"></i> {{ item.notes }}</p>
                                </div>

                                <button v-if="item.mapLink" @click.stop="openMap(item.mapLink, item.name)"
                                    class="mt-4 w-full bg-kyoto-bg text-kyoto-primary py-2 rounded-lg text-sm font-bold active:bg-kyoto-secondary/10 transition-colors">
                                    <i class="fa-solid fa-location-arrow mr-1"></i> 導航前往
                                </button>
                            </div>

                            <template v-if="isNotLastItemInGroup(item, group)">
                                <div class="traffic-divider h-10">
                                    <div class="traffic-line-segment absolute inset-0 top-0 bottom-0 left-[7px]"></div>
                                    <div
                                        class="text-xs text-kyoto-secondary opacity-80 bg-kyoto-bg px-2 rounded-full relative z-10 flex items-center gap-1">
                                        約 {{ group[getIndexOfItem(item, group)+1].travelTime }} 分鐘
                                        <i :class="getTransportIcon(group[getIndexOfItem(item, group)+1].transportType)"
                                            class="ml-1 text-sm text-kyoto-accent"></i>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>

                    <div v-if="currentDayItinerary.length === 0" class="text-center text-gray-400 py-10">
                        <i class="fa-solid fa-map-location-dot text-4xl mb-3"></i>
                        <p>尚無行程，點擊右下角新增</p>
                    </div>
                </div>

                <button @click="openModal()"
                    class="fixed bottom-[90px] right-6 w-14 h-14 bg-kyoto-dark text-white rounded-full shadow-float flex items-center justify-center text-2xl fab-button active:scale-95 transition-transform">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <div v-if="currentTab === 'strategy'" class="pb-4">

                <div class="flex overflow-x-auto hide-scrollbar space-x-2 mb-6">
                    <div @click="strategyFilter = null; strategyLocationFilter = ''"
                        :class="['flex-shrink-0 w-24 h-20 rounded-2xl flex flex-col items-center justify-center cursor-pointer transition-colors', strategyFilter === null && strategyLocationFilter === '' ? 'bg-kyoto-secondary text-white shadow-lg' : 'bg-white text-kyoto-secondary']">
                        <span class="text-sm">全部</span>
                        <span class="text-2xl font-bold">{{ strategyList.length }}</span>
                    </div>
                    <div v-for="(cat, key) in strategyCategories" :key="key" @click="strategyFilter = key"
                        :class="['flex-shrink-0 w-24 h-20 rounded-2xl flex flex-col items-center justify-center cursor-pointer transition-colors', strategyFilter === key ? getCategoryColor(key) + ' text-white shadow-lg' : 'bg-white text-kyoto-secondary']">
                        <span class="text-sm">{{ cat.label }}</span>
                        <span class="text-2xl font-bold">{{ strategyList.filter(w => w.category === key).length
                            }}</span>
                    </div>
                </div>

                <div class="mb-4">
                    <select v-model="strategyLocationFilter"
                        class="w-full p-3 bg-white rounded-xl border border-gray-200 text-sm">
                        <option value="">所有地點</option>
                        <option v-for="loc in uniqueStrategyLocations" :value="loc">{{ loc }}</option>
                    </select>
                </div>

                <div class="space-y-4">
                    <div v-for="(strategy, index) in filteredStrategyList" :key="strategy.id"
                        class="bg-white rounded-2xl p-4 shadow-soft relative flex gap-3 items-start">
                        <div class="absolute top-0 left-0 w-1.5 h-full rounded-tl-2xl rounded-bl-2xl"
                            :class="getCategoryColor(strategy.category)"></div>
                        <div class="pl-2 flex-1">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-bold text-lg text-kyoto-dark">{{ strategy.name }}</h3>
                                <div class="flex gap-2">
                                    <span class="text-yellow-400 text-sm flex items-center">
                                        <i v-for="n in 5" :key="n"
                                            :class="['fa-star', n <= strategy.rating ? 'fa-solid' : 'fa-regular']"></i>
                                    </span>
                                    <button @click="editStrategy(strategy, index)"
                                        class="text-gray-400 hover:text-kyoto-accent"><i
                                            class="fa-solid fa-pen"></i></button>
                                    <button @click="removeStrategy(strategy.id)"
                                        class="text-gray-400 hover:text-red-500"><i
                                            class="fa-solid fa-xmark"></i></button>
                                </div>
                            </div>

                            <div class="text-sm text-gray-500">
                                <span class="inline-block px-2 py-0.5 text-xs rounded-full text-white"
                                    :class="getCategoryColor(strategy.category)">{{ getCategoryLabel(strategy.category)
                                    }}</span>
                                <p v-if="strategy.location" class="mt-1 text-xs text-kyoto-secondary"><i
                                        class="fa-solid fa-location-dot mr-1"></i>{{ strategy.location }}</p>
                                <p v-if="strategy.notes" class="mt-2 text-xs text-gray-600">{{ strategy.notes }}</p>
                            </div>

                            <div class="flex flex-wrap gap-2 mt-3">
                                <a v-if="strategy.externalLink" :href="strategy.externalLink" target="_blank"
                                    class="inline-flex items-center text-kyoto-primary text-sm font-medium hover:underline bg-kyoto-bg px-2 py-1 rounded-full">
                                    <i class="fa-solid fa-book-open-reader mr-1"></i> 攻略連結
                                </a>
                                <button v-if="strategy.mapLink" @click.stop="openMap(strategy.mapLink, strategy.name)"
                                    class="inline-flex items-center text-kyoto-accent text-sm font-medium hover:underline bg-kyoto-bg px-2 py-1 rounded-full">
                                    <i class="fa-solid fa-location-arrow mr-1"></i> 導航前往
                                </button>
                            </div>
                        </div>
                    </div>

                    <div v-if="filteredStrategyList.length === 0" class="text-center text-gray-400 py-10">
                        <i class="fa-solid fa-map-marked-alt text-4xl mb-3"></i>
                        <p>此類別暫無攻略項目</p>
                    </div>
                </div>

                <button @click="openStrategyModal"
                    class="fixed bottom-[90px] right-6 w-14 h-14 bg-kyoto-primary text-white rounded-full shadow-float flex items-center justify-center text-2xl fab-button">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <div v-if="currentTab === 'calculator'" class="pb-4">
                <div class="bg-kyoto-bg rounded-2xl p-6 shadow-soft">
                    <div class="text-right mb-4">
                        <div class="text-sm text-gray-500 flex justify-between items-center mb-1">
                            <span>當前匯率: 1 JPY = {{ exchange.rate }} TWD</span>
                            <button @click="openInfoEditModal('exchange')"
                                class="text-kyoto-primary hover:text-kyoto-accent text-sm"><i
                                    class="fa-solid fa-pen text-xs"></i> 調整</button>
                        </div>

                        <div class="bg-white p-3 rounded-xl shadow-inner mb-4">
                            <label class="text-xs text-gray-500 block">日幣 (JPY)</label>
                            <div class="text-3xl font-bold text-kyoto-dark h-10 overflow-hidden">
                                {{ currentInput.jpy || 0 }}
                            </div>
                        </div>

                        <div class="bg-white p-3 rounded-xl shadow-inner">
                            <label class="text-xs text-gray-500 block">台幣 (TWD)</label>
                            <div class="text-3xl font-bold text-kyoto-accent h-10 overflow-hidden">
                                <i class="fa-solid fa-equals text-lg mr-2"></i> {{ exchange.twd || 0 }}
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-4 gap-3">
                        <button @click="clearInput" class="calc-key bg-calculator-op text-white col-span-2">AC</button>
                        <button @click="deleteDigit" class="calc-key bg-calculator-op text-white"><i
                                class="fa-solid fa-delete-left"></i></button>
                        <button @click="toggleSign" class="calc-key bg-calculator-op text-white">±</button>

                        <button @click="appendDigit('7')" class="calc-key bg-white text-kyoto-dark">7</button>
                        <button @click="appendDigit('8')" class="calc-key bg-white text-kyoto-dark">8</button>
                        <button @click="appendDigit('9')" class="calc-key bg-white text-kyoto-dark">9</button>
                        <button @click="swapCurrencies" class="calc-key bg-calculator-op text-white"><i
                                class="fa-solid fa-arrow-up-down"></i></button>

                        <button @click="appendDigit('4')" class="calc-key bg-white text-kyoto-dark">4</button>
                        <button @click="appendDigit('5')" class="calc-key bg-white text-kyoto-dark">5</button>
                        <button @click="appendDigit('6')" class="calc-key bg-white text-kyoto-dark">6</button>
                        <button class="calc-key bg-calculator-keypad text-kyoto-dark opacity-50" disabled>JPY</button>

                        <button @click="appendDigit('1')" class="calc-key bg-white text-kyoto-dark">1</button>
                        <button @click="appendDigit('2')" class="calc-key bg-white text-kyoto-dark">2</button>
                        <button @click="appendDigit('3')" class="calc-key bg-white text-kyoto-dark">3</button>
                        <button class="calc-key bg-calculator-keypad text-kyoto-dark opacity-50" disabled>TWD</button>

                        <button @click="appendDigit('0')"
                            class="calc-key bg-white text-kyoto-dark col-span-2">0</button>
                        <button @click="appendDecimal" class="calc-key bg-white text-kyoto-dark">.</button>
                        <button @click="calculateResult" class="calc-key bg-calculator-equal text-white"><i
                                class="fa-solid fa-check"></i></button>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'expense'" class="pb-4 space-y-6">
                <div class="bg-kyoto-dark text-white rounded-2xl p-4 shadow-soft text-center">
                    <div class="text-sm opacity-80">總花費 (JPY)</div>
                    <div class="text-3xl font-bold mt-1">¥ {{ totalExpense.toLocaleString() }}</div>
                </div>

                <div class="space-y-3">
                    <div v-for="(exp, index) in expenses" :key="exp.id"
                        class="bg-white rounded-xl p-4 shadow-sm flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-10 h-10 rounded-full bg-kyoto-bg flex items-center justify-center text-kyoto-primary">
                                <i :class="getExpenseIcon(exp.category)"></i>
                            </div>
                            <div>
                                <div class="font-bold text-gray-800">{{ exp.name }}</div>
                                <div class="text-xs text-gray-400">{{ exp.date }} · {{ exp.method === 'cash' ? '現金' :
                                    '信用卡' }}</div>
                                <div v-if="exp.split" class="text-xs text-kyoto-secondary mt-0.5">
                                    <i class="fa-solid fa-user-group text-xs mr-1"></i>分帳: {{ exp.split }}
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button @click="editExpense(exp, index)" class="text-gray-400 hover:text-kyoto-accent"><i
                                    class="fa-solid fa-pen text-sm"></i></button>
                            <div class="font-bold text-kyoto-dark">¥ {{ parseInt(exp.amount).toLocaleString() }}</div>
                        </div>
                    </div>

                    <div v-if="expenses.length === 0" class="text-center text-gray-400 py-10">
                        <i class="fa-solid fa-yen-sign text-4xl mb-3"></i>
                        <p>點擊右下角新增記帳</p>
                    </div>
                </div>

                <button @click="openExpenseModal"
                    class="fixed bottom-[90px] right-6 w-14 h-14 bg-yellow-600 text-white rounded-full shadow-float flex items-center justify-center text-2xl fab-button">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <div v-if="currentTab === 'info'" class="space-y-6 pb-4">
                <section class="bg-white rounded-2xl p-5 shadow-soft">
                    <h3
                        class="text-xl font-bold text-kyoto-primary mb-4 border-b pb-2 flex justify-between items-center">
                        <i class="fa-solid fa-list-check mr-2"></i>行前 Check List
                        <button @click="infoEditMode = !infoEditMode"
                            class="text-sm text-gray-400 hover:text-kyoto-accent">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                    </h3>
                    <div class="space-y-2">
                        <div v-for="(item, index) in checklist" :key="index" class="flex items-center gap-3">
                            <input type="checkbox" v-model="item.checked" @change="saveToLocal"
                                class="form-checkbox text-kyoto-primary h-5 w-5 rounded focus:ring-0">
                            <span :class="{'line-through text-gray-400': item.checked}">{{ item.text }}</span>
                            <button v-if="infoEditMode" @click="removeChecklistItem(index)"
                                class="text-red-400 ml-auto"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                        <div v-if="infoEditMode" class="flex gap-2 pt-2">
                            <input type="text" v-model="newChecklistItem" @keyup.enter="addChecklistItem"
                                placeholder="新增項目..."
                                class="flex-1 p-2 bg-gray-50 rounded text-sm border focus:border-kyoto-primary">
                            <button @click="addChecklistItem"
                                class="bg-kyoto-primary text-white px-3 rounded text-sm">新增</button>
                        </div>
                    </div>
                </section>

                <section class="bg-white rounded-2xl p-5 shadow-soft">
                    <h3
                        class="text-lg font-bold text-kyoto-primary mb-4 border-b pb-2 flex justify-between items-center">
                        <i class="fa-solid fa-plane mr-2"></i>航班資訊
                        <button @click="openInfoEditModal('flight')"
                            class="text-sm text-gray-400 hover:text-kyoto-accent">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                    </h3>
                    <pre class="text-sm text-gray-700 whitespace-pre-wrap">{{ infoForms.flight }}</pre>
                </section>

                <section class="bg-white rounded-2xl p-5 shadow-soft">
                    <h3
                        class="text-lg font-bold text-kyoto-primary mb-4 border-b pb-2 flex justify-between items-center">
                        <i class="fa-solid fa-hotel mr-2"></i>住宿資訊
                        <button @click="openHotelModal()"
                            class="text-kyoto-primary hover:text-kyoto-accent text-sm font-bold">
                            <i class="fa-solid fa-plus mr-1"></i>新增
                        </button>
                    </h3>
                    <div v-if="hotelList.length === 0" class="text-center text-gray-400 py-5 text-sm">
                        <p>暫無住宿資訊</p>
                    </div>
                    <div v-for="(hotel, index) in hotelList" :key="index"
                        class="mb-4 pb-4 border-b last:border-b-0 last:pb-0">
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold text-kyoto-dark text-lg">{{ hotel.name }}</h4>
                            <div class="flex gap-2">
                                <button @click="openHotelModal(hotel, index)"
                                    class="text-gray-400 hover:text-kyoto-accent"><i
                                        class="fa-solid fa-pen"></i></button>
                                <button @click="deleteHotel(index)" class="text-gray-400 hover:text-red-500"><i
                                        class="fa-solid fa-trash-can"></i></button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-500 mt-1"><i class="fa-solid fa-calendar-day w-5 text-center"></i>
                            {{ hotel.period }}</p>
                        <p class="text-sm text-gray-500 mt-1"><i class="fa-solid fa-phone w-5 text-center"></i> {{
                            hotel.phone }}</p>
                        <p class="text-sm text-gray-500 mt-1"><i class="fa-solid fa-location-dot w-5 text-center"></i>
                            {{ hotel.address }}</p>
                        <a v-if="hotel.mapLink" :href="hotel.mapLink" target="_blank"
                            class="block mt-3 text-center bg-kyoto-bg text-kyoto-primary py-2 rounded-lg text-sm font-bold">導航前往</a>
                    </div>
                </section>
            </div>

        </main>

        <nav
            class="fixed bottom-0 left-0 w-full h-[70px] bg-white shadow-float flex justify-around items-center z-50 rounded-t-2xl">
            <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id" :class="['flex flex-col items-center justify-center p-2 transition-colors', 
                             currentTab === tab.id ? 'text-kyoto-dark' : 'text-gray-400']">
                <i :class="tab.icon" class="text-xl"></i>
                <span class="text-xs mt-1">{{ tab.label }}</span>
            </button>
        </nav>

        <transition name="modal">
            <div v-if="showModal.itinerary" class="fixed inset-0 bg-black/50 z-50 flex items-end justify-center p-4">
                <div class="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl modal-content">
                    <h3 class="text-xl font-bold mb-4 text-kyoto-dark">{{ isEditMode ? '編輯行程' : '新增行程' }}</h3>

                    <div class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                        <select v-model="form.category" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                            <option value="attraction">景點</option>
                            <option value="food">美食</option>
                            <option value="shopping">購物</option>
                            <option value="flight">航班</option>
                            <option value="hotel">住宿</option>
                            <option value="other">其他</option>
                        </select>
                        <input type="text" v-model="form.name" placeholder="名稱 (例如: 清水寺)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">

                        <select v-model="form.location" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                            <option value="">選擇地點 (城市/區域)</option>
                            <option value="Kyoto">京都</option>
                            <option value="Osaka">大阪</option>
                            <option value="Nara">奈良</option>
                            <option value="Kansai Airport">關西機場</option>
                            <option value="Other">其他</option>
                        </select>

                        <div class="flex gap-3">
                            <div class="flex-1">
                                <label class="text-xs text-gray-500 mb-1 block">預計時間 (HH:MM)</label>
                                <input type="time" v-model="form.time"
                                    class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                            </div>
                            <div class="w-32">
                                <label class="text-xs text-gray-500 mb-1 block">停留時間 (分鐘)</label>
                                <input type="number" v-model.number="form.expectedMinutes" placeholder="例如: 90"
                                    class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                            </div>
                        </div>

                        <div v-if="form.category === 'flight'" class="bg-kyoto-bg p-3 rounded-xl">
                            <label class="text-xs text-gray-500 mb-1 block">航班資訊 (去/回程時間)</label>
                            <input type="text" v-model="form.flightTime" placeholder="TPE 10:00 -> KIX 13:30"
                                class="w-full p-2 bg-white rounded border border-gray-200">
                        </div>

                        <input type="url" v-model="form.mapLink" placeholder="Google Map 導航連結"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                        <input type="text" v-model="form.ticket" placeholder="門票費用 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200"
                            v-if="form.category === 'attraction'">

                        <div class="bg-kyoto-bg p-3 rounded-xl">
                            <label class="text-xs text-kyoto-dark font-bold mb-1 block">交通方式與時間 (距離上一站)</label>
                            <div class="flex gap-2">
                                <select v-model="form.transportType"
                                    class="p-3 bg-white rounded-xl border border-gray-200 text-sm flex-1 min-w-0">
                                    <option value="walk">步行</option>
                                    <option value="car">汽車</option>
                                    <option value="transit">大眾運輸</option>
                                    <option value="plane">飛機</option>
                                    <option value="none">無 (起點/終點)</option>
                                </select>
                                <input type="number" v-model.number="form.travelTime" placeholder="分鐘"
                                    class="p-3 bg-white rounded-xl border border-gray-200 text-sm w-24">
                            </div>
                        </div>

                        <div class="mt-4">
                            <label class="block text-sm text-gray-500 mb-1">上傳參考圖 (選填)</label>
                            <input type="file" @change="handleItineraryImage" accept="image/*" class="text-sm">
                            <div v-if="form.image"
                                class="h-20 w-20 bg-gray-100 rounded-xl mt-2 overflow-hidden relative">
                                <img :src="form.image" class="w-full h-full object-cover">
                                <button @click="form.image = null"
                                    class="absolute top-0 right-0 p-1 bg-black/50 text-white rounded-bl-lg text-xs">x</button>
                            </div>
                        </div>

                        <textarea v-model="form.notes" placeholder="特色 & 備註"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 h-24"></textarea>
                    </div>

                    <div class="flex gap-3 mt-6">
                        <button v-if="isEditMode" @click="deleteItem"
                            class="flex-1 bg-red-100 text-red-500 py-3 rounded-xl font-bold">刪除</button>
                        <button @click="closeModal"
                            class="flex-1 bg-gray-200 text-gray-600 py-3 rounded-xl font-bold">取消</button>
                        <button @click="saveItinerary"
                            class="flex-1 bg-kyoto-primary text-white py-3 rounded-xl font-bold">確認</button>
                    </div>
                </div>
            </div>

            <div v-if="showModal.strategy" class="fixed inset-0 bg-black/50 z-50 flex items-end justify-center p-4">
                <div class="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl modal-content">
                    <h3 class="text-xl font-bold mb-4 text-kyoto-dark">{{ isStrategyEditMode ? '編輯攻略項目' : '新增攻略項目' }}
                    </h3>
                    <div class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                        <select v-model="strategyForm.category"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                            <option v-for="(cat, key) in strategyCategories" :value="key">{{ cat.label }}</option>
                        </select>
                        <input type="text" v-model="strategyForm.name" placeholder="攻略項目名稱"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">

                        <select v-model="strategyForm.location"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                            <option value="">選擇地點 (城市/區域)</option>
                            <option value="Kyoto">京都</option>
                            <option value="Osaka">大阪</option>
                            <option value="Nara">奈良</option>
                            <option value="Kansai Airport">關西機場</option>
                            <option value="Other">其他</option>
                        </select>

                        <div class="bg-gray-50 p-3 rounded-xl flex items-center gap-3">
                            <span class="text-sm text-gray-500">想要程度:</span>
                            <div class="flex text-2xl text-yellow-400">
                                <i v-for="n in 5" :key="n" @click="strategyForm.rating = n"
                                    :class="['cursor-pointer fa-star', n <= strategyForm.rating ? 'fa-solid' : 'fa-regular']">
                                </i>
                            </div>
                        </div>

                        <input type="url" v-model="strategyForm.externalLink" placeholder="攻略連結 (網址)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
                        <input type="url" v-model="strategyForm.mapLink" placeholder="Google Map 導航連結 (選填)"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">

                        <textarea v-model="strategyForm.notes" placeholder="備註/說明"
                            class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 h-20"></textarea>
                    </div>

                    <div class="flex gap-3 mt-4">
                        <button v-if="isStrategyEditMode" @click="deleteStrategyItem"
                            class="flex-1 bg-red-100 text-red-500 py-3 rounded-xl font-bold">刪除</button>
                        <button @click="showModal.strategy = false"
                            class="flex-1 bg-gray-200 py-3 rounded-xl">取消</button>
                        <button @click="saveStrategy"
                            class="flex-1 bg-kyoto-primary text-white py-3 rounded-xl">確認</button>
                    </div>
                </div>
            </div>

            <div v-if="showModal.expense" class="fixed inset-0 bg-black/50 z-50 flex items-end justify-center p-4">
                <div class="bg-white w-full max-w-md rounded-2xl p-6 modal-content">
                    <h3 class="text-xl font-bold mb-4">{{ isExpenseEditMode ? '編輯花費' : '新增記帳' }}</h3>
                    <div class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                        <select v-model="expenseForm.category" class="w-full p-3 bg-gray-50 rounded-xl">
                            <option value="food">飲食</option>
                            <option value="transport">交通</option>
                            <option value="hotel">住宿</option>
                            <option value="ticket">門票</option>
                            <option value="shopping">購物</option>
                            <option value="other">其他</option>
                        </select>
                        <input type="text" v-model="expenseForm.name" placeholder="項目名稱"
                            class="w-full p-3 bg-gray-50 rounded-xl">
                        <input type="date" v-model="expenseForm.date" class="w-full p-3 bg-gray-50 rounded-xl">
                        <input type="number" v-model.number="expenseForm.amount" placeholder="金額 (日幣)"
                            class="w-full p-3 bg-gray-50 rounded-xl">

                        <div class="flex gap-2">
                            <label class="flex items-center gap-2 p-3 bg-gray-50 rounded-xl flex-1">
                                <input type="radio" value="cash" v-model="expenseForm.method"> 現金
                            </label>
                            <label class="flex items-center gap-2 p-3 bg-gray-50 rounded-xl flex-1">
                                <input type="radio" value="card" v-model="expenseForm.method"> 信用卡
                            </label>
                        </div>

                        <select v-model="expenseForm.split" class="w-full p-3 bg-gray-50 rounded-xl">
                            <option value="">不分帳 (個人花費)</option>
                            <option value="AA">AA制 (平均分攤)</option>
                            <option value="Group">團體共用</option>
                            <option value="P1">成員 P1 代墊</option>
                            <option value="P2">成員 P2 代墊</option>
                        </select>
                        <textarea v-model="expenseForm.notes" placeholder="備註 (例如：分帳細節)"
                            class="w-full p-3 bg-gray-50 rounded-xl border h-16"></textarea>
                    </div>
                    <div class="flex gap-3 mt-4">
                        <button v-if="isExpenseEditMode" @click="deleteExpenseItem"
                            class="flex-1 bg-red-100 text-red-500 py-3 rounded-xl font-bold">刪除</button>
                        <button @click="showModal.expense = false"
                            class="flex-1 bg-gray-200 py-3 rounded-xl">取消</button>
                        <button @click="saveExpense" class="flex-1 bg-yellow-600 text-white py-3 rounded-xl">確認</button>
                    </div>
                </div>
            </div>

            <div v-if="showModal.infoEdit" class="fixed inset-0 bg-black/50 z-50 flex items-end justify-center p-4">
                <div class="bg-white w-full max-w-md rounded-2xl p-6 modal-content">
                    <h3 class="text-xl font-bold mb-4">編輯 {{ infoEditTargetLabel }}</h3>
                    <div class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                        <div v-if="infoEditTarget === 'flight'">
                            <textarea v-model="infoForms.flight" placeholder="輸入航班資訊"
                                class="w-full p-3 bg-gray-50 rounded-xl border h-32"></textarea>
                        </div>
                        <div v-if="infoEditTarget === 'exchange'">
                            <label class="text-sm text-gray-500 mb-1 block">當前匯率 (1 JPY = ? TWD)</label>
                            <input type="number" v-model.number="exchange.rate" placeholder="0.20"
                                class="w-full p-3 bg-gray-50 rounded-xl border">
                        </div>
                    </div>
                    <div class="flex gap-3 mt-4">
                        <button @click="showModal.infoEdit = false"
                            class="flex-1 bg-gray-200 py-3 rounded-xl">取消</button>
                        <button @click="saveInfoEdit"
                            class="flex-1 bg-kyoto-primary text-white py-3 rounded-xl">儲存</button>
                    </div>
                </div>
            </div>

            <div v-if="showModal.hotel" class="fixed inset-0 bg-black/50 z-50 flex items-end justify-center p-4">
                <div class="bg-white w-full max-w-md rounded-2xl p-6 modal-content">
                    <h3 class="text-xl font-bold mb-4">{{ isHotelEditMode ? '編輯住宿資訊' : '新增住宿資訊' }}</h3>
                    <div class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                        <input type="text" v-model="hotelForm.name" placeholder="飯店名稱"
                            class="w-full p-3 bg-gray-50 rounded-xl border">
                        <input type="text" v-model="hotelForm.period" placeholder="入住/退房日期 (例如：3/6 - 3/8)"
                            class="w-full p-3 bg-gray-50 rounded-xl border">
                        <input type="tel" v-model="hotelForm.phone" placeholder="電話"
                            class="w-full p-3 bg-gray-50 rounded-xl border">
                        <input type="text" v-model="hotelForm.address" placeholder="地址"
                            class="w-full p-3 bg-gray-50 rounded-xl border">
                        <input type="url" v-model="hotelForm.mapLink" placeholder="導航連結 (Google Map)"
                            class="w-full p-3 bg-gray-50 rounded-xl border">
                    </div>
                    <div class="flex gap-3 mt-4">
                        <button v-if="isHotelEditMode" @click="deleteHotel(editingHotelIndex); showModal.hotel = false;"
                            class="flex-1 bg-red-100 text-red-500 py-3 rounded-xl font-bold">刪除</button>
                        <button @click="showModal.hotel = false" class="flex-1 bg-gray-200 py-3 rounded-xl">取消</button>
                        <button @click="saveHotel"
                            class="flex-1 bg-kyoto-primary text-white py-3 rounded-xl">儲存</button>
                    </div>
                </div>
            </div>
        </transition>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                // 資料狀態
                const currentTab = ref('itinerary');
                const headerImage = ref('https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?q=80&w=1920&auto=format&fit=crop');
                const currentDayIndex = ref(0);
                const itineraryLocationFilter = ref('');
                const strategyLocationFilter = ref('');

                // 3. Google 天氣 Iframe URL
                const weatherIframeSrc = ref('https://www.google.com/search?q=%E5%A4%A7%E9%98%AA%E4%BA%AC%E9%83%BD%E5%A4%A9%E6%B0%A3&igu=1&ei=W-g6ZfP6I-mXkPIPleT70A0&safe=active&output=embed');

                // 行程日期
                const tripDays = ref([
                    { date: '3/6', week: 'Fri', fullDate: '2026-03-06' },
                    { date: '3/7', week: 'Sat', fullDate: '2026-03-07' },
                    { date: '3/8', week: 'Sun', fullDate: '2026-03-08' },
                    { date: '3/9', week: 'Mon', fullDate: '2026-03-09' },
                    { date: '3/10', week: 'Tue', fullDate: '2026-03-10' },
                    { date: '3/11', week: 'Wed', fullDate: '2026-03-11' },
                ]);

                // 核心資料
                const itineraryData = ref({
                    0: [
                        { id: 1, category: 'flight', name: '前往大阪 (TPE -> KIX)', transportType: 'plane', travelTime: 0, notes: '記得帶護照', mapLink: 'https://maps.app.goo.gl/9', flightTime: '10:00 - 13:30', time: '10:00', expectedMinutes: 210, location: 'Kansai Airport' },
                        { id: 2, category: 'hotel', name: 'Check-in: Hotel Kanra Kyoto', transportType: 'transit', travelTime: 90, expectedMinutes: 60, mapLink: 'https://maps.app.goo.gl/10', time: '16:00', location: 'Kyoto' }
                    ]
                });

                // 8. 攻略清單 (原 wishlist)
                const strategyList = ref([{ id: 101, name: '任天堂大阪旗艦店', category: 'shopping-place', externalLink: 'https://www.nintendo.co.jp/store/osaka/index.html', notes: '想買限定周邊', mapLink: 'https://maps.app.goo.gl/osaka', rating: 4, location: 'Osaka' }]);
                const expenses = ref([]);
                const hotelList = ref([]);

                // 匯率 (計算機專用)
                const exchange = ref({ rate: 0.20, twd: '0' });
                const currentInput = ref({ jpy: '', twd: '' });

                // Modal 控制與表單
                const showModal = ref({ itinerary: false, expense: false, strategy: false, infoEdit: false, hotel: false });
                const isEditMode = ref(false);
                const isStrategyEditMode = ref(false);
                const isExpenseEditMode = ref(false);
                const isHotelEditMode = ref(false);

                const editingId = ref(null);
                const editingIndex = ref(null);
                const editingStrategyIndex = ref(null);
                const editingHotelIndex = ref(null);

                const form = ref({
                    category: 'attraction', name: '', notes: '', transportType: 'walk', travelTime: 15, mapLink: '',
                    time: '', expectedMinutes: null, flightTime: '', ticket: '', image: null, location: ''
                });

                const strategyForm = ref({
                    id: null, name: '', category: 'attraction', externalLink: '', notes: '',
                    mapLink: '', rating: 3, location: ''
                });

                const expenseForm = ref({ id: null, category: 'food', name: '', date: '', amount: null, method: 'cash', split: '', notes: '' });
                const hotelForm = ref({ name: '', period: '', phone: '', address: '', mapLink: '' });

                // 資訊區編輯
                const infoEditMode = ref(false);
                const newChecklistItem = ref('');
                const infoEditTarget = ref(null);
                const infoEditTargetLabel = ref('');

                // 預設 Check List
                const checklist = ref([
                    { text: '護照/簽證', checked: false },
                    { text: '機票/住宿/車票電子檔', checked: false },
                    { text: '外幣現金 (日幣)', checked: false },
                    { text: '信用卡/提款卡開通', checked: false },
                    { text: '租用 Wifi 或 Sim 卡', checked: false },
                ]);

                // 資訊區預設資訊
                const infoForms = ref({
                    flight: `去程：TPE 10:00 -> KIX 13:30 (BR132)
回程：KIX 17:00 -> TPE 19:30 (BR131)`,
                });

                // UI 相關設定
                const tabs = [
                    { id: 'itinerary', icon: 'fa-solid fa-map-location-dot', label: '行程' },
                    { id: 'strategy', icon: 'fa-solid fa-book-reader', label: '攻略' },
                    { id: 'calculator', icon: 'fa-solid fa-calculator', label: '匯率' },
                    { id: 'expense', icon: 'fa-solid fa-yen-sign', label: '花費' },
                    { id: 'info', icon: 'fa-solid fa-circle-info', label: '資訊' }
                ];

                const categoryMap = {
                    attraction: { label: '景點', color: 'bg-red-400' },
                    food: { label: '美食', color: 'bg-orange-400' },
                    shopping: { label: '購物', color: 'bg-pink-400' },
                    flight: { label: '航班', color: 'bg-blue-400' },
                    hotel: { label: '住宿', color: 'bg-indigo-400' },
                    other: { label: '其他', color: 'bg-gray-400' }
                };

                const strategyCategories = {
                    attraction: { label: '景點', color: 'bg-red-500' },
                    food: { label: '美食', color: 'bg-orange-500' },
                    'shopping-place': { label: '購物地點', color: 'bg-pink-500' },
                    'good-item': { label: '好物推薦', color: 'bg-teal-500' },
                    traffic: { label: '交通/票券', color: 'bg-blue-500' },
                    other: { label: '其他', color: 'bg-gray-500' }
                };

                const strategyFilter = ref(null);

                // 計算屬性
                const currentDayItinerary = computed(() => {
                    const items = itineraryData.value[currentDayIndex.value] || [];
                    if (!itineraryLocationFilter.value) return items;
                    return items.filter(item => item.location === itineraryLocationFilter.value);
                });

                // 行程分組
                const groupedItinerary = computed(() => {
                    const sorted = [...currentDayItinerary.value].sort((a, b) => {
                        if (!a.time && !b.time) return 0;
                        if (!a.time) return 1;
                        if (!b.time) return -1;
                        return a.time.localeCompare(b.time);
                    });

                    const groups = { '上午 (08:00 - 12:00)': [], '下午 (12:00 - 18:00)': [], '晚上 (18:00 - 00:00)': [], '未定時間': [] };

                    sorted.forEach(item => {
                        if (!item.time) {
                            groups['未定時間'].push(item);
                            return;
                        }
                        const hour = parseInt(item.time.split(':')[0]);
                        if (hour >= 8 && hour < 12) groups['上午 (08:00 - 12:00)'].push(item);
                        else if (hour >= 12 && hour < 18) groups['下午 (12:00 - 18:00)'].push(item);
                        else groups['晚上 (18:00 - 00:00)'].push(item);
                    });

                    const finalGroups = {};
                    ['上午 (08:00 - 12:00)', '下午 (12:00 - 18:00)', '晚上 (18:00 - 00:00)', '未定時間'].forEach(key => {
                        if (groups[key].length > 0) {
                            finalGroups[key] = groups[key];
                        }
                    });

                    return finalGroups;
                });

                // 行程唯一地點列表
                const uniqueLocations = computed(() => {
                    const allItems = itineraryData.value[currentDayIndex.value] || [];
                    const locations = new Set(allItems.map(item => item.location).filter(Boolean));
                    return Array.from(locations).sort();
                });

                // 攻略相關計算屬性
                const filteredStrategyList = computed(() => {
                    let list = strategyList.value;
                    if (strategyFilter.value) {
                        list = list.filter(w => w.category === strategyFilter.value);
                    }
                    if (strategyLocationFilter.value) {
                        list = list.filter(w => w.location === strategyLocationFilter.value);
                    }
                    return list;
                });

                // 攻略唯一地點列表
                const uniqueStrategyLocations = computed(() => {
                    const locations = new Set(strategyList.value.map(item => item.location).filter(Boolean));
                    return Array.from(locations).sort();
                });

                const totalExpense = computed(() => {
                    return expenses.value.reduce((sum, item) => sum + Number(item.amount), 0);
                });

                // --- 方法 Methods ---

                // --- 標頭圖片上傳 (修復 ReferenceError: uploadHeader) ---
                const uploadHeader = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => headerImage.value = event.target.result;
                        reader.readAsDataURL(file);
                        saveToLocal(); // 儲存新圖片連結
                    }
                };

                // --- 計算機邏輯 ---
                const calculateResult = () => {
                    // 確保 JPY 數值是有效的
                    let jpyValue = currentInput.value.jpy;
                    if (jpyValue.endsWith('.')) jpyValue = jpyValue.slice(0, -1);
                    const parsedJpy = parseFloat(jpyValue);

                    const rate = parseFloat(exchange.value.rate);

                    if (isNaN(parsedJpy) || isNaN(rate) || rate <= 0) {
                        exchange.value.twd = '0';
                        return;
                    }
                    // 四捨五入到小數點後兩位
                    exchange.value.twd = (parsedJpy * rate).toFixed(2);
                };

                const clearInput = () => {
                    currentInput.value.jpy = '';
                    exchange.value.twd = '0';
                };

                const deleteDigit = () => {
                    currentInput.value.jpy = currentInput.value.jpy.slice(0, -1);
                    calculateResult();
                };

                const appendDigit = (digit) => {
                    let input = currentInput.value.jpy;
                    if (input === '0' && digit !== '.') {
                        input = digit;
                    }
                    else if (input.includes('.') && input.split('.')[1].length >= 2) {
                        return;
                    }
                    else if (input.length >= 10 && !input.includes('.')) {
                        return;
                    }
                    else {
                        input += digit;
                    }

                    currentInput.value.jpy = input;
                    calculateResult();
                };

                const appendDecimal = () => {
                    if (!currentInput.value.jpy.includes('.')) {
                        currentInput.value.jpy += '.';
                    }
                };

                const toggleSign = () => {
                    if (currentInput.value.jpy.startsWith('-')) {
                        currentInput.value.jpy = currentInput.value.jpy.slice(1);
                    } else if (currentInput.value.jpy.length > 0 && currentInput.value.jpy !== '0') {
                        currentInput.value.jpy = '-' + currentInput.value.jpy;
                    }
                    calculateResult();
                };

                const swapCurrencies = () => {
                    if (exchange.value.twd !== '0') {
                        currentInput.value.jpy = exchange.value.twd;
                        calculateResult();
                    }
                };

                // --- 行程相關 ---
                const openModal = () => {
                    isEditMode.value = false;
                    editingId.value = null;
                    // 初始表單值更新
                    form.value = {
                        category: 'attraction', name: '', notes: '', transportType: 'walk', travelTime: 15, mapLink: '',
                        time: '', expectedMinutes: null, flightTime: '', ticket: '', image: null, location: ''
                    };
                    showModal.value.itinerary = true;
                };

                const editItem = (item, index) => {
                    isEditMode.value = true;
                    editingId.value = item.id;
                    editingIndex.value = index;
                    form.value = {
                        transportType: 'walk',
                        time: '', expectedMinutes: null, flightTime: '', image: null, location: '',
                        ...item
                    };
                    showModal.value.itinerary = true;
                };

                const handleItineraryImage = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => form.value.image = e.target.result;
                        reader.readAsDataURL(file);
                    }
                };

                const saveItinerary = () => {
                    const list = itineraryData.value[currentDayIndex.value] = itineraryData.value[currentDayIndex.value] || [];

                    form.value.travelTime = Number(form.value.travelTime) || 0;
                    form.value.expectedMinutes = Number(form.value.expectedMinutes) || null;

                    if (isEditMode.value) {
                        const index = list.findIndex(i => i.id === editingId.value);
                        if (index !== -1) list[index] = { ...form.value, id: editingId.value };
                    } else {
                        list.push({ ...form.value, id: Date.now() });
                    }
                    saveToLocal();
                    closeModal();
                };

                const deleteItem = () => {
                    if (confirm('確定要刪除此行程嗎？')) {
                        const list = itineraryData.value[currentDayIndex.value];
                        const index = list.findIndex(i => i.id === editingId.value);
                        list.splice(index, 1);
                        saveToLocal();
                        closeModal();
                    }
                };

                const isNotLastItemInGroup = (item, group) => {
                    const index = group.findIndex(i => i.id === item.id);
                    return index < group.length - 1;
                };

                const getIndexOfItem = (item, group) => {
                    return group.findIndex(i => i.id === item.id);
                };

                const openMap = (mapLink, name) => {
                    window.open(mapLink, '_blank');
                };

                // --- 攻略相關 (Strategy) ---
                const openStrategyModal = () => {
                    isStrategyEditMode.value = false;
                    editingStrategyIndex.value = null;
                    strategyForm.value = { id: Date.now(), name: '', category: 'attraction', externalLink: '', notes: '', mapLink: '', rating: 3, location: '' };
                    showModal.value.strategy = true;
                };

                const editStrategy = (strategy, index) => {
                    isStrategyEditMode.value = true;
                    editingStrategyIndex.value = index;
                    strategyForm.value = { ...strategy };
                    showModal.value.strategy = true;
                };

                const saveStrategy = () => {
                    if (isStrategyEditMode.value) {
                        const originalId = strategyList.value[editingStrategyIndex.value].id;
                        strategyList.value[editingStrategyIndex.value] = { ...strategyForm.value, id: originalId };
                    } else {
                        strategyList.value.push({ ...strategyForm.value, id: Date.now() });
                    }
                    saveToLocal();
                    showModal.value.strategy = false;
                };

                const removeStrategy = (idToRemove) => {
                    if (confirm('確定要刪除此攻略項目嗎？')) {
                        const index = strategyList.value.findIndex(strategy => strategy.id === idToRemove);
                        if (index !== -1) {
                            strategyList.value.splice(index, 1);
                            saveToLocal();
                        }
                    }
                }

                const deleteStrategyItem = () => {
                    if (confirm('確定要刪除此攻略項目嗎？')) {
                        strategyList.value.splice(editingStrategyIndex.value, 1);
                        saveToLocal();
                        showModal.value.strategy = false;
                    }
                }

                // --- 花費相關 ---
                const openExpenseModal = () => {
                    isExpenseEditMode.value = false;
                    editingIndex.value = null;
                    expenseForm.value = { id: Date.now(), category: 'food', name: '', date: tripDays.value[currentDayIndex.value].fullDate, amount: null, method: 'cash', split: '', notes: '' };
                    showModal.value.expense = true;
                };

                const editExpense = (exp, index) => {
                    isExpenseEditMode.value = true;
                    editingIndex.value = index;
                    expenseForm.value = { ...exp };
                    showModal.value.expense = true;
                };

                // 注意：這裡修正了舊版本可能存在的 saveShopping 相關呼叫
                const saveExpense = () => {
                    if (isExpenseEditMode.value) {
                        const originalId = expenses.value[editingIndex.value].id;
                        expenses.value[editingIndex.value] = { ...expenseForm.value, id: originalId };
                    } else {
                        expenses.value.push({ ...expenseForm.value, id: Date.now() });
                    }
                    saveToLocal();
                    showModal.value.expense = false;
                };

                const deleteExpenseItem = () => {
                    if (confirm('確定要刪除此花費紀錄嗎？')) {
                        expenses.value.splice(editingIndex.value, 1);
                        saveToLocal();
                        showModal.value.expense = false;
                    }
                }

                // --- 資訊編輯相關 ---
                const openInfoEditModal = (target) => {
                    infoEditTarget.value = target;
                    if (target === 'flight') infoEditTargetLabel.value = '航班資訊';
                    if (target === 'exchange') infoEditTargetLabel.value = '匯率';
                    showModal.value.infoEdit = true;
                };

                const saveInfoEdit = () => {
                    saveToLocal();
                    showModal.value.infoEdit = false;
                    if (infoEditTarget.value === 'exchange') {
                        calculateResult();
                    }
                };

                // --- 住宿資訊相關 ---
                const openHotelModal = (hotel = null, index = null) => {
                    if (hotel) {
                        isHotelEditMode.value = true;
                        editingHotelIndex.value = index;
                        hotelForm.value = { ...hotel };
                    } else {
                        isHotelEditMode.value = false;
                        editingHotelIndex.value = null;
                        hotelForm.value = { name: '', period: '', phone: '', address: '', mapLink: '' };
                    }
                    showModal.value.hotel = true;
                };

                const saveHotel = () => {
                    if (isHotelEditMode.value) {
                        hotelList.value[editingHotelIndex.value] = { ...hotelForm.value };
                    } else {
                        hotelList.value.push({ ...hotelForm.value });
                    }
                    saveToLocal();
                    showModal.value.hotel = false;
                };

                const deleteHotel = (index) => {
                    if (confirm('確定要刪除此住宿紀錄嗎？')) {
                        hotelList.value.splice(index, 1);
                        saveToLocal();
                    }
                }

                // --- 行前 Check List 編輯 ---
                const addChecklistItem = () => {
                    if (newChecklistItem.value.trim() !== '') {
                        checklist.value.push({ text: newChecklistItem.value, checked: false });
                        newChecklistItem.value = '';
                        saveToLocal();
                    }
                };

                const removeChecklistItem = (index) => {
                    checklist.value.splice(index, 1);
                    saveToLocal();
                };

                // --- 工具函數 ---
                const closeModal = () => {
                    showModal.value.itinerary = false;
                };

                const getCategoryColor = (cat) => {
                    const map = { ...categoryMap, ...strategyCategories };
                    return map[cat]?.color || 'bg-gray-400';
                };

                const getCategoryLabel = (cat) => {
                    const map = { ...categoryMap, ...strategyCategories };
                    return map[cat]?.label || '其他';
                };

                const getTransportIcon = (type) => {
                    const map = {
                        walk: 'fa-person-walking',
                        car: 'fa-car',
                        transit: 'fa-train-subway',
                        plane: 'fa-plane',
                        none: 'fa-circle-dot'
                    };
                    return map[type] || 'fa-circle-dot';
                };

                const getExpenseIcon = (cat) => {
                    const map = { food: 'fa-utensils', transport: 'fa-train', hotel: 'fa-bed', ticket: 'fa-ticket', shopping: 'fa-bag-shopping', other: 'fa-coins' };
                    return map[cat] || 'fa-coins';
                };

                // --- LocalStorage ---
                const saveToLocal = () => {
                    const data = {
                        headerImage: headerImage.value,
                        itinerary: itineraryData.value,
                        expenses: expenses.value,
                        strategyList: strategyList.value,
                        infoForms: infoForms.value,
                        checklist: checklist.value,
                        exchangeRate: exchange.value.rate,
                        hotelList: hotelList.value
                    };
                    localStorage.setItem('kyotoTripData_V6', JSON.stringify(data)); // 版本號 V6
                };

                onMounted(() => {
                    const saved = localStorage.getItem('kyotoTripData_V6');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        headerImage.value = parsed.headerImage || headerImage.value;
                        itineraryData.value = parsed.itinerary || itineraryData.value;
                        expenses.value = parsed.expenses || [];
                        strategyList.value = parsed.strategyList || [];
                        infoForms.value = parsed.infoForms || infoForms.value;
                        checklist.value = parsed.checklist || checklist.value;
                        exchange.value.rate = parsed.exchangeRate || 0.20;
                        hotelList.value = parsed.hotelList || [];

                        // 資料結構遷移：確保行程有新的欄位
                        for (const day in itineraryData.value) {
                            itineraryData.value[day] = itineraryData.value[day].map(item => ({
                                transportType: 'walk',
                                time: '', expectedMinutes: null, location: '',
                                ...item,
                            }));
                        }

                        // 確保攻略有新欄位
                        strategyList.value = strategyList.value.map(item => ({ mapLink: '', rating: 3, location: '', ...item }));
                    }
                });

                watch(checklist, () => saveToLocal(), { deep: true });
                watch(hotelList, () => saveToLocal(), { deep: true });
                watch(strategyList, saveToLocal, { deep: true });
                watch(() => exchange.value.rate, saveToLocal);


                return {
                    currentTab, tabs, headerImage, uploadHeader, weatherIframeSrc,
                    tripDays, currentDayIndex, currentDayItinerary, groupedItinerary, uniqueLocations, getIndexOfItem, isNotLastItemInGroup, itineraryLocationFilter,
                    itineraryData, showModal, form, isEditMode,
                    saveItinerary, deleteItem, editItem, openModal, closeModal, openMap, handleItineraryImage,
                    getCategoryColor, getCategoryLabel, getTransportIcon,
                    exchange, currentInput, calculateResult, clearInput, deleteDigit, appendDigit, appendDecimal, toggleSign, swapCurrencies,
                    expenses, totalExpense, openExpenseModal, expenseForm, saveExpense, getExpenseIcon, editExpense, deleteExpenseItem, isExpenseEditMode,
                    strategyList, openStrategyModal, strategyForm, saveStrategy, editStrategy, removeStrategy, deleteStrategyItem, isStrategyEditMode, strategyCategories,
                    strategyFilter, filteredStrategyList, uniqueStrategyLocations, strategyLocationFilter,
                    infoEditMode, checklist, newChecklistItem, addChecklistItem, removeChecklistItem,
                    infoEditTarget, infoEditTargetLabel, openInfoEditModal, infoForms, saveInfoEdit,
                    hotelList, hotelForm, openHotelModal, saveHotel, deleteHotel, isHotelEditMode, editingHotelIndex
                };
            }
        }).mount('#app');
    </script>
</body>

</html>